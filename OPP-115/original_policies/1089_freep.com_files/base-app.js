define(["jquery","underscore","baseview","state","managers/trafficcop","site-manager","utils","pubsub","managers/resourcemanager","managers/routemanager"],function(e,t,i,n,s,a,r,o,h,u){"use strict";var f=i.extend({currentPath:"",initialize:function(t){this._animId=0,this._fixedOffset=null,this.$top=r.get("scrollEl"),this.appRevealed=!1,this.pubSub=e.extend({"header:fixed":this._onHeaderFixed,"header:unfixed":this._onHeaderUnfixed},this.pubSub),i.prototype.initialize.call(this,t)},isRevealed:function(){return this.appRevealed},revealApp:function(e,t,i,n,s){var a=this._buildRequestInfo(e,t,n,s);return i?"rejected"===i.state()?i:this._handleAsyncReveal(i,a):this._handleInitialReveal(a)},_buildRequestInfo:function(t,i,n,s){return{fromUrl:t,toUrl:i,animId:++this._animId,resourcePromise:n||e.Deferred().resolve(),modulePromise:e.Deferred(),paused:s}},_handleInitialReveal:function(i){var n=e(".site-header").next();n.length||(n=r.get("body")),this.setElement(n);var s=this._setPageInfo(n,i);return this._isCorrectApp(s.jsUrl).then(t.bind(function(){return this._triggerAfterPageReveal(i)},this))},_handleAsyncReveal:function(i,n){var s;return"resolved"===i.state()?i.then(t.bind(function(e){return this._triggerBeforePageReveal(e,n).then(t.bind(function(){return this._updateState(n),this._revealAppMarkup(e,n).then(t.bind(function(){return this._finishReveal(e,n)},this))},this))},this)):(s=this.getRevealAppLoader(n.toUrl),s instanceof e||(s=e(s)),this._revealAppMarkup(s,n).then(t.bind(function(){return i.then(t.bind(function(e){return this._triggerBeforePageReveal(e,n).then(t.bind(function(){return this._updateState(n),this._handleRevealLoaderContentSwap(e,n).then(t.bind(function(){return this.setElement(e,!1),this._finishReveal(e,n)},this))},this))},this))},this)))},_updateState:function(e){e.paused||n.updateState()},_revealAppMarkup:function(t,i){this._insertAppMarkup(t,i.paused);var n=this._safeCall("animateRevealApp",i.fromUrl,i.toUrl,i.paused);return n?s.addAnimation(n):e.Deferred().resolve()},_handleRevealLoaderContentSwap:function(t,i){return i.animId!==this._animId?e.Deferred().reject():this.swapContent(this.$el,t,i.paused,this.getHash(i.toUrl))},_finishReveal:function(t,i){return i.animId!==this._animId?e.Deferred().reject():(i.paused&&this.setFixedPosition(this.$el.offset().top),this._triggerAfterPageReveal(i))},_fetchPageModules:function(e,t){t.paused?t.modulePromise.resolve():t.resourcePromise.done(function(){h.fetchPageModules(e.js_modules).done(t.modulePromise.resolve)})},_insertAppMarkup:function(t,i){var n=e(".site-header");t.hide(),this.setElement(t,!1),this.$el.insertAfter(n),i&&this.setFixedPosition(n.outerHeight())},changePage:function(e,t,i,n,s){var a=this._buildRequestInfo(e,t,n,s);return this.destroyModules(),i?this._handleChangePageRequest(i,a):this._handleChangePageNoRequest(a)},_handleChangePageNoRequest:function(e){return this._fetchPageModules(this.pageInfo,e),this._triggerAfterPageReveal(e)},_handleChangePageRequest:function(i,s){var a=this.animateChangePagePreData(s.fromUrl,s.toUrl);return a||this._triggerGenericLoader(i),i=i.then(t.bind(function(e){return this._triggerBeforePageReveal(e,s).then(function(){return e})},this)),e.when(i,a).then(t.bind(function(e){return s.paused||n.updateState(),this._finishChangePage(e,s)},this))},_triggerGenericLoader:function(e){"pending"===e.state()&&(this.activateLoader(),e.always(t.bind(function(){this.deactivateLoader()},this)))},_finishChangePage:function(i,n){if(n.animId!==this._animId)return e.Deferred().reject();var s=this.animateChangePagePostData(n.fromUrl,n.toUrl,i,n.paused)||e.Deferred().resolve();return n.paused&&this.setFixedPosition(this.$el.offset().top),s.then(t.bind(function(){return this._triggerAfterPageReveal(n)},this))},swapContent:function(t,i,n,s){return this.isSafari5||this.isApple||n?(i.insertAfter(t),t.remove(),e.Deferred().resolve()):this._crossFade(t,i,s)},_crossFade:function(e,t,i){var n=parseInt(e.css("top"),10)||0;return n-=r.getScrollPosition(),t.css({"z-index":100}),e.css({position:"absolute","z-index":101,opacity:1,top:n}),t.insertAfter(e),i&&this._scrollToHashTag(t,i)||a.scrollTop(0),this.animate(e,"opacity",0,this.options.animations.fadeIn.duration).always(function(){t.css({"z-index":""}),e.remove()})},_scrollToHashTag:function(e,t){var i=this._getOffset(e,t);return i.top?(this.$top.scrollTop(i.top-this.$el.offset().top),!0):void 0},_getOffset:function(e,t){try{return e.find("a[name="+t+"]").offset()||{}}catch(i){console.warn("Invalid hashtag",t)}return{}},pause:function(){this.destroyModules(!1,!0)},getHash:function(e){var t=e.indexOf("#");return-1!==t?e.substring(t+1):null},_triggerAfterPageReveal:function(i){return e.when(i.resourcePromise,i.modulePromise).done(t.bind(function(e,t){i.animId===this._animId&&(i.paused||this._initPage(null!==i.fromUrl,e,t),this._safeCall("afterPageReveal",i.fromUrl,i.toUrl,i.paused,e&&e[0]),this.appRevealed=!0,this.currentPath=i.toUrl,i.paused||this.trackPageLoad(this.pageInfo))},this))},_safeCall:function(e){try{return this[e].apply(this,Array.prototype.slice.call(arguments,1))}catch(t){console.error("View threw an exception on "+e,t.stack||t.stacktrace||t.message)}},_initPage:function(e,t,i){e&&(this.delegateEvents(),this._updatePageTitle()),this._initModules(t&&t.length>1?t[1].concat(i||[]):i)},_triggerBeforePageReveal:function(e,t){this._safeCall("beforePageReveal",t.fromUrl,t.toUrl,e,t.paused);var i=this._setPageInfo(e,t);return this._isCorrectApp(i.jsUrl)},_isCorrectApp:function(t){var i=this;return e.Deferred(function(e){if(t){var n=u.getInfo(t);if(n&&n.app.AppClass.prototype!==Object.getPrototypeOf(i))return void e.reject("InvalidApp",n)}e.resolve()})},_setPageInfo:function(e,t){var i=this.pageInfo=this._safeCall("parsePageInfo",e)||{};return this._verifyPageInfo(i),this._fetchPageModules(i,t),i},_verifyPageInfo:function(e){e.templatetype=e.templatetype||"",e.ssts=e.ssts||"bugpages",e.cst=e.aws||e.cst||"undefined"},_updatePageTitle:function(){if("None"===(this.pageInfo.seotitle||"None")){var e=r.getNested(window.site_vars,"display_name");e&&(document.title=e)}else document.title=this.pageInfo.seotitle},removeApp:function(e,i){return this._animId++,this._safeCall("beforeAppRemove",e,i),this.destroyModules(!1),this._triggerAnimateRemoveApp(e,i).always(t.bind(function(){this._safeCall("afterAppRemove",e,i),this._safeDestroy()},this))},_triggerAnimateRemoveApp:function(t,i){var n=this._safeCall("animateRemoveApp",t,i);return n?s.addAnimation(n):e.Deferred().resolve()},_safeDestroy:function(){try{this.destroy(!0)}catch(e){console.error("View threw an exception on destroy: ",e.stack||e.stacktrace||e.message),this.$el.remove()}},getWindowOffset:function(){return this.el?this.el.getBoundingClientRect():{top:0,left:0}},animateRevealApp:function(t,i,n){return this.isApple&&n?e.Deferred().resolve():this.show(!0)},animateRemoveApp:function(){return this.hide(!0)},animateChangePagePreData:function(){return null},animateChangePagePostData:function(e,t,i,n){var s=this.swapContent(this.$el,i,n,this.getHash(t));return this.setElement(i,!1),s},setFixedPosition:function(e,t){t||!this.isSafari5&&!this.isApple?(this._header=a.getHeader(),this._header?this._header.isFixed()?(this._fixedOffset=this._header.isOpen()?e-this._header.getFixedThreshold():e,this.$el.css({position:"fixed",top:e})):(this._fixedOffset=e=this.$el.offset().top,this.$el.css({position:"absolute",top:e})):this._fixedOffset=e):this.$el.hide()},clearFixedPosition:function(e){this._fixedOffset=null,e||!this.isSafari5&&!this.isApple?this.$el.css({position:"",top:""}):this.$el.show()},_onHeaderFixed:function(){this._header&&null!==this._fixedOffset&&(this._fixedOffset-=this._header.getFixedThreshold(),this.$el.css({position:"fixed",top:this._fixedOffset}))},_onHeaderUnfixed:function(){this._header&&null!==this._fixedOffset&&(this._fixedOffset+=this._header.getFixedThreshold(),this.$el.css({position:"absolute",top:this._fixedOffset}))},activateLoader:function(){},deactivateLoader:function(){},beforeAppRemove:function(){},afterAppRemove:function(){},beforePageReveal:function(){},afterPageReveal:function(e,t,i,n){n&&(this.subviews.page=new n({el:this.$el}))},getRevealAppLoader:function(){return'<section class="ui-loading dark-medium ui-app-loader"></section>'},beforeOverlayRemove:function(){},afterOverlayReveal:function(){},getClientAdInfo:function(){return{}},parsePageInfo:function(e){return JSON.parse(e.find(".pageinfo").eq(0).html())||{}},getClientInfo:function(){return{}},trackPageLoad:function(e){t.defer(function(){s.getAnimationCompletion().done(function(){o.trigger("page:load",e)})})},buildModules:function(e){return h.fetchPageModules(e).done(t.bind(this._initModules,this))},_initModules:function(e){this.destroyed||t.each(e,this._initModule,this)},_initModule:function(i){var n=i.selector,s=this.seenModules[i.name]||0;i.position&&(n="#module-position-"+i.position+n+",#module-position-"+i.position+" "+n),this.$(n).each(t.bind(function(t,n){var a=e.extend(!0,{},i.options);a.el=n,a.layoutType=i.layoutType;try{this.subviews[i.name+s]=new i.ModuleClass(a)}catch(r){console.error("failed loading module "+i.name,r.stack||r.stacktrace||r.message)}s+=1},this)),this.seenModules[i.name]=s}});return f});
//# sourceMappingURL=base-app.js
//# sourceMappingURL=base-app.js.map