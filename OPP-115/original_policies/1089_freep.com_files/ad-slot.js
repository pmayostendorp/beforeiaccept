define(["jquery","underscore","baseview","state","utils","user-manager","pubsub","adLogger"],function(t,o,e,i,n,s,a,l){"use strict";var g=e.extend({className:"ad-slot",id:function(){return o.uniqueId("ad-slot-"+this.options.adUnit.replace(/\//g,"-")+"-")},events:{partnersetup:"onHighImpactAdLoad",partnerloading:"onPartnerLoading"},pageLoaded:!1,initialized:!1,queue:[],pageUnLoad:function(){g.prototype.pageLoaded=!1},pageLoad:function(){g.prototype.queue.length&&g.prototype._requestSlots(g.prototype.queue),g.prototype.queue=[],g.prototype.pageLoaded=!0},initialize:function(o){return o=t.extend({adUnit:null,targeting:{},sizes:[],type:"in",onSlotRequest:null,onSlotRender:null,onSlotEmpty:null,position:null},o),!g.prototype.initialized&&window.googletag&&(g.prototype.initialized=!0,googletag.cmd.push(function(){googletag.pubads().addEventListener("slotRenderEnded",g.prototype._renderEnded)})),this.$el.length&&o.position&&o.position.length&&o.position.parents("body").length?(o.position.append(this.$el),this.gptSlot=null,this.slotId=this.$el.prop("id"),this.adDeliveryData=null,e.prototype.initialize.call(this,o),void this._buildGptSlot()):void l.logError("AdSlot("+this.options.adUnit+"): Unable to request ad because no valid dom element provided")},_buildGptSlot:function(){return i.getActivePageInfo().noadvertising?void l.logInfo("AdSlot("+this.options.adUnit+"): blocked because of noadvertising flag in pageinfo"):void("in"===this.options.type?this._registerSlotWithGoogle(this.options.adUnit,this.options.sizes,this.slotId):this._registerOutOfPageSlotWithGoogle(this.options.adUnit,this.slotId))},destroy:function(){this.gptSlot&&(this.gptSlot.__gannettSlot=null),this.destroyed=!0,this.gptSlot=null,e.prototype.destroy.call(this,!0)},refresh:function(){this.destroyed||(this.adLoading=!1,this.adData=null,this.$el.closest("body").length||this.options.position.append(this.$el),this.delegateEvents(),this.gptSlot?window.googletag&&!i.getActivePageInfo().noadvertising&&(this._refreshSlot(this.gptSlot),l.logInfo("AdSlot("+this.options.adUnit+"): Ad refreshed for slot",this.gptSlot)):this._buildGptSlot())},onPartnerLoading:function(){this.adLoading=!0},onHighImpactAdLoad:function(t,o){var e=null;if(o&&o.data)e=o.data;else{if(!t.originalEvent||!t.originalEvent.data)return void l.logError("AdSlot("+this.options.adUnit+"): Found a high impact ad, can't find the data object from the iFrame",arguments);e=t.originalEvent.data}if(!e||!e.adType)return void l.logError("AdSlot("+this.options.adUnit+"): high impact event received, but invalid data object was given",e);this.adData=e;var i=this._normalizeAdType(e.adType);this.options.onSlotRender(e,i)},_normalizeAdType:function(t){return t?t.toLowerCase().replace(/[^a-z]/,""):null},_registerOutOfPageSlotWithGoogle:function(t,e){window.googletag&&googletag.cmd.push(o.bind(function(){l.logInfo("AdSlot("+this.options.adUnit+"): registering out of page slot with google "+t),this.gptSlot=googletag.defineOutOfPageSlot(t,e).addService(googletag.pubads()),this.gptSlot.__gannettSlot=this,googletag.display(e),this._refreshSlot(this.gptSlot)},this))},_refreshSlot:function(t){this.setTargeting(this.options.targeting),this.pageLoaded?this._requestSlots([t]):this.queue.push(t)},_requestSlots:function(t){googletag.pubads().refresh(t),o.each(t,function(t){t.__gannettSlot.options.onSlotRequest()})},_registerSlotWithGoogle:function(t,e,i){window.googletag&&googletag.cmd.push(o.bind(function(){l.logGroup("AdSlot "+this.options.adUnit),l.logInfo("registering slot with google "+t+" sizes",e),this.gptSlot=googletag.defineSlot(t,e,i).addService(googletag.pubads()),this.gptSlot.__gannettSlot=this,googletag.display(i),this._refreshSlot(this.gptSlot),l.logGroupEnd()},this))},_renderEnded:function(t){t.slot.__gannettSlot&&o.defer(o.bind(function(){!this.gptSlot||this.adData||this.adLoading||(t.isEmpty||t.size[0]<10||t.size[1]<10?(l.logInfo("AdSlot("+this.options.adUnit+"): No Ad Delivered"),this.options.onSlotEmpty&&this.options.onSlotEmpty()):this.options.onSlotRender())},t.slot.__gannettSlot))},setTargeting:function(t){this.gptSlot&&(this.options.targeting=t,this._setTargeting(this.gptSlot,t))},_setTargeting:function(t,e){t.clearTargeting(),o.each(e,function(o,e){(o||0===o||o===!1)&&(t.setTargeting(e,o),l.logInfo("set targetting - key:"+e+" value:"+o))},this)}});return g});
//# sourceMappingURL=ad-slot.js
//# sourceMappingURL=ad-slot.js.map