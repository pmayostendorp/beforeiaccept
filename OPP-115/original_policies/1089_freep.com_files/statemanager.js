define(["jquery","underscore","pubsub","utils","modules/global/alert","managers/trafficcop","managers/requestmanager","managers/resourcemanager","managers/siteconfig"],function(e,t,i,n,r,a,o,p,s){"use strict";Object.getPrototypeOf||(Object.getPrototypeOf=function(e){return e.constructor.prototype});var l=function(){this.scrollEl=n.get("scrollEl"),this.body=n.get("body"),this.initialize()};return l.prototype={DEBUG:!0,LAYER_OVERLAY:"overlay",LAYER_PRELOAD:"preload",LAYER_BASE:"base",REFRESH_FREQUENCY:60*(n.getNested(window.site_vars,"REFRESH_RATE")||0)*1e3,start:function(e){var t=s.getSiteConfig();this.started=!0,this.header=e,this.pubSub={"page:unload":this.updateActivityTimestamp,"page:load":this.updateActivityTimestamp,"video:load":this.updateActivityTimestamp,"slide:change":this.updateActivityTimestamp,heattrack:this.updateActivityTimestamp,vitrack:this.updateActivityTimestamp,uotrack:this.updateActivityTimestamp},i.attach(this.pubSub,this),this._setupGlobalPubSub(n.getNested(t,"global","pubSub")),this.startRefreshTimer()},stop:function(){this.started=!1,this._currentViewport="width=1070",i.unattach(this.pubSub,this),t.each(n.getNested(this.siteConfig,"global","pubSub"),function(e,t){i.off(t)})},_setupGlobalPubSub:function(e){t.each(e,function(e,n){e instanceof Array||(e=[e]),require(e,t.bind(function(){var e=arguments;this.started&&i.on(n,function(i){t.each(e,function(e){new e(i)})})},this))},this)},initialize:function(){this.$overlayFilm=e("#overlay-film"),this.activeAppInfo={url:null,css:[],layer:null,scrollTop:0,appConfig:null,pageConfig:null,app:null},this.lastUrl=null,this._clearPreloadedAppInfo(),this.fullscreenView=null},_clearPreloadedAppInfo:function(){this.preloadedAppInfo={url:null,css:[],scrollTop:0,appConfig:null,pageConfig:null,layer:this.LAYER_PRELOAD,app:null}},onRouteChange:function(e,t){return console.log("App: "+e.page.appName+"/"+e.page.name),this.activeAppInfo.app&&i.trigger("page:unload"),this._loadRoute(e,t)},_loadRoute:function(e,t,i){var n={preloadedUrl:e.page.preloadedUrl||e.app.preloadedUrl};return this._loadApp(e.app.AppClass,n,t,e.app,e.page,i)},_preloadRoute:function(e,t,i){return this._preloadApp(e.app.AppClass,{},t,e.app,e.page,i)},preloadPath:function(t){this.DEBUG&&console.log("Router: Preloading: ",t);var i=s.getRouteInfo(t);return!i||window.chromeless||this.activeAppInfo.layer&&this.activeAppInfo.layer!==this.LAYER_OVERLAY?e.Deferred().reject():this._preloadRoute(i,t)},_loadPath:function(t){var i=s.getRouteInfo(t);return i?this.onRouteChange(i,t):(console.error("StateManager: tried navigating to path, but no match found: "+t),e.Deferred().reject())},refreshActiveApp:function(){var e=this.activeAppInfo.url,t=s.getRouteInfo(e).page,n=p.fetchJavascript(t.buildfile&&t.buildfile.path,t.path,t.modules),r=this._fetchPathHtml(e);return i.trigger("page:unload"),this._changePage(this.activeAppInfo,e,e,r,n)},setIntentUrl:function(e){this.activeAppInfo.intentUrl=e,this.activeAppInfo.app&&this.activeAppInfo.app.destroyModules()},getIntentUrl:function(){return this.activeAppInfo.intentUrl},getPreloadedUrl:function(){return this.preloadedAppInfo.url},registerFullScreenView:function(e){this._setFixedPosition(this.activeAppInfo,this.activeAppInfo.app,!0),this.fullscreenView=e,this.activeAppInfo.app.pause()},setActiveAppFixed:function(e){this._setFixedPosition(this.activeAppInfo,this.activeAppInfo.app,e)},clearFullScreenView:function(){return this._clearFixedPosition(this.activeAppInfo,this.activeAppInfo.app,!0),this.fullscreenView?(this.fullscreenView=null,this._loadPath(this.activeAppInfo.url)):void 0},clearActiveAppFixed:function(e){this._clearFixedPosition(this.activeAppInfo,this.activeAppInfo.app,e)},_loadApp:function(e,i,n,r,a,o){var s,l=r.overlay?this.LAYER_OVERLAY:this.LAYER_BASE,c=p.fetchJavascript(a.buildfile&&a.buildfile.path,a.path,a.modules);return this._closeFullscreenView(),this.lastUrl=this.activeAppInfo.url,this.activeAppInfo.app&&(this.activeAppInfo.intentUrl&&this.activeAppInfo.intentUrl!==n&&(this.activeAppInfo.url=this.activeAppInfo.intentUrl),this.activeAppInfo.intentUrl=null),s=this._handleTransition(n,this.activeAppInfo,e,i,l,o,c),this.activeAppInfo.css=a.css||[],this.activeAppInfo.url=n,this.activeAppInfo.layer=l,this.activeAppInfo.pageConfig=a,this.activeAppInfo.appConfig=r,p.fetchStyles(t.union(this.preloadedAppInfo.css,this.activeAppInfo.css),s),s},_preloadApp:function(e,i,n,r,a,o){var s=this._handleTransition(n,this.preloadedAppInfo,e,i,this.LAYER_PRELOAD,o);return this.preloadedAppInfo.css=a.css||[],this.preloadedAppInfo.url=n,this.preloadedAppInfo.pageConfig=a,this.preloadedAppInfo.appConfig=r,p.fetchStyles(t.union(this.preloadedAppInfo.css,this.activeAppInfo.css),s),s},_closeFullscreenView:function(){if(this.fullscreenView){var e=this.fullscreenView;this.fullscreenView=null,e.close()}},_handleTransition:function(e,t,i,n,r,a,o){var p,s=t.url;return this._needsNewApp(i,t)?(p=new i(n),a=a||this._requestPageHtml(s,e,t===this.preloadedAppInfo),t.app?this._changeApps(t,r,p,s,e,a,o):this._revealApp(t,p,s,e,a,o)):t.layer===r?(a=this._requestPageHtml(s,e,t===this.preloadedAppInfo),this._changePage(t,s,e,a,o)):this._transitionFromOverlayToPreloadedApp(s,e,o)},_changeApps:function(i,n,r,a,o,p,s){return i.layer===n?i.app.removeApp(a,o).then(t.bind(function(){return this._revealApp(i,r,a,o,p,s)},this)):n===this.LAYER_OVERLAY?this._revealOverlay(r,a,o,p,s):e.when(this._removePreloadedApp(a,o),this._removeOverlay(i.app,a,o)).then(t.bind(function(){return this._revealApp(i,r,a,o,p,s)},this))},updateState:function(){var t=this.activeAppInfo;if(t.appConfig&&t.pageConfig){this.header&&this._setHeader(this.header,e.extend({},t.appConfig.header,t.pageConfig.header));var i=t.appConfig.viewport||t.pageConfig.viewport||"width=1070";this._currentViewport!==i&&(this._currentViewport=i,e("meta[name=viewport]").attr("content",i))}},_setHeader:function(e,i){t.isEmpty(i)?e.restoreDefaultState():i.fixed?i.open?e.setOpenFixed():e.setClosedFixed():e.setFixingScroller(!0)},_changePage:function(e,i,n,r,a){return e.app.changePage(i,n,r,a,e===this.preloadedAppInfo).then(null,t.bind(function(t,a){return"InvalidApp"===t&&a?this._invalidateApp(e,a,i,n,r):void 0},this))},_rerouteInitialPageLoad:function(i,n,r){return e.Deferred(function(e){t.defer(function(){i.app=null,i.url=null,e.resolve()})}).then(t.bind(function(){return this._loadRoute(r,n)},this))},_removePreloadedApp:function(e,t){var i=this.preloadedAppInfo.app;return i?(this._clearPreloadedAppInfo(),i.beforeOverlayRemove(t),i.removeApp(e,t)):void 0},_revealApp:function(e,i,n,r,a,o){return e.app=i,i.revealApp(n,r,a,o,e===this.preloadedAppInfo).then(null,t.bind(function(t,i){return"InvalidApp"===t&&i?this._invalidateApp(e,i,n,r,a):void 0},this))},_invalidateApp:function(e,t,i,n,r){try{e.app.destroy()}catch(a){console.error("View threw an exception on destroy: ",a.stack||a.stacktrace||a.message)}return console.log("Rerouting: "+t.page.appName+"/"+t.page.name),r?(e.url=i,e===this.activeAppInfo?this._loadRoute(t,n,r):this._preloadRoute(t,n,r)):this._rerouteInitialPageLoad(e,n,t)},_needsNewApp:function(e,t){return!(t.app&&t.app.isRevealed()&&(Object.getPrototypeOf(t.app)===e.prototype||this.preloadedAppInfo.app&&Object.getPrototypeOf(this.preloadedAppInfo.app)===e.prototype&&this.preloadedAppInfo.app.isRevealed()))},_requestPageHtml:function(e,t,i){if(null!==e||i){if(e!==t)return this._fetchPathHtml(t,i);i||o.abortAllRequests()}return null},_transitionFromOverlayToPreloadedApp:function(e,i,n){var r=this.preloadedAppInfo,a=this._requestPageHtml(r.url,i,!1),o=this.activeAppInfo.app;return this._movePreloadAppToActiveApp(this.LAYER_BASE),r.app.beforeOverlayRemove(i),this._removeOverlay(o,e,i).then(t.bind(function(){return this.updateState(),this._transitionFromOverlayScroll(r),this._changePage(r,e,i,a,n)},this))},_removeOverlay:function(t,i,n){return e.when(t.removeApp(i,n),this._fadeOutOverlayFilm(t))},_movePreloadAppToActiveApp:function(t){e.extend(this.activeAppInfo,this.preloadedAppInfo),this.activeAppInfo.layer=t,this._clearPreloadedAppInfo()},_deactivateActiveApp:function(){this.activeAppInfo.app.pause(),e.extend(this.preloadedAppInfo,this.activeAppInfo)},_revealOverlay:function(n,r,a,o,p){var s=this.activeAppInfo.app;s.isRevealed()?this._deactivateActiveApp():(s.removeApp(r,a),s=null),this.body.css("overflow-y","scroll"),this._transitionToOverlayScroll(this.preloadedAppInfo);var l=e.when(this._fadeInOverlayFilm(n),this._revealApp(this.activeAppInfo,n,r,a,o,p));return i.trigger("scrollTop",0),l.done(t.bind(function(){this.body.css("overflow-y",""),s&&!s.destroyed&&s.afterOverlayReveal(this.preloadedAppInfo.scrollTop)},this)),l},_fadeInOverlayFilm:function(t){var i=t.options.animations.fadeIn;return this.$overlayFilm.length||(this.$overlayFilm=e('<div class="ui-film"></div>'),this.body.append(this.$overlayFilm)),t.animate(this.$overlayFilm,"opacity",.7,i.duration,"ease-in")},_fadeOutOverlayFilm:function(t){var i=this.$overlayFilm,n=t.options.animations.fadeOut;return this.$overlayFilm=e([]),t.animate(i,"opacity",0,n.duration,"ease-out").done(function(){i.remove()})},_fetchPathHtml:function(e,i){var a=this.fetchHtml(e,null,!i);return i||a.fail(t.bind(function(e){if(e)if("NOT AUTHORIZED"===e)window.location.assign(n.getNested(window,"firefly_urls","samSubscribeURL")||"");else{var t=this.generateRequestError(e);t&&r.showError(t),(200!==e.status&&e.status||"timeout"===e.statusText)&&window.history.back()}},this)),a},generateRequestError:function(e){if(e){if(500===e.status)return"Connection Error... (INTERNAL SERVER ERROR)";if(404===e.status)return"Connection Error... (FILE NOT FOUND)";if(200!==e.status&&e.status)return"Connection Error... ("+(e.statusText||"Unknown Error")+")"}return null},_transitionFromOverlayScroll:function(e){var t=e.app;t&&(t.isApple?t.show():this._clearFixedPosition(e,t),t.$el.css("z-index",""))},_transitionToOverlayScroll:function(e){var t=e.app;t&&(t.isApple?t.hide():this._setFixedPosition(e,t),t.$el.css("z-index","0"))},_clearFixedPosition:function(e,t,n){t.clearFixedPosition(n),i.trigger("scrollTop",e.scrollTop||0)},_setFixedPosition:function(e,t,r){var a=t.getWindowOffset().top;e.scrollTop=n.getScrollPosition(),i.trigger("scrollTop",0),t.setFixedPosition(a,r)},updateActivityTimestamp:function(){this.lastActivityTimestamp=(new Date).getTime()},getActivePageInfo:function(){return this.activeAppInfo.app&&this.activeAppInfo.app.pageInfo||{}},getActiveAppClientInfo:function(){return this.activeAppInfo.app&&this.activeAppInfo.app.getClientInfo()||{}},getPreloadedPageInfo:function(){return this.preloadedAppInfo.app&&this.preloadedAppInfo.app.pageInfo||{}},getActiveApp:function(){return this.activeAppInfo.app},getPreloadedApp:function(){return this.preloadedAppInfo.app},getReferrer:function(){return null===this.lastUrl?document.referrer:n.getOrigin()+this.lastUrl},getCurrentUrl:function(){return n.getOrigin()+this.activeAppInfo.url},startRefreshTimer:function(){!this.refreshTimer&&this.REFRESH_FREQUENCY&&(this.lastActivityTimestamp=0,this.refreshTimer=setInterval(t.bind(function(){if(!this.fullscreenView&&this.activeAppInfo.layer!==this.LAYER_OVERLAY){var e=(new Date).getTime(),t=e-this.lastActivityTimestamp;t>this.REFRESH_FREQUENCY&&(i.trigger("site:refresh","refresh:"+(this.getActivePageInfo().ssts||"").replace(/[\/:].*/,"")),window.location=window.location)}},this),6e4))},stopRefreshTimer:function(){this.refreshTimer&&(clearInterval(this.refreshTimer),this.refreshTimer=null)},registerAnimation:function(e,t,i,n,r){return a.addAnimation(e,t,i,n,r)},fetchHtml:function(e,t,i,n){return o.fetchHtml(e,t,i,n,!0)},fetchData:function(e,t,i,n,r){return o.fetchData(e,t,i,n,r)},recurringFetchHtml:function(e,t,i,n,r){return o.recurringFetchHtml(e,t,i,n,r,!0)},recurringFetchData:function(e,t,i,n,r,a){return o.recurringFetchData(e,t,i,n,r,a)}},window.stateManager=new l,window.stateManager});
//# sourceMappingURL=statemanager.js
//# sourceMappingURL=statemanager.js.map