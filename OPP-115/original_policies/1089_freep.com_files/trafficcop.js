define(["jquery","underscore"],function(t,e){var i=function(){this.DEBUG=!0,this.defaultTimeout=2e3,this.minTimeout=500,this.activeRequests=[],this.activeAnimations=[],this.animationCompletion=null};return i.prototype={addRequest:function(i){var n={ajaxPromise:i,gate:t.Deferred(),result:null};this.activeRequests.push(n),i.always(e.bind(function(t){this.activeAnimations.length?n.result=t:("resolved"===i.state()?n.gate.resolve(t):n.gate.reject(t),this._cleanup())},this));var o=n.gate.promise();return o.original=i,o.abort=i.abort,o},addAnimation:function(i,n,o,a,s){if(!i||"pending"!==i.state())return i;this.animationCompletion||(this.animationCompletion=t.Deferred());var r=Math.max(2*s,this.minTimeout)||this.defaultTimeout,u=setTimeout(e.bind(function(){console.warn("ANIMATION did NOT resolve within "+r+" ms, releasing barrier "+this._getAnimationPropertyDescription(o,a),n),this._resolveAnimation(i)},this),r);return this.activeAnimations.push(i),i.always(e.bind(function(){clearTimeout(u),this._resolveAnimation(i)||console.warn("animation finished after being released "+this._getAnimationPropertyDescription(o,a),n)},this)),this.animationCompletion.promise()},getAnimationCompletion:function(){return this.animationCompletion?this.animationCompletion.promise():t.Deferred().resolve()},_getAnimationPropertyDescription:function(t,e){return t?"on property "+t+":"+e:"on unregistered element"},_resolveAnimation:function(e){var i=t.inArray(e,this.activeAnimations);return-1!==i?(this.activeAnimations.splice(i,1),0===this.activeAnimations.length&&this._openGate(),!0):!1},_openGate:function(){var t=this.animationCompletion;this.animationCompletion=null,e.each(this.activeRequests,function(t){var e=t.ajaxPromise.state();"resolved"===e?t.gate.resolve(t.result):"rejected"===e&&t.gate.reject(t.result)}),this._cleanup(),t.resolve()},_cleanup:function(){this.activeRequests=e.reject(this.activeRequests,function(t){return"pending"!==t.gate.state()})}},new i});
//# sourceMappingURL=trafficcop.js
//# sourceMappingURL=trafficcop.js.map