define(["jquery","underscore","baseview","utils","admanager","managers/cachemanager","pubsub","partner/iab","adLogger"],function(t,e,i,a,s,d,n,o,h){"use strict";var r=i.extend({$head:t("head"),initialize:function(a){a=t.extend({adSizes:[],adPlacement:null,subSection:null,slotType:"in",adWidth:null,adHeight:null,onAdReady:null,onNoAd:null,beforeAdRender:null},a),this._debounceAdReady=e.debounce(this._adReady,30),this.$el.prop("id")||this.$el.prop("id",e.uniqueId("ad-position-")),i.prototype.initialize.call(this,a),this.tracked=!1,this.adState="pending",this.$el.css({width:"",height:"",display:""});var s=this.$el.closest(".partner-placement");s.attr("data-monetization-id",this.options.adPlacement.replace(/\/.*/,"")),s.attr("data-monetization-sizes",this.options.adSizes.join(","))},render:function(t,e){this.options.beforeAdRender&&this.options.beforeAdRender(t,e),e||t?this._renderHighImpact(t,e):this._adReady()},_renderHighImpact:function(t,e){this.adType=e,this.adData=t,h.logDebug("AdPosition HighImpact Ad recieved with type: "+e,t),"risingstar"===e||"generic"===e?this._renderHighImpactIAB(t):this._renderCustomAd(t)},_renderHighImpactIAB:function(t){var i=this.subviews.partnerView=new o({el:this.$el});i.render(t).done(e.bind(function(){this.destroyed||this._adReady()},this))},noAd:function(){this.adState="noad",this.options.onNoAd&&this.options.onNoAd()},getAdState:function(){return this.adState},_renderCustomAd:function(i){return i.dfp&&i.dfp.ecid?(i.html&&(this.$adEl=t(t.parseHTML(i.html,document,!0)),this.$el.append(this.$adEl)),i.stylesheet&&(this.$stylesheet=t('<link rel="stylesheet" data-ad-stylesheet="'+i.dfp.ecid+'" href="'+i.stylesheet+'">'),this.$head.append(this.$stylesheet)),void(i.script?(i.el=this.$el,a.requireSingleUseScript(i.script).done(e.bind(function(t){var e=this._getPubSubKey();if(!this.destroyed){i.initialWidth=this.options.adWidth,i.initialHeight=this.options.adHeight,n.on(e,this._debounceAdReady,this);try{this.subviews.partnerView=new t(i)}catch(a){h.logError("AdSlot("+this.options.adUnit+"): ad delivered threw exception on creation",a.stack||a.stacktrace||a.message)}}},this))):this._adReady())):void h.logError("invalid ad returned, no dfp/ecid found",i)},_getPubSubKey:function(){return"partner:"+this.adData.dfp.ecid+":ready"},destroy:function(t){"hasad"===this.adState&&this.$el.css({width:this.getWidth(),height:this.getHeight()}),this.destroyAdPlacement();var e=this.$el.closest(".partner-placement");e.removeAttr("data-monetization-id"),e.removeAttr("data-monetization-sizes"),this.destroyed=!0,i.prototype.destroy.call(this,t)},destroyAdPlacement:function(){if(this.tracked=!1,this.subviews.partnerView&&(this.stopAd(),this._dispatchToPartner("destroy",!1),this.subviews.partnerView=null),this.adData&&this.adData.script&&n.off(this._getPubSubKey(),this._debounceAdReady,this),this.adType=this.adData=null,this.$adEl)this.$adEl.remove(),this.$adEl=null;else if(this.$el.hasClass("partner-billboard-ad")){var e=a.getNested(window.site_vars,"ADS","cleanup_selectors");t(e).remove()}else this.$("iframe").remove(),this.$(".ad-slot > div").remove();this.$stylesheet&&(this.$stylesheet.remove(),this.$stylesheet=null)},getAdPlacement:function(){var t=this.options.adPlacement;return this.options.subSection&&(t+="/"+this.options.subSection),t},getAdSizes:function(){return this.options.adSizes},getSlotType:function(){return this.options.slotType},_adReady:function(){h.logDebug("AdPosition("+this.getAdPlacement()+") "+this.adType+" ready"),this.adData&&this.adData.script&&n.off(this._getPubSubKey(),this._debounceAdReady,this),this.adState="hasad",this.options.onAdReady?this.options.onAdReady(this.adData,this.adType):"in"===this.options.slotType&&(this.adType&&"risingstar"!==this.adType?this.playAd():(this.show(),this.$el&&this.$el.height()>1&&this.$el.addClass("partner-placement-visible")))},isAdReady:function(){var t="hasad"===this.adState;return t&&"blank"===a.getNested(this.adData,"adType")?(this.trackAd(),!1):t},getCreativeState:function(t,e){return this.adData&&this.adData.dfp&&this.adData.dfp.ecid?d.getValue("dfpc_"+this.adData.dfp.ecid,t,e):void h.logWarn("Attempted to get state on non high impact ad")},setCreativeState:function(t,e){this.adData&&this.adData.dfp&&this.adData.dfp.ecid?d.setValue("dfpc_"+this.adData.dfp.ecid,t,e):h.logWarn("Attempted to set state on non high impact ad")},getHeight:function(){return this.$el.outerHeight()},getWidth:function(){return this.$el.outerWidth()},showAd:function(t,e){this.$el.show(),this._dispatchToPartner("onShow",t,e),this.trackAd()},resizeAd:function(t,e){this.options.adWidth=t,this.options.adHeight=e,this._dispatchToPartner("onResize",t,e)},setInitialDimensions:function(t,e){this.options.adWidth=t,this.options.adHeight=e},_dispatchToPartner:function(t){var e,i=this.subviews.partnerView;if(i)if(i[t]){e=Array.prototype.slice.call(arguments,1),h.logDebug.apply(h,["AdPosition("+this.getAdPlacement()+") "+t].concat());try{i[t].apply(i,e)}catch(a){h.logError("Ad threw an exception in function "+t,a.stack||a.stacktrace||a.message)}}else h.logWarn("Ad does not implement "+t)},stopAd:function(){this._dispatchToPartner("onStopToClose"),s.updateActiveSlotStatistics(this.adType,"stopped")},pauseAd:function(){this._dispatchToPartner("onPause"),s.updateActiveSlotStatistics(this.adType,"paused")},resumeAd:function(){this._dispatchToPartner("onResume"),s.updateActiveSlotStatistics(this.adType,"playing")},trackAd:function(e){var i;if(!this.tracked&&this.adData){if(this.tracked=!0,this.adData.viewUrl){var a=t('<img src="'+this.adData.viewUrl+encodeURIComponent(window.site_static_url+"images/pixels/pixel-transparent.png")+'" style="display:none;">');this.$adEl?this.$adEl.append(a):(this.$adEl=a,this.$el.append(a)),h.logDebug("Fired Tracking Pixel",this.adData.viewUrl)}if("Yes"===this.adData.trackVCE&&this.adData.vCEUrl){e=e||this.$el,i=e.prop("id");var d=this.adData.vCEUrl.replace(/\[domid\]/g,i);s._createScript("vce_"+i,d,e),h.logDebug("Tracked vCE",d)}}},playAd:function(){this.trackAd(),this._dispatchToPartner("onPlay"),s.updateActiveSlotStatistics(this.adType,"playing")}});return r});
//# sourceMappingURL=ad-position.js
//# sourceMappingURL=ad-position.js.map