define(["jquery","underscore","utils","state","pubsub","cookie"],function(t,e,i,a,r){"use strict";var n=function(){this.pubSub={"page:unload":this._onPageUnLoad,"page:load":this._onPageLoad}};return n.prototype={cid:e.uniqueId("c"),start:function(){r.attach(this.pubSub,this),this.abTestGroup=this._readAbTestGroup()||this._initialGroupSetup()},stop:function(){r.unattach(this.pubSub,this),this._onPageUnLoad(),this.reset()},getVariantData:function(){return e.chain(this._getActiveTests()).map(function(t){return new RegExp(t.urlRegex).test(window.location.pathname)?this._getVariant(this.abTestGroup,t.trafficVolume,t.variants,t.trafficStartingOffset):void 0},this).compact().value()},_onPageLoad:function(){this._setupTestBuckets(this.abTestGroup,this._getActiveTests())},_onPageUnLoad:function(){i.get("body").off("."+this.cid)},reset:function(){window.localStorage.removeItem("wfm_abtestgroup")},_readAbTestGroup:function(){return JSON.parse(window.localStorage.getItem("wfm_abtestgroup"))},_initialGroupSetup:function(){var t=Math.floor(100*Math.random())+1;try{window.localStorage.setItem("wfm_abtestgroup",JSON.stringify(t))}catch(e){console.error("Failed saving abTestGroup",e.stack||e.stacktrace||e.message)}return t},_setupTestBuckets:function(t,i){e.each(i,e.partial(this._setupTestBucket,t),this)},_setupTestBucket:function(t,e){var a=this._getVariant(t,e.trafficVolume,e.variants,e.trafficStartingOffset),r=i.getNested(a,"variant")||"control",n=this._generateTestIdentifier(e.urlRegex,e.id);this._registerCookie(t,e,n,r),new RegExp(e.urlRegex).test(window.location.pathname)&&this._registerEvents(e.eventTriggers,n,r)},_getActiveTests:function(){return e.filter(i.getNested(window.site_vars,"abtests"),this._isActive)},_registerCookie:function(e,i,a,r){e<=i.trafficVolume+i.trafficStartingOffset&&(i.trafficVolume%i.variants.length===0&&r?t.cookie(a,r,{expires:new Date(i.endTime)}):console.warn("The number of variants for A/B Test "+i.name+" are not divisible by the traffic_volue("+i.trafficVolume+"). No segmentation cookies are being set."))},_getVariant:function(t,e,i,a){for(var r=0,n=e/i.length,s=e+a,o=a+1;s>=o;o++){if(t==o)return i[r];o%n===0&&r++}},_isActive:function(t){if(t.trafficStartingOffset=t.trafficStartingOffset||0,t.trafficStartingOffset+t.trafficVolume>100)return console.warn("Traffic Offset + Traffic Volume exceeds the maximum of 100, please reduce the offset or traffic volume"),!1;var e=new Date;return t.endTime&&new Date(t.endTime)<e?!1:t.startTime&&new Date(t.startTime)>e?!1:!0},_generateTestIdentifier:function(t,e){return"wfm-ab-"+t.replace(/[^\w\/-]+/g,"").replace(/^\//,"").replace(/\/$/,"").replace(/[ \/]/g,"-")+"-"+e},_registerEvents:function(t,a,n){e.each(t,function(t){t.selector&&i.get("body").on("click."+this.cid,t.selector,function(){r.trigger("abtesttrack",a+"|"+n)})},this)}},new n});
//# sourceMappingURL=abtestmanager.js
//# sourceMappingURL=abtestmanager.js.map