define(["jquery","underscore","base-app","pubsub","utils","state","user-manager","managers/routemanager","modules/global/breaking-news","directAdPosition","modules/header/site-nav-more-module","easing","animatecolors"],function(e,t,i,s,a,n,r,h,o,d,l){"use strict";var c=i.extend({el:".site-header",events:{"click .site-nav-search-link":"onClickNavSearchIcon","click .site-masthead-search-close-btn":"onClickSearchCloseBtn","click .site-masthead-search-btn-div":"onClickSearchBtnDiv"},navHeaderHeight:40,mastheadHeight:80,fixedHeaderThreshold:80,hoverDropdownDelay:120,TWO_COL_THRESHOLD:5,SITE_NAV_HIDDEN_CLASS:"site-nav-item-hidden",SITE_NAV_MORE_VISIBLE_CLASS:"site-nav-more-dropdown-item-visible",initialize:function(){this.isMulti=!!this.$el.attr("data-multi-header"),this.isThirdParty=!!this.$el.attr("data-third-party"),this.$win=a.get("win"),this.$top=a.get("scrollEl"),this.$siteHeaderInnerWrap=this.$(".site-header-inner-wrap"),this.$siteMasthead=this.$(".site-masthead"),this.$searchWrap=this.$(".site-masthead-search-wrap"),this.$navLogo=this.$(".site-nav-logo-item"),this.$navLogoLink=this.$(".site-nav-logo-link"),this.$navMoreItem=this.$(".site-nav-more-item"),this.$navLogoImg=this.$navLogo.find(".site-nav-logo-img"),this.$searchCancelBtn=this.$(".site-masthead-search-close-btn"),this.navLogoImgWidth=this.$navLogoImg.outerWidth(!0),this.$specialOffersMastheadAd=this.$(".site-masthead-special-offers-ad"),this.$subscribeWrap=this.$(".site-masthead-subscribe-wrap"),this.$siteMoreDropdownItems=this.$(".site-nav-more-dropdown-item:not(.site-nav-more-dropdown-item-hidden)"),this.$searchInput=this.$$(".site-masthead-search-form-input"),this.navHeight=this.$siteHeaderInnerWrap.outerHeight(),this.minHeight=this.$el.outerHeight(),t.bindAll(this,"onBreakingNewsChange","onFixingScroll","onClosingScroll","_handleOnAdReady","_onResizeWindow"),this.slideSpeed=200,a.set("headerHeight",this.navHeight),this.slideEasing="ease-out";var e=this.$el.data("open"),s=this.$el.data("fixed"),n=this.$el.data("default-open")||!1,r=this.$el.data("default-fixed")||!1;void 0===e&&(e=n),void 0===s&&(s=r),this.state={open:e,defaultOpen:n,fixed:s,defaultFixed:r,hasFixingScroller:!1,hasClosingScroller:!1},this.pubSub={"user:statuschange":this._loginStatus,"page:load":this._onPageLoad,"header:open":this.navAutoFitItems,"header:closed":this.navAutoFitItems},i.prototype.initialize.apply(this,arguments),this.start(),s||(this._setState({hasFixingScroller:!0}),a.getScrollPosition()&&this.onFixingScroll())},start:function(){this.loadHeaderModules(),this.subviews.breakingbar=new o({el:this.$(".bnm-container"),slideSpeed:this.slideSpeed,onBreakingNewsChange:this.onBreakingNewsChange}),this.moreLayout="1col",this.isThirdParty||(this.subviews.moreModule=new l({el:this.$navMoreItem[0]}));var e=t.throttle(this._onResizeWindow,500);this.$win.on("resize."+this.cid,e),this.navAutoFitStart()},navAutoFitStart:function(){this.$siteNavDynamicPrimaryItems=this.$(".site-nav-primary-item:not(.site-nav-more-item,.site-nav-logo-item,.site-nav-always-visible-item,.site-nav-spacer-item)"),this.$siteNavAlwaysVisibleItems=this.$(".site-nav-always-visible-item,.site-nav-secondary-item"),this.siteNavDynamicItemsWidths=this.getNavGroupWidths(this.$siteNavDynamicPrimaryItems),this.siteNavAlwaysVisibleItemsWidths=this.getNavGroupWidths(this.$siteNavAlwaysVisibleItems),this.siteNavMoreItemWidth=this.$navMoreItem.outerWidth(),this.siteNavAlwaysVisibleItemsTotalWidth=t.reduce(this.siteNavAlwaysVisibleItemsWidths,function(e,t){return e+t},0),this.siteNavLogoWidth=this.navLogoImgWidth-10,this.isThirdParty||(this.hiddenPrimaryItemsCount=0),this._updateMastheadWidth(),this.navRevealed||(this.isThirdParty||0!==this.hiddenPrimaryItemsCount||this.$navMoreItem.addClass(this.SITE_NAV_HIDDEN_CLASS),this.$(".site-nav-item").addClass("site-nav-item-visible"),this.navRevealed=!0)},navAutoFitItems:function(){var e=this.state.open?0:this.siteNavLogoWidth,t=this.isThirdParty?0:this.siteNavMoreItemWidth,i=this.siteNavAlwaysVisibleItemsTotalWidth+e,s=this.siteNavDynamicItemsWidths.length;this.firstHiddenNavItemIndex||(this.firstHiddenNavItemIndex=s);for(var a=0;a<this.siteNavDynamicItemsWidths.length;a++){var n=this.siteNavDynamicItemsWidths[a];if(i+n>this.mastheadWidth){if(i+t<=this.mastheadWidth){s=a;break}for(var r=a-1;r>=0;r--){var h=this.siteNavDynamicItemsWidths[r];if(i+t-h<=this.mastheadWidth){s=r;break}i-=h}break}i+=n}if(s!==this.firstHiddenNavItemIndex){var o=s<this.firstHiddenNavItemIndex,d=o?s:this.firstHiddenNavItemIndex,l=o?this.firstHiddenNavItemIndex:s;this.togglePrimaryNavItems(s,d,l),this.toggleMoreNavItems(s,d,l),this.firstHiddenNavItemIndex=s}},togglePrimaryNavItems:function(e,t,i){this.$siteNavDynamicPrimaryItems.slice(t,i).toggleClass(this.SITE_NAV_HIDDEN_CLASS)},toggleMoreNavItems:function(e,t,i){if(!this.isThirdParty){var s=e<this.firstHiddenNavItemIndex,a=this.siteNavDynamicItemsWidths.length-e,n=this.willMoreDropdownAppear(a)||this.willMoreDropdownHide(a);if(this.$siteMoreDropdownItems.slice(t,i).toggleClass(this.SITE_NAV_MORE_VISIBLE_CLASS),n){var r=0===a;this.$navMoreItem.toggleClass(this.SITE_NAV_HIDDEN_CLASS,r),this.allPrimaryNavItemsShown=!s}this.hiddenPrimaryItemsCount=a,this._updateMoreColumnLayout()}},willMoreDropdownAppear:function(e){return 0===e&&this.hiddenPrimaryItemsCount>0},willMoreDropdownHide:function(e){return 0===this.hiddenPrimaryItemsCount&&e>0},getNavGroupWidths:function(i){return t.map(i,function(t){return e(t).outerWidth()})},_updateMastheadWidth:function(){var e=this.$siteMasthead.outerWidth();if(e!==this.mastheadWidth){var t=e>this.mastheadWidth?"wider":"narrower";this.mastheadWidth=e,"wider"===t&&this.allPrimaryNavItemsShown||this.navAutoFitItems()}},_updateMoreColumnLayout:function(){this.isThirdParty||(this.hiddenPrimaryItemsCount>this.TWO_COL_THRESHOLD&&"2col"!=this.moreLayout?(this.subviews.moreModule.convertColumnLayout("2col"),this.moreLayout="2col"):"1col"!=this.moreLayout&&(this.subviews.moreModule.convertColumnLayout("1col"),this.moreLayout="1col"))},_onPageLoad:function(e){this._buildSpecialOffersMastheadAd(),this._onResizeWindow(e)},_onResizeWindow:function(){this._updateMastheadWidth()},_buildSpecialOffersMastheadAd:function(){if(this.$specialOffersMastheadAd.length){var e,i=n.getActivePageInfo().numPageViewsLeft,s=r.getAccount("firefly");void 0!==i&&(e={pwvr:i>0?i:"0"}),this.subviews.specialOffersMastheadAd?e&&(this.subviews.specialOffersMastheadAd.setTargeting(e),this.subviews.specialOffersMastheadAd.refreshPosition()):s?s.getUserInfo().done(t.bind(function(t){t.hasMarketAccess||this._applyMastheadDirectPositionAd(e)},this)).fail(t.bind(function(){this._applyMastheadDirectPositionAd(e)},this)):this._applyMastheadDirectPositionAd(e)}},_applyMastheadDirectPositionAd:function(e){this.subviews.specialOffersMastheadAd=new d({el:this.$specialOffersMastheadAd,adSizes:[122,50],adPlacement:"consumer_sales-masthead",onAdReady:this._handleOnAdReady,targeting:e})},_handleOnAdReady:function(){this.$subscribeWrap.remove(),this.$specialOffersMastheadAd.addClass("site-masthead-subscribe-wrap-visible"),this.subviews.specialOffersMastheadAd.showAd()},destroy:function(){this._unregisterFixingScroller(),this.$win.off("."+this.cid),clearTimeout(this.headerTransparencyTimeout),i.prototype.destroy.call(this)},_loginStatus:function(e,t,i){"firefly"===e&&("loggedIn"===t&&i&&i.hasMarketAccess?this.$subscribeWrap.removeClass("site-masthead-subscribe-wrap-visible"):"loggingIn"!==t&&this.$subscribeWrap.addClass("site-masthead-subscribe-wrap-visible"))},isFixedAndClosed:function(e){return!(e.open||!e.fixed||e.hasFixingScroller||e.hasClosingScroller)},_setState:function(e){var i,a="";t.each(e,function(t,s){this.state[s]!==t&&("fixed"===s?t?(this.$siteHeaderInnerWrap.addClass("site-header-inner-wrap-fixed"),a+=" header:fixed"):(this.$siteHeaderInnerWrap.removeClass("site-header-inner-wrap-fixed"),a+=" header:unfixed"):"open"===s?(i=this.state.fixed===!0&&(void 0===e.fixed||e.fixed===!0)||void 0!==e.hasFixingScroller&&this.state.hasFixingScroller!==e.hasFixingScroller,this._setMasthead(t,i),a+=t?" header:open":" header:closed"):"hasFixingScroller"===s?t?this._registerFixingScroller():this._unregisterFixingScroller():"hasClosingScroller"===s?t?this._registerClosingScroller():this._unregisterClosingScroller():console.warn("Unknown state key: "+s))},this),this._checkTransition(this.state,e),t.extend(this.state,e),a&&s.trigger(a)},_checkTransition:function(t,i){i=e.extend({},t,i);var s=this.isFixedAndClosed(t),a=this.isFixedAndClosed(i),n=t.open!==i.open;s!==a&&(a?this._transitionToCloseFixed(n):this._transitionFromCloseFixed(n))},_transitionToCloseFixed:function(e){this.navHeight=this.navHeaderHeight,this.updateHeaderMinHeight(e)},_transitionFromCloseFixed:function(e){this.navHeight=this.navHeaderHeight+this.mastheadHeight,this.updateHeaderMinHeight(e)},_registerFixingScroller:function(){this.isMulti||(this.hasFixingScroller?console.warn("Attempting to register headerFixingScroller twice"):(this.hasFixingScroller=!0,this.$win.on("scroll.headerFixingScroller",t.throttle(this.onFixingScroll,20))))},_unregisterFixingScroller:function(){this.hasFixingScroller=!1,this.$win.off(".headerFixingScroller")},onFixingScroll:function(){var e=a.getScrollPosition()>=this.mastheadHeight;e!==this.state.fixed&&this._setState({open:!e,fixed:e})},_registerClosingScroller:function(){this.isApple||this.isMulti||(this.hasClosingScroller?console.warn("Attempting to register headerFixingScroller twice"):(this.hasClosingScroller=!0,this.$win.on("scroll.headerClosingScroller",t.throttle(this.onClosingScroll,20))))},_unregisterClosingScroller:function(){this.hasClosingScroller=!1,this.$win.off(".headerClosingScroller")},onClosingScroll:function(){this._setState({open:!1,fixed:!0,hasClosingScroller:!1}),this.transparencySetup&&!this.headerIsTransparent&&this.toggleTransparency(!0)},loadHeaderModules:function(){this.$(".headermodules").each(t.bind(function(t,i){try{var s=JSON.parse(e(i).html()).js_modules||[];this.buildModules(s)}catch(a){console.error("Failure loading header modules",a)}},this))},onClickNavSearchIcon:function(e){e.preventDefault(),this.$searchInput.focus(),this.state.open||(this._setState({open:!0,fixed:!0,hasClosingScroller:!0}),this.$searchCancelBtn.addClass("site-masthead-search-close-btn-visible"),this.transparencySetup&&this.headerIsTransparent&&this.toggleTransparency(!1))},scrollTop:function(e,t){if(!t)if(this.state.open){var i=a.getScrollPosition();if(e<this.fixedHeaderThreshold&&i<this.fixedHeaderThreshold)return i}else this.state.hasFixingScroller&&e<this.fixedHeaderThreshold&&(e=this.fixedHeaderThreshold);return this.$top.scrollTop(e),e},isFixed:function(){return this.state.fixed},isOpen:function(){return this.state.open},setOpenFixed:function(t){t&&(this.lastState=e.extend({},this.state)),this._setState({open:!0,fixed:!0,hasFixingScroller:!1,hasClosingScroller:!1})},getFixedHeight:function(){return this.isFixedAndClosed(this.state)?this.minHeight:this.minHeight-this.mastheadHeight},setFixingScroller:function(e){this._setState(e?{hasFixingScroller:!0,hasClosingScroller:!1}:{hasFixingScroller:!1,hasClosingScroller:!1})},setClosedFixed:function(t){t&&(this.lastState=e.extend({},this.state)),this._setState({open:!1,fixed:!0,hasFixingScroller:!1,hasClosingScroller:!1})},restoreLastState:function(){this.lastState&&(this._setState(this.lastState),this.lastState=null)},restoreDefaultState:function(){if(this.state.defaultFixed)this._setState({open:this.state.defaultOpen,fixed:this.state.defaultFixed,hasFixingScroller:!this.state.defaultFixed,hasClosingScroller:!1});else{var e=a.getScrollPosition()>=this.mastheadHeight;this._setState({open:!e,fixed:e,hasFixingScroller:!0,hasClosingScroller:!1})}},onClickSearchBtnDiv:function(t){e(t.currentTarget).parents("form").trigger("submit")},onClickSearchCloseBtn:function(){n.getActiveApp().isSearchPage?h.goTo("/"):(this._setState({open:!1,fixed:!0,hasClosingScroller:!1}),this.transparencySetup&&!this.headerIsTransparent&&this.toggleTransparency(!0))},_collapseMasthead:function(e){e?this.animate(this.$searchWrap,"height",0,this.slideSpeed,this.slideEasing).always(t.bind(function(){this.$searchCancelBtn.length&&this.$searchCancelBtn.removeClass("site-masthead-search-close-btn-visible")},this)):this.$searchWrap.css("height",0),this.toggleNavLogo(!0,!0)},_expandMasthead:function(e){e?this.animate(this.$searchWrap,"height",this.mastheadHeight+"px",this.slideSpeed,this.slideEasing).done(t.bind(function(){this.$searchInput.focus()},this)):this.$searchWrap.css("height",this.mastheadHeight),this.toggleNavLogo(!0,!1)},_setMasthead:function(e,t){e?this._expandMasthead(t):this._collapseMasthead(t)},getExpandedHeight:function(){return this.minHeight},getScrollOffset:function(){return this.isFixed()?this.minHeight!=this.navHeaderHeight?this.minHeight-this.navHeaderHeight:this.minHeight:0},getFixedThreshold:function(){return this.fixedHeaderThreshold},getCollapsedHeight:function(){return this.navHeaderHeight},getCurrentHeight:function(){return this.navHeight},toggleNavLogo:function(e,t){var i=t?1:0,s=t?this.navLogoImgWidth:0;this.$navLogoImg.css("opacity",i),this.$navLogoLink.css("width",s)},updateHeaderMinHeight:function(e){this.minHeight=this.navHeight+(this.subviews.breakingbar?this.subviews.breakingbar.getHeight():0),e?this.animate(this.$el,"min-height",this.minHeight,this.slideSpeed):this.$el.css("min-height",this.minHeight)},onBreakingNewsChange:function(e){this.updateHeaderMinHeight(),e?s.trigger("breakingbar:before:open",this.minHeight,this.options.slideSpeed):s.trigger("breakingbar:before:close",this.minHeight,this.options.slideSpeed)},updateNavigation:function(e){var t,i,a,n="site-nav-active-span",r="site-nav-active-item";for(this.$("."+n).removeClass(n),this.$("."+r).removeClass(r),e=e||"home",a=e.indexOf("?"),-1!==a&&(e=e.substring(0,a)),"/"===e[0]&&(e=e.substring(1)),"/"===e[e.length-1]&&(e=e.substring(0,e.length-1)),e=e.replace(/[^_a-zA-Z0-9\-/]/g,""),t=e?e.split("/"):["home"];t.length&&(i=this.$(".site-nav-"+t.join("-")+"-item"),!i.length);)t=t.splice(0,t.length-1);var h=t.join("-");s.trigger("update:navigation",h),i&&i.length&&(this.$(".site-nav-"+h+"-span").addClass(n),i.addClass(r))},setupTransparency:function(){this.siteHeaderInnerWrapBg=this.$siteHeaderInnerWrap.css("background"),this.$siteHeaderInnerWrap.addClass("transparent-transition").css("background",""),this.transparencySetup=!0},destroyTransparency:function(){this.$siteHeaderInnerWrap.removeClass("transparent-transition"),this.$el.removeClass("transparent-header"),this.transparencySetup=!1,this.headerTransparencyTimeout=t.delay(t.bind(function(){this.$siteHeaderInnerWrap.css("background",this.siteHeaderInnerWrapBg)},this),350)},toggleTransparency:function(e){this.transparencySetup||this.setupTransparency(),e?(this.$el.addClass("transparent-header"),this.headerIsTransparent=!0):(this.$el.removeClass("transparent-header"),this.headerIsTransparent=!1)}});return c});
//# sourceMappingURL=header.js
//# sourceMappingURL=header.js.map