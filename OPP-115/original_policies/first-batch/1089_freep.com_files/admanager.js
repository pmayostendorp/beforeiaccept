define(["jquery","underscore","pubsub","state","utils","user-manager","partner/ad-slot","modules/global/memobarrier","adLogger","cookie"],function(e,t,i,a,n,r,o,s,d){"use strict";var l=function(){this.initialize()};return l.prototype={adSizes:{pushdown:[1200,615],gravity:[2560,1440],dual_pushdown:[1200,1230],skyline:[1080,450],elastic:[1080,810],outofpage:[1080,810],cinematicvideoskin:[2600,1400],heroflip:[720,524],coverviewfullpage:[1,1],bigpageflex:[1,1],mediumrectangle:[300,250],halfpage:[300,600],sponsor_logo_medium:[100,50],leaderboard:[728,90],generic:[1,2],filmstrip:[300,600],iabpushdown:[970,90],iabpushdown2:[970,66],billboard:[970,250],portrait:[300,1050],sponsor_logo:[100,30]},flexibleAds:["pushdown","gravity","dual_pushdown","elastic","outofpage","cinematicvideoskin","heroflip","coverviewfullpage","generic"],activeAdPlacements:{},globalTargetingKeys:[],getSharedAdSlot:function(e,i,a,n){var r=this._buildAdSizesFromPlacements(i),o=this.buildAdUnit(e),s=a&&a.$el||this.globalStaging;return n=n||a&&a.getSlotType()||"in",this._createAdSlot(o,{},r,n,s,function(e,t){if(!t&&a)a.render();else{var n=i[t];if(!n)return void d.logError("AdSlot("+o+"): ad delivered to unknown ad position/type: "+t);n.render(e,t)}},function(){t.each(i,function(e){e.noAd()})})},getAdSlot:function(e,t,i,a,n){var r=this.buildAdUnit(e),o=this._mapAdSizeNamesToActualSizes(i);return this._createAdSlot(r,t,o,n,a.$el,function(e,t){a.render(e,t)},function(){a.noAd()})},buildAdUnit:function(e){var t=n.getNested(window.site_vars,"ADS")||{},i=n.getNested(t,"DFP","ACCOUNTID"),a=n.getNested(t,"DFP","ACCOUNTNAME");return this.override&&(i=this.override.usatai,a=this.override.usatan),i+"/"+a+"/"+e},getSize:function(t){var i=this.adSizes[e.trim(t)];return i?i:(d.logWarn("Size not found for "+t),null)},isFlexibleAdSize:function(e){return-1!==t.indexOf(this.flexibleAds,e)},getVCESize:function(e){var t=this.getSize(e);return t?t.join("x"):"1x1"},initialize:function(){if(this._resetSlots(),!window.googletag)return this.adLoadBarrier.resolve(),void(this.pageLoaded=!0);this.targetBarrier=new s,this._fetchTargeting(),d.logGroup("AdManager initialize"),this.pubSub={"page:load":this.onPageLoad,"page:unload":this.onPageUnload,"user:statuschange":this.onUserStatusChange},i.attach(this.pubSub,this);var t=n.getUrlParam("usatai"),a=n.getUrlParam("usatan"),r=n.getUrlParam("usatl");t&&a&&r&&(this.override={usatai:t,usatan:a,usatl:r}),this.globalStaging=e("#ad-staging"),this._initializeGoogletag(),window.adManager=this,this._initializeBaseTargeting(),d.logDebug("AdManager initialized"),d.logGroupEnd()},stop:function(){i.unattach(this.pubSub,this)},_beginA9:function(){var e=n.getNested(window.site_vars,"ADS","a9");e&&e.enabled&&this.targetBarrier.add(this._fetchA9(e),2e3,!0)},_fetchA9:function(t){return n.loadScript(t.url,"amznads").then(function(i){try{i.ads={},i.getAdsAsync(t.account)}catch(a){return console.error("failed amznads.getAdsAsync("+t.account+")",a),e.Deferred().reject()}return e.Deferred(function(e){i.tasks.push(function(){e.resolve({amznslots:i.getTokens()})})})})},_fetchTargeting:function(){this._beginA9(),this._beginCriteo(),this._beginPubMatic()},_beginCriteo:function(){var e=n.getNested(window.site_vars,"ADS","criteo");e&&e.enabled&&this.targetBarrier.add(this._fetchCriteo(e),2e3,!0)},_fetchCriteo:function(i){return window[i.varName]=e.cookie(i.cookie),e.ajax({url:i.url,data:{netId:i.account,cookieName:i.cookie,varName:i.varName},dataType:"script"}).then(t.bind(function(){var e=window[i.varName];return e?t.reduce(e.split(";"),function(e,t){if(t){var i=t.split("=");e[i[0]]=i[1]}return e},{}):{}},this))},_beginPubMatic:function(){var e=n.getNested(window.site_vars,"ADS","pubMatic");e&&e.enabled&&this.targetBarrier.add(this._fetchPubMatic(e),2e3,!0)},_fetchPubMatic:function(i){window.pm_pub_id=i.account,window.pm_optimize_adslots=i.slots;var a,n=i.site,r=i.group;switch(window.location.href.split("/")[3]){case"ros":a="10";break;case"life":a="20";break;case"money":a="30";break;case"news":a="40";break;case"sports":a="50";break;case"tech":a="60";break;case"travel":a="70";break;case"weather":a="80";break;case"entertainment":a="90";break;default:a="0"}return window.pmzoneid=t.compact([r,n,a]).join(","),window.kadpageurl=document.location.hostname,d.logGroup("PubMatic Initialization Info"),d.logInfo("PubMatic pmzoneid: "+window.pmzoneid),d.logInfo("PubMatic slots: "+window.pm_optimize_adslots),d.logGroupEnd(),e.Deferred(function(a){window.pm_async_callback_fn="pm_async_callback",window.pm_async_callback=function(){var e,i,n=window.PubMaticGrouped;if(n){try{e=n.getCombinedKeyValueGPT()}catch(r){d.logError("PubMatic.getCombinedKeyValueGPT() failed",r)}e&&(e=e.replace(/ATF@728x90/gi,"pm1").replace(/BTF@728x90/gi,"pm2").replace(/ATF@300x250/gi,"pm3").replace(/BTF@300x250/gi,"pm4").replace(/ATF@300x600/gi,"pm5").replace(/ROS@970x250/gi,"pm6-bid").replace(/ROS@300x1050/gi,"pm7-bid"),i=t.chain(e.split(";")).map(function(e){return e.split("=")}).filter(function(e){return e.length>1&&e[0].match("bid$")&&parseInt(e[1],10)>0}).object().value(),a.resolve(i))}else d.logError("PubMatic script failed to provide PubMaticGrouped");a.reject()},e.ajax({url:i.url,dataType:"script",cache:!0}).fail(function(){a.reject()})})},_createAdSlot:function(i,a,r,s,d,l,c){var g=e.Deferred();return g.done(t.bind(function(){this.activeSlotStatistics.unknown--},this)),this.activeSlotStatistics.unknown++,new o({adUnit:i,targeting:a,sizes:r,type:s||"out",position:d,onSlotRequest:t.bind(function(){this.slotsBarrier.add(g,2e3,!0)},this),onSlotEmpty:t.bind(function(){this.activeSlotStatistics.noad++,g.resolve(),c()},this),onSlotRender:t.bind(function(e,t){if(t){this.activeSlotStatistics.high_impact++;var i=n.getNested(e,"dfp","ecid");this.activeSlotStatistics.high_impact_info.push({adType:t,cap:e.maxDisplayed,capExp:parseInt(e.leaveBehindExp,10),ecid:i,state:"loading"})}else this.activeSlotStatistics.iab++;g.resolve(),l(e,t)},this)})},_resetSlots:function(){this.slotsBarrier?this.slotsBarrier.cancel(!0):this.slotsBarrier=new s,this.adLoadBarrier&&this.adLoadBarrier.reject(),this.adLoadBarrier=e.Deferred(),this.activeSlotStatistics={high_impact:0,high_impact_info:[],iab:0,noad:0,unknown:0}},getActiveSlotStatistics:function(){return this.adLoadBarrier.then(t.bind(function(){return this.slotsBarrier.wait()},this)).then(t.bind(function(){var i=this.activeSlotStatistics;return e.Deferred(function(e){t.defer(function(){e.resolve(i)})})},this))},updateActiveSlotStatistics:function(e,i){var a=t.findWhere(this.activeSlotStatistics.high_impact_info,{adType:e});a&&(a.state=i)},_initializeGoogletag:function(){googletag.cmd.push(function(){var e=googletag.pubads();d.logInfo("Collapses the empty divs. Used for the asset pages where the slot and placement are the same"),e.collapseEmptyDivs(),e.enableSingleRequest(),d.logInfo("Disabling initial load of slots"),e.disableInitialLoad(),d.logInfo("Enabled the ad calls"),googletag.enableServices()})},_initializeBaseTargeting:function(){var t=googletag.pubads(),i=this.override;googletag.cmd.push(function(){var a=((e.cookie("aamusat")||"").match(/[0-9]+/g)||[]).join();t.setTargeting("aam",a),t.setTargeting("u",e.cookie("aam_uuid")||""),i&&i.usatl&&t.setTargeting("adlabel",i.usatl);var r=n.getNested(window.site_vars,"ADS","DFP","ENV");d.logInfo("using env targeting: "+r),t.setTargeting("env",r)})},onPageLoad:function(i){this._buildSharedAdSlots(i.cst),this.pageLoaded=!0,this.targetBarrier?this.targetBarrier.wait().done(t.bind(function(){var t=[{},{ss:this.ssInfo}].concat([].slice.call(arguments)),a=e.extend.apply(e,t);d.logInfo("AdManager: requestAds()",i,a),this._setGlobalTargeting(i,a),o.prototype.pageLoad(),this.adLoadBarrier.resolve()},this)):this.adLoadBarrier.resolve()},_buildSharedAdSlots:function(e){t.each(this.activeAdPlacements,function(t){t&&(t.slotInfo=this.getSharedAdSlot(t.name+"/"+e,t.positionMap,t.defaultPosition))},this)},onPageUnload:function(){this.pageLoaded=!1,this._resetSlots(),o.prototype.pageUnLoad(),this._resetTargeting()},_resetTargeting:function(){this.targetBarrier.cancel(!0),this._clearGlobalTargeting(),this._fetchTargeting()},isPageLoaded:function(){return this.pageLoaded},_clearGlobalTargeting:function(){googletag.cmd.push(t.bind(function(){var e=googletag.pubads(),i=this.globalTargetingKeys;d.logInfo("clear pubads() targetting",i),t.each(i,function(t){e.clearTargeting(t)}),this.globalTargetingKeys=[]},this))},_setGlobalTargeting:function(i,n){var r=this,o=a.getActiveApp(),s=e.extend({},this.getPageAdTargeting(i),n,o&&o.getClientAdInfo());this.globalTargetingKeys=[],googletag.cmd.push(function(){var e=googletag.pubads();t.each(s,function(t,i){(t||0===t||t===!1)&&(r.globalTargetingKeys.push(i),e.setTargeting(i,String(t)),d.logInfo("set pubads() targetting - key:"+i+" value:"+t))})})},getPageAdTargeting:function(e){var t=n.getNested(window,"site_vars","aws_site_name")||"usat";return{pageType:e.basePageType,referrer:(a.getReferrer().match(/https?:\/\/[:\w\.-]+/)||[])[0],series:e.series,sitepage:t+"/"+e.ssts,contentid:e.assetid,topic:e.topic}},onUserStatusChange:function(e,i){if("firefly"===e)if("loggedIn"==i||"loggingIn"==i){var a=r.getCoreUserInfo();a=a.then(t.bind(function(e){this.ssInfo=e.UserLicenseType?t.map(e.UserLicenseType.split("_"),function(e){return e.substring(0,3)}).join("_"):null},this),t.bind(function(){this.ssInfo=null},this)),this.targetBarrier.add(a,2e3,!0)}else this.ssInfo=null},getAdActualSizes:function(e){return this._mapAdSizeNamesToActualSizes(e)},_mapAdSizeNamesToActualSizes:function(e){if(t.isString(e)){var i=e.split(",");return this._processAdSizeData(i.length>1?i:[e])}return t.isArray(e)?this._processAdSizeData(this._isAdSizeArray(e)?[e]:e):[]},_processAdSizeData:function(e){return t.reduce(e,function(e,i){var a;return t.isString(i)?a=this._getAdSizeFromString(i):t.isArray(i)&&this._isAdSizeArray(i)&&(a=i),a&&e.push(a),e},[],this)},_isAdSizeArray:function(t){return 2===t.length&&e.isNumeric(t[0])&&e.isNumeric(t[1])},_getAdSizeFromString:function(e){var t=this.getSize(e);if(!t){var i=e.toLowerCase().split("x");2===i.length&&(i=[parseInt(i[0],10),parseInt(i[1],10)],this._isAdSizeArray(i)&&(t=i))}return t},_buildAdSizesFromPlacements:function(i){var a=[];return t.each(i,function(t){var i=this._mapAdSizeNamesToActualSizes(t.getAdSizes());e.merge(a,i)},this),t.uniq(a)},refreshSharedAdPosition:function(e){var i=this.activeAdPlacements[e];return i?i.slotInfo?(t.each(i.positionMap,function(e){e.destroyAdPlacement()},this),void i.slotInfo.refresh()):void d.logError("AdManager: tried refreshing shared ad position that hasn't been requested yet"):void d.logError("AdManager: tried refreshing shared ad position that no longer exists")},registerSharedAdPosition:function(e){var i=e.getAdPlacement(),a=e.getAdType();if(this._checkPageChange(),a&&!t.isArray(a)&&(a=[a]),!i||!a||!a.length)return void d.logError("AdManager: invalid ad unit registered, adUnit and adType are required",e);var n=this._getAdPlacementInfo(i);this._addAdToPlacementInfo(n,e,a)},_getAdPlacementInfo:function(e){var t=this.activeAdPlacements[e];return t||(this.activeAdPlacements[e]=t={name:e,positionMap:{},defaultPosition:null,slotInfo:null,numPositions:0}),t},_addAdToPlacementInfo:function(e,i,a){t.each(a,function(t){return e.positionMap[t]?void d.logError("AdManager: invalid ad unit registered, duplicate adType registered",i):(d.logInfo("AdManager: registerSharedAdPosition for adPlacement: "+e.name+" and adType:"+t),void(e.positionMap[t]=i))}),e.numPositions++,i.isDefaultPosition()&&(e.defaultPosition?d.logWarn("AdManager: multiple ad placements declared themselves default for adUnit: "+e.name,i):e.defaultPosition=i)},_checkPageChange:function(){var e=window.location.pathname;e!==this.siteUrl&&(this.siteUrl=e,t.each(this.activeAdPlacements,function(e){e&&d.logError("Site Url changed, but ad placements were not released: ",e)}),this.activeAdPlacements={})},destroySharedAdPosition:function(e){var i=e.getAdPlacement(),a=e.getAdType(),n=this.activeAdPlacements[i];return n?(a&&!t.isArray(a)&&(a=[a]),t.each(a,function(t){var a=n.positionMap[t];return a?(d.logInfo("AdManager: destroySharedAdPosition for adPlacement: "+i+" and adType:"+t),void(n.positionMap[t]=null)):void d.logError("AdManager: destruction of unknown ad type",e)}),e.isDefaultPosition()&&(n.defaultPosition=null),n.numPositions--,void(n.numPositions||(n.slotInfo&&n.slotInfo.destroy(),this.activeAdPlacements[i]=null))):void d.logError("AdManager: destruction of unknown ad unit",e)},_createScript:function(e,t,i){d.logDebug("Creating script",e,t,i[0]);var a=document.createElement("script");a.id=e,a.src=t,a.type="text/javascript",a.defer=!1,i[0].appendChild(a)},logDebug:function(){d.logDebug.apply(d,arguments)},logError:function(){d.logError.apply(d,arguments)},logInfo:function(){d.logInfo.apply(d,arguments)},logWarn:function(){d.logWarn.apply(d,arguments)}},new l}),define("api/ads",["jquery","admanager"],function(e,t){return{registerAd:function(i,a,n,r){var o=e("string"==typeof i?"#"+i:i),s={$el:o,render:function(){},noAd:function(){}};t.getAdSlot(a,r,n,s,"in")}}});
//# sourceMappingURL=admanager.js
//# sourceMappingURL=admanager.js.map