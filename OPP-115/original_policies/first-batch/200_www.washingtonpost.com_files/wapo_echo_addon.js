var wapoIdentity;
function wapoIdentityInit(){function WapoIdentity(){var wapo_username=null;var echo_username=null;WapoIdentity.echo_commenting_group="commenting_verified"}WapoIdentity.prototype.reconcileUsernames=function(){if(typeof this.wapo_username!=="undefined"&&this.wapo_username!==null&&typeof this.echo_username!=="undefined"&&this.echo_username!==null)if(this.wapo_username===this.echo_username)if(this.wapo_username){this.loginCallback();this.echoLoginCallback()}else{this.logoutCallback();Backplane.resetCookieChannel();
this.echoLogoutCallback();Backplane.stopTimer("regular");Backplane.stopTimer("watchdog")}else if(this.wapo_username===""){this.logoutCallback();Backplane.resetCookieChannel();this.echoLogoutCallback();Backplane.stopTimer("regular");Backplane.stopTimer("watchdog")}else if(this.wapo_username!==""&&this.echo_username!==""){this.callLogoutPortableContact();Backplane.resetCookieChannel();this.loginCallback();this.echoLoginCallback()}else if(this.wapo_username!==""&&this.echo_username===""){this.loginCallback();
this.echoLoginCallback()}};WapoIdentity.prototype.init=function(){var wpni_login_id,wapo_login_id;try{document.domain=wapoEnv.site_base_domain}catch(err){}this.updateWapoUsername();this.updateEchoUsername();$wpjQ(document).bind(wapoEnv.event_name_logout,function(){wapoIdentity.wapo_username=null;wapoIdentity.echo_username=null;wapoIdentity.updateWapoUsername();wapoIdentity.updateEchoUsername()});$wpjQ(document).bind(wapoEnv.event_name_login,function(){wapoIdentity.wapo_username=null;wapoIdentity.echo_username=
null;wapoIdentity.updateWapoUsername();wapoIdentity.updateEchoUsername()});$wpjQ(document).bind(wapoEnv.event_name_new_registration,function(){wapoIdentity.wapo_username=null;wapoIdentity.echo_username=null;wapoIdentity.updateWapoUsername();wapoIdentity.updateEchoUsername()})};WapoIdentity.prototype.updateWapoUsername=function(){var isMemberOfCommentingGroup=this.getIsMemberOfCommentingGroup();if(isMemberOfCommentingGroup===true){var wapo_login_id=wapoUtilities.Get_Cookie(wapoEnv.cookie_login_id);
if(typeof wapo_login_id!=="undefined"&&wapo_login_id!==null){var wapoDisplay=wapoUtilities.Get_Cookie(wapoEnv.cookie_display);if(typeof wapoDisplay!="undefined"&&wapoDisplay!==null){var parts=wapoDisplay.split("|");if(parts.length>0){wapoIdentity.wapo_username=parts[0];if(wapoIdentity.wapo_username.substr(0,1)==='"')wapoIdentity.wapo_username=wapoIdentity.wapo_username.substring(1)}}}}else{wapoIdentity.wapo_username="";wapoIdentity.reconcileUsernames()}};WapoIdentity.prototype.updateEchoUsername=
function(){Echo.Events.subscribe({"topic":"Echo.UserSession.onInit","once":true,"handler":function(){wapoIdentity.echo_user.accounts=wapoIdentity.echo_user.get("activeIdentities");wapoIdentity.setEchoUsername()}});this.echo_user=new Echo.UserSession({"appkey":wapoEnv.jskit_consumer_key,"endpoints":{"logout":"https://comments-api.ext.nile.works/v2/","whoami":"https://comments-api.ext.nile.works/v1/users/"}})};WapoIdentity.prototype.setEchoUsername=function(){if(typeof this.echo_user!=="undefined"&&
typeof this.echo_user.accounts!=="undefined"&&this.echo_user.accounts.length>0){this.echo_username=this.echo_user.accounts[0].username;this.reconcileUsernames()}else{this.echo_username="";this.reconcileUsernames()}};WapoIdentity.prototype.loginCallback=function(){if(typeof this.echo_user==="undefined"||typeof this.echo_user.accounts==="undefined"||this.echo_user.accounts.length===0||this.echo_username!==this.wapo_username)this.callLoginPortableContact();else this.postComment();var profilePicDiv=$wpjQ("#wapo_change_avatar");
if(profilePicDiv!==null){var channelName=Backplane.getChannelName();profilePicDiv.html('\x3ca id\x3d"wapoChangeAvatarLink" href\x3d"http:'+wapoEnv.wapo_site_url+"siteRegistration/changeProfilePic?jskit_channel\x3d"+channelName+"\x26previous_url\x3d"+encodeURIComponent(window.location)+'"\x3eEdit Avatar\x3c/a\x3e')}};WapoIdentity.prototype.callLoginPortableContact=function(){var channelName=Backplane.getChannelName();var ajaxOptions={type:"GET",url:wapoEnv.wapo_secure_protocol+wapoEnv.wapo_site_url+
"public/visitor/login_portable_contact.json?jskit_channel\x3d"+channelName,dataType:"jsonp",cache:false,jsonp:wapoEnv.param_name_jsonp_callback,success:function(data){if(data!==null&&typeof data["response"]!=="undefined"&&data["response"]!==null)if(data["response"].indexOf("invalid")!==-1)wapoIdentity.echoLogoutCallback();else if(data["response"].indexOf("result\x3dsuccess")!==-1){wapoIdentity.echoLoginCallback();wapoIdentity.postComment()}},error:function(){}};$wpjQ.ajax(ajaxOptions);Backplane.expectMessagesWithin(10)};
WapoIdentity.prototype.logoutCallback=function(){this.callLogoutPortableContact();var profilePicLink=$wpjQ("#wapoChangeAvatarLink");if(profilePicLink!==null)profilePicLink.remove()};WapoIdentity.prototype.callLogoutPortableContact=function(){var openId=null;if(typeof this.echo_user!=="undefined"&&typeof this.echo_user.accounts!=="undefined"&&this.echo_user.accounts.length>0)for(var i=0;i<this.echo_user.accounts.length;i++){var account=this.echo_user.accounts[i];if(typeof account!=="undefined"){openId=
account.identityUrl;openId=openId.replace(/\%20/g,"%2B")}}if(openId!==null){var channelName=Backplane.getChannelName();var ajaxOptions={type:"GET",url:wapoEnv.wapo_secure_protocol+wapoEnv.wapo_site_url+"public/visitor/logout_portable_contact.json?jskit_channel\x3d"+channelName+"\x26jskit_login\x3d"+openId,dataType:"jsonp",cache:false,jsonp:wapoEnv.param_name_jsonp_callback,success:function(data){if(data!==null&&typeof data["response"]!=="undefined"&&data["response"]!==null)if(data["response"].indexOf("result\x3dsuccess")!==
-1);else if(data["response"].indexOf("invalid")!==-1);wapoIdentity.echoLogoutCallback()},error:function(){wapoIdentity.echoLogoutCallback()}};$wpjQ.ajax(ajaxOptions);Backplane.expectMessagesWithin(10)}else this.echoLogoutCallback()};WapoIdentity.prototype.echoLoginCallback=function(){$wpjQ(window).trigger("echoLoginStateChange",["login"]);if(typeof Echo.LoginStateChange==="function")Echo.LoginStateChange("login")};WapoIdentity.prototype.echoLogoutCallback=function(){$wpjQ(window).trigger("echoLoginStateChange",
["logout"]);if(typeof Echo.LoginStateChange==="function")Echo.LoginStateChange("logout")};WapoIdentity.prototype.storeComment=function(target,targetUrl,data,postData){var redirectUrl=window.location;redirectUrl=encodeURIComponent(redirectUrl);wapoUtilities.Set_Cookie("wapo_jskit_comment",targetUrl.postData.content,1,wapoEnv.site_path,wapoEnv.site_base_domain,false);wapoUtilities.Set_Cookie("wapo_jskit_targetUrl",targetUrl.postData.target,1,wapoEnv.site_path,wapoEnv.site_base_domain,false);wapoUtilities.Set_Cookie("wapo_jskit_redirectUrl",
redirectUrl,1,wapoEnv.site_path,wapoEnv.site_base_domain,false);if(typeof wapoVisitor.wapoLoginId!=="undefined"&&wapoVisitor.wapoLoginId!==null&&wapoVisitor.wapoLoginId!==""){var url=null;if(typeof wapoEnv.commenting_edit_profile_url!=="undefined"&&wapoEnv.commenting_edit_profile_url!==null&&wapoEnv.commenting_edit_profile_url!=="")url=wapoEnv.commenting_edit_profile_url;else url=wapoEnv.wapo_secure_protocol+wapoEnv.wapo_site_url+"siteRegistration/editProfile?"+wapoEnv.param_name_no_cancel+"\x3dtrue\x26";
wapoUtilities.Set_Cookie("wapo_jskit_loginUrl",url,1,wapoEnv.site_path,wapoEnv.site_base_domain,false)}else wapoUtilities.Set_Cookie("wapo_jskit_loginUrl",wapoEnv.wapo_reg_url,1,wapoEnv.site_path,wapoEnv.site_base_domain,false)};WapoIdentity.prototype.postComment=function(){var comment=wapoUtilities.Get_Cookie("wapo_jskit_comment");var targetUrl=wapoUtilities.Get_Cookie("wapo_jskit_targetUrl");if(comment!==null&&targetUrl!==null){comment=encodeURIComponent(comment);targetUrl=encodeURIComponent(targetUrl);
var ajaxOptions={type:"GET",url:wapoEnv.wapo_secure_protocol+wapoEnv.wapo_site_url+"public/visitor/submit_comment.json?jskit_comment\x3d"+comment+"\x26jskit_targeturl\x3d"+targetUrl,dataType:"jsonp",cache:false,jsonp:wapoEnv.param_name_jsonp_callback};$wpjQ.ajax(ajaxOptions);wapoUtilities.Delete_Cookie("wapo_jskit_comment",wapoEnv.site_path,wapoEnv.site_base_domain);wapoUtilities.Delete_Cookie("wapo_jskit_targetUrl",wapoEnv.site_path,wapoEnv.site_base_domain);wapoUtilities.Delete_Cookie("wapo_jskit_redirectUrl",
wapoEnv.site_path,wapoEnv.site_base_domain);wapoUtilities.Delete_Cookie("wapo_jskit_loginUrl",wapoEnv.site_path,wapoEnv.site_base_domain)}};WapoIdentity.prototype.getIsMemberOfCommentingGroup=function(groupValue){groupValue=typeof groupValue=="undefined"||groupValue==null?WapoIdentity.echo_commenting_group:groupValue;var isMemberOfCommentingGroup=false;if(typeof wapoVisitor!=="undefined"&&wapoVisitor!==null&&typeof groupValue!=="undefined"&&groupValue!==null){var completedGroups=wapoVisitor.completedGroups;
if(typeof completedGroups!=="undefined"&&completedGroups!==null&&completedGroups.indexOf(groupValue)!==-1)isMemberOfCommentingGroup=true}return isMemberOfCommentingGroup};WapoIdentity.prototype.isMemberOfCommentingGroup=function(groupValue){var isMemberOfCommentingGroup=this.getIsMemberOfCommentingGroup(groupValue);if(isMemberOfCommentingGroup==false);return isMemberOfCommentingGroup};wapoIdentity=new WapoIdentity;wapoIdentity.init()}function wapoLoginCallback(){wapoIdentity.loginCallback()}
function wapoLogoutCallback(){wapoIdentity.logoutCallback()};