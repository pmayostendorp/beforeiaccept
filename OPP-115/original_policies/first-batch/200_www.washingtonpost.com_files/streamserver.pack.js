(function(jQuery){var $=jQuery;var counter=Echo.Control.manifest("Echo.StreamServer.Controls.Counter");if(Echo.Control.isDefined(counter))return;counter.init=function(){if(!this.checkAppKey())return;var timeout=this.config.get("liveUpdates.timeout");if(typeof timeout!=="undefined")this.config.set("liveUpdates.polling.timeout",timeout);this.request=this._getRequestObject();if($.isEmptyObject(this.get("data")))this.request.send();else{this.render();this.ready();if(this.request)this.request.send({"skipInitialRequest":true})}};
counter.config={"data":undefined,"liveUpdates":{"enabled":true,"polling":{"timeout":10}},"infoMessages":{"layout":"compact"}};counter.templates.main="\x3cspan\x3e{data:count}\x3c/span\x3e";counter.methods._getRequestObject=function(overrides){return Echo.StreamServer.API.request($.extend(true,{"endpoint":"count","data":{"q":this.config.get("query"),"appkey":this.config.get("appkey")},"liveUpdates":this.config.get("liveUpdates"),"secure":this.config.get("useSecureAPI"),"apiBaseURL":this.config.get("apiBaseURL"),
"onError":$.proxy(this._error,this),"onData":$.proxy(this._handleResponse,this)},overrides))};counter.methods._maybeUpdate=function(data){if($.isEmptyObject(this.data)||this.data.count!==data.count){this.events.publish({"topic":"onUpdate","data":{"data":data,"query":this.config.get("query"),"target":this.config.get("target").get(0)}});this.set("data",data);this.render()}};counter.methods._handleResponse=function(data,options){this._maybeUpdate(data);if(options.requestType==="initial")this.ready()};
counter.methods._error=function(data,options){this.events.publish({"topic":"onError","data":{"data":data,"query":this.config.get("query"),"target":this.config.get("target").get(0)}});if(data.errorCode==="more_than"){this.set("data.count",data.errorMessage+"+");this.render()}else if(typeof options.critical==="undefined"||options.critical&&options.requestType==="initial")this.showMessage({"type":"error","data":data,"message":data.errorMessage});this.ready()};Echo.Control.create(counter)})(Echo.jQuery);
(function(jQuery){var $=jQuery;var pile=Echo.Control.manifest("Echo.StreamServer.Controls.FacePile");if(Echo.Control.isDefined(pile))return;pile.init=function(){if(!this.checkAppKey())return;var timeout=this.config.get("liveUpdates.timeout");if(typeof timeout!=="undefined")this.config.set("liveUpdates.polling.timeout",timeout);if($.isEmptyObject(this.get("data")))this._request();else{this.set("data.itemsPerPage",this.get("data.itemsPerPage",2));this.config.set("liveUpdates.enabled",false);this._initialResponseHandler(this.data)}};
pile.config={"data":undefined,"initialUsersCount":undefined,"totalUsersCount":undefined,"query":"","suffixText":"","item":{"avatar":true,"text":true},"liveUpdates":{"transport":"websockets","enabled":true,"polling":{"timeout":10},"websockets":{"maxConnectRetries":3,"serverPingInterval":30}},"infoMessages":{"layout":"compact"}};pile.vars={"users":[],"uniqueUsers":{},"isViewComplete":false,"moreRequestInProgress":false,"count":{"total":0,"visible":0}};pile.labels={"and":"and","more":"more"};pile.templates.main=
'\x3cspan class\x3d"{class:container}"\x3e'+'\x3cspan class\x3d"{class:actors}"\x3e\x3c/span\x3e'+'\x3cspan class\x3d"{class:more}"\x3e\x3c/span\x3e'+'\x3cspan class\x3d"{class:suffixText}"\x3e\x3c/span\x3e'+"\x3c/span\x3e";pile.renderers.more=function(element){var self=this;if(!this._isMoreButtonVisible())return element.hide();element.empty().show();var count=this.get("count.total")-this.get("count.visible");var caption=(count>0?count+" ":"")+this.labels.get("more");var linkable=!this._fromExternalData()||
this.get("count.visible")<this.get("users").length;if(linkable){var link=Echo.Utils.hyperlink({"caption":caption});element.addClass("echo-linkColor").append(link)}else element.removeClass("echo-linkColor").append(caption);this.set("moreRequestInProgress",false);if(linkable)element.one("click",function(){self._getMoreUsers()});return element};pile.renderers.actors=function(element){var self=this,usersDOM=[];var cssPrefix=this.get("cssPrefix");var item=this.config.get("item");if(!this.get("users").length||
!item.avatar&&!item.text)return element.empty();var action=item.avatar&&!item.text?"addClass":"removeClass";element[action](cssPrefix+"only-avatars");var wrap=function(text,name){return self.substitute({"template":"\x3cspan {data:classAttr}\x3e{data:text}\x3c/span\x3e","data":{"classAttr":name?'class\x3d"'+cssPrefix+name+'"':"","text":text}})};$.map(this.get("users").slice(0,this.get("count.visible")),function(user){usersDOM.push(user.instance.render())});var last;var delimiter=this.config.get("item.text")?
", ":"";if(!this._isMoreButtonVisible())last=usersDOM.pop();if(usersDOM.length){usersDOM=delimiter?this._intersperse(usersDOM,wrap(delimiter,"delimiter")):usersDOM;usersDOM.push(wrap("\x26nbsp;"+this.labels.get("and")+" ","and"))}if(!this._isMoreButtonVisible())usersDOM.push(last);$.map(usersDOM,function(chunk){element.append(chunk)});return element};pile.renderers.suffixText=function(element){return element.empty().append(this.config.get("suffixText",""))};pile.methods.getVisibleUsersCount=function(){return this.count.visible};
pile.methods._isMoreButtonVisible=function(){return!this._fromExternalData()&&!this.isViewComplete||this.count.visible<this.count.total};pile.methods._fromExternalData=function(){return!this.config.get("query")&&!!this.data};pile.methods._request=function(){var self=this;var request=this.get("request");if(!request){request=Echo.StreamServer.API.request({"endpoint":"search","data":{"q":this.config.get("query"),"appkey":this.config.get("appkey")},"liveUpdates":$.extend(this.config.get("liveUpdates"),
{"onData":function(data){self._secondaryResponseHandler(data)}}),"secure":this.config.get("useSecureAPI"),"apiBaseURL":this.config.get("apiBaseURL"),"onError":function(data,extra){var needShowError=typeof extra.critical==="undefined"||extra.critical&&extra.requestType==="initial";if(needShowError)self.showError(data,{"critical":extra.critical})},"onData":function(data,extra){self._initialResponseHandler(data)}});this.set("request",request)}request.send()};pile.methods._requestMoreItems=function(){var self=
this,query=this.config.get("query");var nextPageAfter=this.get("nextPageAfter");if(typeof nextPageAfter!=="undefined")query='pageAfter:"'+nextPageAfter+'" '+query;var request=Echo.StreamServer.API.request({"endpoint":"search","secure":this.config.get("useSecureAPI"),"apiBaseURL":this.config.get("apiBaseURL"),"data":{"q":query,"appkey":this.config.get("appkey")},"onError":function(data){self.showMessage({"type":"error","data":data})},"onData":function(data){self._initialResponseHandler(data)}});request.send()};
pile.methods._initialResponseHandler=function(data){if(data.itemsPerPage&&data.itemsPerPage!==this.config.get("itemsPerPage"))this.config.set("itemsPerPage",+data.itemsPerPage);if(this._fromExternalData())this.set("count.total",this.config.get("totalUsersCount",0));this.set("nextPageAfter",data.nextPageAfter);if(!data.entries.length){if(!this.get("isViewComplete")){this.set("isViewComplete",true);this.render();this.ready()}return}if(!this.get("count.visible"))this.set("count.visible",this._fromExternalData()?
this.config.get("initialUsersCount",this.config.get("itemsPerPage")):this.config.get("itemsPerPage"));this._processResponse(data)};pile.methods._secondaryResponseHandler=function(data){this._processResponse(data,true)};pile.methods._processResponse=function(data,isLive){var self=this,fetchMoreUsers=true;var actions=$.map(data.entries,function(entry){return function(callback){if(self._isRemoveAction(entry)){self._maybeRemoveItem(entry);callback()}else{if(self._isUniqueUser(entry))fetchMoreUsers=false;
var user=self.get("uniqueUsers."+entry.actor.id);if(user){user.itemsCount++;callback()}else self._initItem(entry,function(){self._updateStructure(this);callback()})}}});Echo.Utils.parallelCall(actions,function(){self._output(isLive,fetchMoreUsers)})};pile.methods._isRemoveAction=function(entry){return entry.verbs&&entry.verbs[0]==="http://activitystrea.ms/schema/1.0/delete"};pile.methods._output=function(isLive,fetchMoreUsers){if(this._fromExternalData())this.set("count.total",Math.max(this.get("users").length,
this.get("count.total")));else{this.set("count.total",this.get("users").length);this.set("count.visible",this.get("users").length)}this.set("count.visible",Math.min(this.get("count.visible"),this.get("users").length));if(!this.get("count.total"))this.set("isViewComplete",false);if(!isLive&&fetchMoreUsers)this._getMoreUsers();else{this.render();this.ready()}};pile.methods._isUniqueUser=function(entry){return!this.get("uniqueUsers."+entry.actor.id)};pile.methods._initItem=function(entry,callback){var config=
$.extend({"apiBaseURL":this.config.get("apiBaseURL"),"submissionProxyURL":this.config.get("submissionProxyURL"),"target":$("\x3cdiv\x3e"),"appkey":this.config.get("appkey"),"parent":this.config.getAsHash(),"plugins":this.config.get("plugins"),"context":this.config.get("context"),"useSecureAPI":this.config.get("useSecureAPI"),"data":entry.actor,"user":this.user,"ready":callback},this.config.get("item"));return new Echo.StreamServer.Controls.FacePile.Item(config)};pile.methods._updateStructure=function(item){this.set("uniqueUsers."+
item.get("data.id"),{"itemsCount":1,"instance":item});var user=this.get("uniqueUsers."+item.get("data.id"));this.get("users")[user.instance.isYou()?"unshift":"push"](user)};pile.methods._maybeRemoveItem=function(entry){var user=this.get("uniqueUsers."+entry.actor.id);if(!user||--user.itemsCount)return;var index;$.each(this.get("users"),function(i,u){if(u.instance.data.id===entry.actor.id){index=i;return false}});this.get("users").splice(index,1);this.remove("uniqueUsers."+entry.actor.id)};pile.methods._getMoreUsers=
function(){if(this._fromExternalData()){var usersLength=this.get("users").length;var currentVisible=this.get("count.visible");this.set("count.visible",currentVisible+=this.config.get("itemsPerPage"));if(this.get("count.visible")>usersLength)this.set("count.visible",usersLength);this.render()}else{if(!this.get("moreRequestInProgress")){this.showMessage({"type":"loading","target":this.view.get("more")});this.set("moreRequestInProgress",true)}this._requestMoreItems()}};pile.methods._intersperse=function(object,
separator){return Echo.Utils.foldl([],object,function(item,acc,key){if(acc.length)acc.push(separator);acc.push(item)})};pile.css=".{class:container} { line-height: 20px; vertical-align: middle; }"+".{class:more} { white-space: nowrap; }"+".{class:more}.echo-linkColor a, .{class:more}.echo-linkColor a:hover { color: #476CB8; text-decoration: underline; }"+".{class:more} .echo-control-message-icon { display: inline; margin: 0px 5px; }";Echo.Control.create(pile)})(Echo.jQuery);
(function(jQuery){var item=Echo.Control.manifest("Echo.StreamServer.Controls.FacePile.Item");if(Echo.Control.isDefined(item))return;item.config={"infoMessages":{"enabled":false}};item.labels={"you":"You"};item.templates.main='\x3cspan class\x3d"{class:container}"\x3e'+'\x3cspan class\x3d"{class:avatar}"\x3e\x3c/span\x3e'+'\x3cspan class\x3d"{class:title}"\x3e{data:title}\x3c/span\x3e'+"\x3c/span\x3e";item.renderers.avatar=function(element){if(this.config.get("avatar")){this.placeImage({"container":element,
"image":this.get("data.avatar"),"defaultImage":this.config.get("defaultAvatar")});if(!this.config.get("text"))element.attr("title",this.get("data.title"))}else element.hide();return element};item.renderers.title=function(element){if(this.config.get("text"))element.empty().append(this.isYou()?this.labels.get("you"):this.get("data.title"));else element.hide();return element};item.methods.isYou=function(){var id=this.get("data.id");return id&&id===this.user.get("identityUrl")};item.css=".{class:avatar} { display: inline-block; width: 16px; height: 16px; margin: 0px 3px 0px 0px; vertical-align: text-top; }"+
".{class:only-avatars} .{class:avatar} { margin: 0px 2px; }"+".{class:container}, .{class:container} span { white-space: nowrap; display: inline-block; }"+".{class:only-avatars} .{class:container} { white-space: normal; }";Echo.Control.create(item)})(Echo.jQuery);
(function(jQuery){var $=jQuery;var stream=Echo.Control.manifest("Echo.StreamServer.Controls.Stream");if(Echo.Control.isDefined(stream))return;stream.init=function(){var self=this;if(!this.checkAppKey())return;var timeout=this.config.get("liveUpdates.timeout");if(typeof timeout!=="undefined")this.config.set("liveUpdates.polling.timeout",timeout);this._recalcEffectsTimeouts();this.request=this._getRequestObject({"liveUpdates":$.extend(this.config.get("liveUpdates"),{"onData":function(data){self._handleLiveUpdatesResponse(data)}}),
"onOpen":function(data,options){if(options.requestType==="initial")self.showError({},{"retryIn":0,"request":self.request})},"onError":function(data,options){if(typeof options.critical==="undefined"||options.critical&&options.requestType==="initial")self.showError(data,$.extend(options,{"request":self.request}))},"onData":function(data,options){self._handleInitialResponse(data)}});var state=this.config.get("state.layout")==="full"?"paused":this.config.get("liveUpdates.enabled")?"live":"paused";this.activities.state=
state;var data=this.config.get("data");if(data){this._handleInitialResponse(data);this.request&&this.request.send({"skipInitialRequest":true,"data":{"q":this.config.get("query"),"appkey":this.config.get("appkey"),"since":data.nextSince}})}else this.request.send()};stream.destroy=function(){$.map(this.items,function(item){item.destroy()})};stream.config={"query":"","children":{"additionalItemsPerPage":5,"displaySortOrder":"chronological","sortOrder":"reverseChronological","moreButtonSlideTimeout":600,
"itemsSlideTimeout":600,"maxDepth":1},"fadeTimeout":2800,"flashColor":"#ffff99","item":{},"itemsPerPage":15,"itemsRefreshInterval":10,"itemsComparator":undefined,"liveUpdates":{"transport":"websockets","enabled":true,"polling":{"timeout":10},"websockets":{"maxConnectRetries":3,"serverPingInterval":30}},"openLinksInNewWindow":false,"slideTimeout":700,"sortOrder":"reverseChronological","state":{"label":{"icon":true,"text":true},"toggleBy":"mouseover","layout":"compact"},"asyncItemsRendering":false};
stream.config.normalizer={"showFlags":function(value){return"off"!==value},"state":function(object){object["toggleBy"]=object["toggleBy"]==="mouseover"&&Echo.Utils.isMobileDevice()?"button":object["toggleBy"];object["layout"]=object["toggleBy"]==="button"?object["layout"]:stream.config.state.layout;return object}};stream.vars={"activities":{"queue":[],"state":undefined,"lastState":"","animations":0},"itemParentConfig":undefined,"hasInitialData":false,"items":{},"threads":[],"lastRequest":null,"request":null,
"moreRequest":null,"itemsRenderingComplete":true};stream.labels={"guest":"Guest","live":"Live","paused":"Paused","more":"More","emptyStream":"No items at this time...","new":"new","newItem":"new item","newItems":"new items"};stream.events={"Echo.StreamServer.Controls.Stream.onItemsRenderingComplete":function(){this.view.render({"name":"more"});this._executeNextActivity()},"Echo.StreamServer.Controls.Stream.Item.onAdd":function(topic,data){var self=this;var item=this.items[data.item.data.unique];item.config.get("target").hide();
this.queueActivity({"action":"animation","item":item,"priority":"highest","handler":function(){item.render();item.set("added",false);self._animateSpotUpdate("add",item,data.config)}});return{"stop":["bubble"]}},"Echo.StreamServer.Controls.Stream.Item.onDelete":function(topic,data){var self=this;var item=this.items[data.item.data.unique];this.queueActivity({"action":"animation","item":item,"priority":"highest","handler":function(){item.set("deleted",false);self._animateSpotUpdate("remove",item,data.config)}});
return{"stop":["bubble"]}},"Echo.StreamServer.Controls.Stream.Item.onChildrenExpand":function(topic,args){this._requestChildrenItems(args.data.unique);return{"stop":["bubble"]}}};stream.templates.main='\x3cdiv class\x3d"{class:container} echo-primaryFont echo-primaryBackgroundColor"\x3e'+'\x3cdiv class\x3d"{class:header}"\x3e'+'\x3cdiv class\x3d"{class:state}"\x3e\x3c/div\x3e'+'\x3cdiv class\x3d"echo-clear"\x3e\x3c/div\x3e'+"\x3c/div\x3e"+'\x3cdiv class\x3d"{class:content}"\x3e'+'\x3cdiv class\x3d"{class:body}"\x3e\x3c/div\x3e'+
'\x3cdiv class\x3d"{class:more}"\x3e\x3c/div\x3e'+"\x3c/div\x3e"+"\x3c/div\x3e";stream.renderers.body=function(element){var request=this.lastRequest;if(!request)return element;if(request.data.length){if(request.initial)element.empty();this._appendRootItems(request.data,element)}else this.showMessage({"type":"info","message":this.labels.get("emptyStream"),"target":element});return element};stream.renderers.content=function(element){var self=this,request=this.lastRequest;if(request&&request.initial&&
this.config.get("liveUpdates.enabled")&&this.config.get("state.toggleBy")==="mouseover")element.hover(function(){self.setState("paused")},function(){self.setState("live")});return element};stream.renderers.state=function(element){var self=this;var label=this.config.get("state.label");var layout=this.config.get("state.layout");if(!label.icon&&!label.text||!this.config.get("liveUpdates.enabled"))return element;var state=this.getState();var activitiesCount=0;if(state==="paused")activitiesCount=Echo.Utils.foldl(0,
this.activities.queue,function(entry,acc){if(entry.affectCounter)return++acc});var currentState=state+activitiesCount;if(currentState===this.activities.lastState)return element;element.empty().show();element.addClass(this.cssPrefix+layout+"StateLayout");if(layout==="compact")element.addClass("echo-secondaryColor");if(!this.activities.lastState&&this.config.get("state.toggleBy")==="button"){if(layout==="compact")element.addClass("echo-linkColor echo-clickable");element.click(function(){self.setState(self.getState()===
"paused"?"live":"paused")})}var templates={"picture":'\x3cspan class\x3d"{class:state-picture} {class:state-picture}-'+state+'"\x3e\x3c/span\x3e',"message":this.config.get("state.toggleBy")==="button"?'\x3ca href\x3d"javascript:void(0)" class\x3d"{class:state-message}"\x3e'+"{label:"+state+"}"+"\x3c/a\x3e":'\x3cspan class\x3d"{class:state-message}"\x3e{label:'+state+"}\x3c/span\x3e","count":' \x3cspan class\x3d"{class:state-count}"\x3e({data:count} {label:new})\x3c/span\x3e',"button":'\x3cspan class\x3d"{class:state-message}"\x3e{data:count} {data:label}\x3c/span\x3e'};
if(layout==="full")if(activitiesCount)element.append(this.substitute({"template":templates.button,"data":{"count":activitiesCount,"label":this.labels.get(activitiesCount===1?"newItem":"newItems")}}));else element.hide();else{if(label.icon)element.append(this.substitute({"template":templates.picture}));if(label.text){element.append(this.substitute({"template":templates.message}));if(activitiesCount&&state==="paused")element.append(this.substitute({"template":templates.count,"data":{"count":activitiesCount}}))}}this.activities.lastState=
currentState;return element};stream.renderers.more=function(element){var self=this;if(this.isViewComplete||!this.threads.length)return element.empty().hide();if(!this.itemsRenderingComplete)element.hide();else element.show();return element.empty().append(this.labels.get("more")).off("click").one("click",function(){self.events.publish({"topic":"onMoreButtonPress"});element.html(self.labels.get("loading"));self._requestMoreItems(element)})};stream.methods.getState=function(){return this.activities.state};
stream.methods.setState=function(state){this.activities.state=state;if(state==="live")this._executeNextActivity();this.view.render({"name":"state"})};stream.methods.queueActivity=function(params){if(!params.item)return;var actorID=params.item.get("data.actor.id");var byCurrentUser=params.item.blocked||actorID&&this.user.has("identity",actorID);var index=this._getActivityProjectedIndex(byCurrentUser,params);var data={"action":params.action,"item":params.item,"affectCounter":params.action==="add"&&
!byCurrentUser,"priority":params.priority,"byCurrentUser":byCurrentUser,"handler":params.handler};if(typeof index!=="undefined")this.activities.queue.splice(index,0,data);else this.activities.queue.push(data)};stream.methods._requestChildrenItems=function(unique){var self=this;var item=this.items[unique];var target=item.view.get("expandChildren");var request=this._getRequestObject({"data":{"q":this._constructChildrenSearchQuery(item)},"onOpen":function(){self.showError({},{"retryIn":0,"target":target,
"request":request})},"onError":function(data,options){self.showError(data,$.extend(options,{"target":target,"request":request}))},"onData":function(data){item.set("data.nextPageAfter",data.nextPageAfter);item.set("data.hasMoreChildren",data.hasMoreChildren);data.entries=self._actualizeChildrenList(item,data.entries);self._onDataReceive(data,"children",function(items){var children=[];$.map(data.entries,function(entry){var child=items[entry.unique];self._applyStructureUpdates("add",child);if(entry.parentUnique===
item.get("data.unique"))children.push(child)});self._placeChildItems(item,children)})}});request.send()};stream.methods._requestInitialItems=function(){var self=this;if(!this.request)this.request=Echo.StreamServer.API.request({"endpoint":"search","apiBaseURL":this.config.get("apiBaseURL"),"liveUpdates":$.extend(this.config.get("liveUpdates"),{"onData":function(data){self._handleLiveUpdatesResponse(data)}}),"data":{"q":this.config.get("query"),"appkey":this.config.get("appkey")},"onOpen":function(data,
options){if(options.requestType==="initial")self.showError({},{"retryIn":0,"request":self.request})},"onError":function(data,options){if(typeof options.critical==="undefined"||options.critical&&options.requestType==="initial")self.showError(data,$.extend(options,{"request":self.request}))},"onData":function(data,options){self._handleInitialResponse(data)}});this.request.send()};stream.methods._requestMoreItems=function(element){var self=this;this.lastRequest={"initial":false};if(!this.moreRequest)this.moreRequest=
this._getRequestObject({"onOpen":function(){self.showError({},{"retryIn":0,"target":element,"request":self.moreRequest})},"onError":function(data,options){self.showError(data,$.extend(options,{"target":element,"request":self.moreRequest}))},"onData":function(data){self._handleInitialResponse(data,function(data){if(data.length){self.lastRequest.data=data;self.view.render({"name":"body"});self.view.render({"name":"more"})}else element.html(self.labels.get("emptyStream")).delay(1E3).fadeOut(1E3)})}});
this.moreRequest.requestType="initial";this.moreRequest.send({"data":{"q":this.config.get("query")+" pageAfter:"+'"'+this.get("nextPageAfter","0")+'"',"appkey":this.config.get("appkey")}})};stream.methods._onDataReceive=function(data,type,callback){var self=this;var items={};this.events.publish({"topic":"onDataReceive","data":{"entries":data.entries,"type":type},"propagation":false});var actions=$.map(data.entries,function(entry){return function(cb){self._initItem(entry,false,function(){items[this.get("data.unique")]=
this;cb()})}});Echo.Utils.parallelCall(actions,function(){callback(items)})};stream.methods._prepareEventParams=function(params){return $.extend(params,{"target":this.config.get("target").get(0),"query":this.config.get("query")})};stream.methods._applyLiveUpdates=function(entries,callback){var self=this,data={};data.entries=$.map(entries||[],function(entry){return self._normalizeEntry(entry)});this.events.publish({"topic":"onDataReceive","data":{"entries":data.entries,"type":"live"},"propagation":false});
var actions=$.map(data.entries,function(entry){return function(_callback){var item=self.items[entry.unique];var action=self._classifyAction(entry);if(!item&&action!=="post"){_callback();return}if(action==="post"){if(item){self._applySpotUpdates("replace",self._updateItem(entry));_callback();return}self._initItem(entry,true,function(){item=this;var satisfies=item.isRoot()?self._withinVisibleFrame(item):self._withinVisibleChildrenFrame(item);if(!satisfies&&!item.isRoot()&&self.user.has("identity",item.data.actor.id))item.set("byCurrentUser",
true);if(satisfies||item.get("byCurrentUser")){self.events.publish({"topic":"onItemReceive","data":{"item":{"data":item.data}},"propagation":false});self._applySpotUpdates("add",item)}else item.destroy();_callback()});return}if(action==="delete"){self._applySpotUpdates("remove",item);_callback()}}});Echo.Utils.sequentialCall(actions,function(){self._recalcEffectsTimeouts();callback&&callback.call(self)})};stream.methods._actualizeChildrenList=function(parent,entries){var self=this;return $.map(entries,
function(entry){entry.targets=$.map(entry.targets,function(target){target.conversationID=parent.get("data.target.conversationID");return target});entry=self._normalizeEntry(entry);var item=self.items[entry.unique];if(item&&item.get("byCurrentUser"))self._applyStructureUpdates("delete",item);return entry})};stream.methods._createChildrenItemsDomWrapper=function(children,parent){var self=this;var wrapper=$('\x3cdiv class\x3d"'+this.get("cssPrefix")+'children-wrapper"\x3e\x3c/div\x3e');var getIdx=function(item){return self._getItemListIndex(item,
parent.get("children"))};$.each(children,function(i,item){var insertion=i>0&&getIdx(children[i-1])<getIdx(item)?"append":"prepend";wrapper[insertion](item.config.get("target"));item.render()});return wrapper};stream.methods._extractPresentationConfig=function(data){var keys=["sortOrder","itemsPerPage","safeHTML","showFlags"];return Echo.Utils.foldl({},keys,function(key,acc){if(typeof data[key]!=="undefined")acc[key]=data[key]})};stream.methods._extractTimeframeConfig=function(data){var getComparator=
function(value){var match=value.match(/^(<|>)(.*)$/);var operation=match[1];value=match[2].match(/^'([0-9]+) seconds ago'$/);var getTS=value?function(){return Math.floor((new Date).getTime()/1E3)-value[1]}:function(){return match[2]};if(operation==="\x3c")return function(ts){return ts<getTS()};if(operation==="\x3e")return function(ts){return ts>getTS()}};var timeframe=Echo.Utils.foldl([],["before","after"],function(key,acc){if(!data[key])return;var cmp=getComparator(data[key]);if(cmp)acc.push(cmp)});
return{"timeframe":timeframe}};stream.methods._getRespectiveAccumulator=function(item,sort){var accBySort={"likesDescending":"likesCount","flagsDescending":"flagsCount","repliesDescending":"repliesCount"};return item.getAccumulator(accBySort[sort])};stream.methods._appendRootItems=function(items,container){var self=this;if(!items||!items.length)return;this.itemsRenderingComplete=false;(function renderer(index){index=index||0;container.append(items[index].config.get("target"));items[index].render();
if(items.length>++index)if(self.config.get("asyncItemsRendering"))setTimeout($.proxy(renderer,self,index),0);else renderer(index);else{self.itemsRenderingComplete=true;self.events.publish({"topic":"onItemsRenderingComplete","global":false,"propagation":false})}})()};stream.methods._constructChildrenSearchQuery=function(item){var depth=this.config.get("children.maxDepth")-item.get("depth")-1;var additionalItems=+this.config.get("children.additionalItemsPerPage");var pageAfter=item.getNextPageAfter();
var filter=this.config.get("children.filter");var filterQuery=!filter||filter==="()"?"":filter+" ";return filterQuery+Echo.Utils.foldl("",{"childrenof":item.get("data.object.id"),"children":depth,"childrenItemsPerPage":depth?+this.config.get("children.itemsPerPage"):0,"itemsPerPage":additionalItems,"sortOrder":this.config.get("children.sortOrder"),"childrenSortOrder":this.config.get("children.sortOrder"),"pageAfter":pageAfter?'"'+(pageAfter||0)+'"':undefined,"safeHTML":this.config.get("safeHTML")},
function(value,acc,predicate){return acc+=typeof value!=="undefined"?predicate+":"+value+" ":""})+filterQuery};stream.methods._handleInitialResponse=function(data,visualizer){var self=this,roots=[];this.config.get("target").show();this.nextSince=data.nextSince||0;this.nextPageAfter=data.nextPageAfter;var presentation=this._extractPresentationConfig(data);presentation.itemsPerPage=+presentation.itemsPerPage;this.config.extend(presentation);data.entries=data.entries||[];data.children.itemsPerPage=+data.children.itemsPerPage;
data.children.maxDepth=+data.children.maxDepth;this.config.set("children",$.extend(this.config.get("children"),data.children));this.config.extend(this._extractTimeframeConfig(data));var sortOrder=this.config.get("sortOrder");data.entries=$.map(data.entries,function(entry){return self._normalizeEntry(entry)});var receivedDataType=this.hasInitialData?"more":"initial";this._onDataReceive(data,receivedDataType,function(items){$.map(data.entries,function(entry){var item=items[entry.unique];self._applyStructureUpdates("add",
item);if(item.isRoot())self._addItemToList(roots,item,sortOrder)});self.hasInitialData=true;self.isViewComplete=data.hasMoreChildren?data.hasMoreChildren==="false":roots.length!==self.config.get("itemsPerPage");(visualizer||function(data){self.lastRequest={"initial":true,"data":data};self.render();self.ready()})(roots);if(self.itemsRefreshInterval)clearInterval(self.itemsRefreshInterval);self.itemsRefreshInterval=setInterval(function(){self._refreshItemsDate();self._checkTimeframeSatisfy()},self.config.get("itemsRefreshInterval")*
1E3)})};stream.methods._checkTimeframeSatisfy=function(){var self=this;var timeframe=this.config.get("timeframe");if(!timeframe||!timeframe.length)return;var unsatisfying=Echo.Utils.foldl([],this.threads,function(thread,acc){var satisfy=Echo.Utils.foldl(true,timeframe,function(p,a){return a?p(thread.get("timestamp")):false});if(!satisfy)acc.push(thread)});$.map(unsatisfying,function(item){self._applySpotUpdates("remove",item)})};stream.methods._handleLiveUpdatesResponse=function(data){var self=this;
data=data||{};this._applyLiveUpdates(data.entries,function(){self.view.render({"name":"state"});self._executeNextActivity()})};stream.methods._getRequestObject=function(overrides){var config=$.extend(true,{"endpoint":"search","secure":this.config.get("useSecureAPI"),"apiBaseURL":this.config.get("apiBaseURL"),"data":{"q":this.config.get("query"),"appkey":this.config.get("appkey")}},overrides);return Echo.StreamServer.API.request(config)};stream.methods._recalcEffectsTimeouts=function(){var s=this;
var maxTimeouts={"fade":s.config.get("fadeTimeout"),"slide":s.config.get("slideTimeout")};s.timeouts=s.timeouts||{"fade":maxTimeouts.fade,"slide":maxTimeouts.slide};if(!maxTimeouts.fade&&!maxTimeouts.slide)return;s.timeouts.coeff=s.timeouts.coeff||{"fade":s.timeouts.fade/(maxTimeouts.fade+maxTimeouts.slide),"slide":s.timeouts.slide/(maxTimeouts.fade+maxTimeouts.slide)};var calc=function(timeout,value){value=Math.round(value*s.timeouts.coeff[timeout]);if(value<100)return 0;if(value>maxTimeouts[timeout])return maxTimeouts[timeout];
return value};var frame=s.config.get("liveUpdates.polling.timeout")*1E3*.8;var msPerItem=s.activities.queue.length?frame/s.activities.queue.length:frame;s.timeouts.fade=calc("fade",msPerItem);s.timeouts.slide=calc("slide",msPerItem)};stream.methods._refreshItemsDate=function(){$.map(this.threads,function(item){item.view.render({"name":"date"});item.traverse(item.get("children"),function(child){child.view.render({"name":"date"})})})};stream.methods._executeNextActivity=function(){var acts=this.activities;
if(!acts.queue.length&&this.config.get("state.layout")==="full")acts.state="paused";if(acts.animations>0||!this.itemsRenderingComplete||!acts.queue.length||this.config.get("liveUpdates.enabled")&&acts.state==="paused"&&acts.queue[0].action!=="replace"&&!acts.queue[0].byCurrentUser)return;acts.queue.shift().handler()};stream.methods._spotUpdates={"animate":{}};stream.methods._spotUpdates.add=function(item,options){var _item=this.items[item.get("data.unique")];if(_item&&_item.view.rendered()&&options.priority!==
"high"){this._applySpotUpdates("replace",this._updateItem(item.get("data")),{"priority":"highest"});item.destroy();return}this._applyStructureUpdates("add",item);item.set("added",true);if(item.isRoot())this._placeRootItem(item);else{var parent=this._getParentItem(item);if(parent&&parent.view.rendered()){parent.view.render({"name":"container"});parent.view.render({"name":"children"});parent.view.render({"name":"childrenByCurrentActorLive"})}}};stream.methods._spotUpdates.replace=function(item,options){item.unblock();
if(this._maybeMoveItem(item)){var parent=this._getParentItem(item);var sort=this.config.get(parent?"children.sortOrder":"sortOrder");var items=parent?parent.get("children"):this.threads;var oldIdx=this._getItemListIndex(item,items);var container=$.extend([],items);container.splice(oldIdx,1);var newIdx=this._getItemProjectedIndex(item,container,sort);if(oldIdx!==newIdx){this._applySpotUpdates("remove",item,{"keepChildren":true,"priority":"high"});this._applySpotUpdates("add",item,{"priority":"high"})}}if(item&&
item.view.rendered()){item.view.render({"name":"container","recursive":true});item.events.publish({"topic":"onRerender"})}};stream.methods._spotUpdates.remove=function(item,options){item.set("deleted",true);if(item.isRoot())item.events.publish({"topic":"onDelete","data":{"config":options},"global":false,"propagation":false});else{var parent=this._getParentItem(item);if(parent){parent.view.render({"name":"children","target":parent.view.get("children"),"extra":options});parent.view.render({"name":"childrenByCurrentActorLive",
"target":parent.view.get("childrenByCurrentActorLive"),"extra":options});parent.view.render({"name":"container"})}}};stream.methods._spotUpdates.animate.fade=function(item){var self=this;if(this.timeouts.fade){var interval=Math.round(this.timeouts.fade/2);var container=item.view.get("container");var originalBGColor=Echo.Utils.getVisibleColor(container);var transition="background-color "+interval+"ms linear";container.css("background-color",this.config.get("flashColor"));setTimeout(function(){container.css({"transition":transition,
"-o-transition":transition,"-ms-transition":transition,"-moz-transition":transition,"-webkit-transition":transition,"background-color":originalBGColor});container.css("background-color","");self.activities.animations--;self._executeNextActivity()},interval)}else{this.activities.animations--;this._executeNextActivity()}};stream.methods._spotUpdates.animate.add=function(item){var self=this;this.activities.animations++;if(this.timeouts.slide){var height=item.config.get("target").show().css("height");
item.config.get("target").css("overflow","hidden");item.view.get("content").css("margin-top","-"+height).animate({"margin-top":"0px"},this.timeouts.slide,function(){item.config.get("target").css("overflow","");item.view.get("content").css("margin-top","");self._spotUpdates.animate.fade.call(self,item)})}else{item.config.get("target").show();self._spotUpdates.animate.fade.call(self,item)}};stream.methods._spotUpdates.animate.remove=function(item,config){var self=this;this.activities.animations++;config=
config||{};var callback=$.isFunction(config)?config:config.callback||function(){if(!item.config.get("target").length)return;item.config.get("target")[config.keepChildren?"detach":"remove"]();var itemsCount=Echo.Utils.foldl(0,self.items,function(_item,acc){return acc+1});if(!itemsCount)self.showMessage({"type":"info","message":self.labels.get("emptyStream"),"target":self.view.get("body")});self._applyStructureUpdates("delete",item,config);self.activities.animations--;self._executeNextActivity()};if(this.timeouts.slide)item.config.get("target").slideUp(this.timeouts.slide,
callback);else callback()};stream.methods._applySpotUpdates=function(action,item,options){var self=this;options=options||{};this.queueActivity({"action":action,"item":item,"priority":options.priority,"handler":function(){self._spotUpdates[action].call(self,item,options);self._executeNextActivity()}})};stream.methods._animateSpotUpdate=function(action,item,options){this._spotUpdates.animate[action].call(this,item,options)};stream.methods._getActivityProjectedIndex=function(byCurrentUser,params){var priorityWeights=
{"highest":0,"high":10,"medium":20,"low":30,"lowest":40};params.priority=params.priority==="highest"&&"highest"||byCurrentUser&&"high"||params.action==="replace"&&"medium"||params.priority||"lowest";var index;if(params.action==="replace")$.each(this.activities.queue,function(i,activity){if(activity.action==="add"&&activity.itemUnique===params.itemUnique){params.priority=activity.priority;return false}});$.each(this.activities.queue,function(i,activity){if(priorityWeights[params.priority]<priorityWeights[activity.priority]){index=
i;return false}});return index};stream.methods._classifyAction=function(entry){return entry.verbs[0]==="http://activitystrea.ms/schema/1.0/delete"?"delete":"post"};stream.methods._maybeMoveItem=function(item){return item.get("forceInject")};stream.methods._withinVisibleFrame=function(item,items,isViewComplete,sortOrder){items=items||this.threads;isViewComplete=typeof isViewComplete==="undefined"?this.isViewComplete:isViewComplete;sortOrder=sortOrder||this.config.get("sortOrder");if(isViewComplete||
!items.length)return true;return this._itemsComparator(items[items.length-1],item,sortOrder)===1};stream.methods._withinVisibleChildrenFrame=function(item){var parent=this._getParentItem(item)||this._getParentItemFromActivityQueue(item);if(!parent)return false;return this._withinVisibleFrame(item,parent.get("children"),!parent.hasMoreChildren(),this.config.get("children.sortOrder"))};stream.methods._getParentItemFromActivityQueue=function(item){if(item.isRoot())return;return Echo.Utils.safelyExecute(function(queue){var parent;
$.each(queue,function(i,activity){if(activity.action==="add"&&activity.item.get("data.unique")===item.get("data.parentUnique")){parent=activity.item;return false}});return parent},[this.activities.queue])};stream.methods._getParentItem=function(item){return item.isRoot()?undefined:this.items[item.get("data.parentUnique")]};stream.methods._itemsComparator=function(listedItem,newItem,sort){var self=this,result;var customComparator=this.config.get("itemsComparator");if(customComparator&&$.isFunction(customComparator))return customComparator(listedItem,
newItem,sort);switch(sort){case "chronological":result=listedItem.get("timestamp")>newItem.get("timestamp");break;case "reverseChronological":result=listedItem.get("timestamp")<=newItem.get("timestamp");break;case "likesDescending":case "repliesDescending":case "flagsDescending":var getCount=function(entry){return self._getRespectiveAccumulator(entry,sort)};result=getCount(listedItem)<getCount(newItem)||getCount(listedItem)===getCount(newItem)&&this._itemsComparator(listedItem,newItem,"reverseChronological")===
1;break}return result?1:typeof result==="undefined"?0:-1};stream.methods._placeRootItem=function(item){var content=item.config.get("target");if(this.threads.length>1){var id=this._getItemListIndex(item,this.threads);var next=this.threads[id+1],prev=this.threads[id-1];if(next)next.config.get("target").before(content);else prev.config.get("target").after(content)}else this.view.get("body").empty().append(content);item.events.publish({"topic":"onAdd","global":false,"propagation":false})};stream.methods._placeChildItems=
function(parent,children){var self=this;var itemsWrapper=this._createChildrenItemsDomWrapper(children,parent);var targetItemIdx=-1;$.each(parent.get("children"),function(i,_item){if(self._isItemInList(_item,children)){targetItemIdx=i-1;return false}});var targetItemDom=targetItemIdx>=0?parent.get("children")[targetItemIdx].config.get("target"):parent.view.get("children");var action=targetItemIdx>=0?"insertAfter":this.config.get("children.sortOrder")!=="chronological"?"prependTo":"appendTo";itemsWrapper[action]($(targetItemDom));
parent.view.render({"name":"childrenByCurrentActorLive"});itemsWrapper.css("height",itemsWrapper.show().css("height")).hide().animate({"height":"show","marginTop":"show","marginBottom":"show","paddingTop":"show","paddingBottom":"show"},{"duration":this.config.get("children.itemsSlideTimeout"),"complete":function(){itemsWrapper.css("height","");parent.view.render({"name":"expandChildren"});parent.view.render({"name":"expandChildrenLabel"});itemsWrapper.children().unwrap()}})};stream.methods._getItemListIndex=
function(item,items){var idx=-1;$.each(items||[],function(i,entry){if(entry.get("data.unique")===item.get("data.unique")){idx=i;return false}});return idx};stream.methods._isItemInList=function(item,items){return this._getItemListIndex(item,items)>=0};stream.methods._initItem=function(entry,isLive,callback){if(!this.itemParentConfig)this.itemParentConfig=this.config.getAsHash();var config=$.extend({"target":$("\x3cdiv\x3e"),"appkey":this.config.get("appkey"),"plugins":this.config.get("plugins"),"context":this.config.get("context"),
"useSecureAPI":this.config.get("useSecureAPI"),"apiBaseURL":this.config.get("apiBaseURL"),"submissionProxyURL":this.config.get("submissionProxyURL"),"user":this.user,"live":isLive,"ready":callback},this.itemParentConfig.item);config.parent=this.itemParentConfig;config.data=this._normalizeEntry(entry);var init=function(){new Echo.StreamServer.Controls.Stream.Item(config)};this.config.get("asyncItemsRendering")?setTimeout(init,0):init()};stream.methods._updateItem=function(entry){var item=this.items[entry.unique];
var sortOrder=this.config.get(item.isRoot()?"sortOrder":"children.sortOrder");var accRelatedSortOrder=sortOrder.match(/replies|likes|flags/);var acc=accRelatedSortOrder&&this._getRespectiveAccumulator(item,sortOrder);if(item.data.object.published!==entry.object.published){item.set("timestamp",Echo.Utils.timestampFromW3CDTF(entry.object.published));item.set("forceInject",true)}$.extend(item.data,entry);if(accRelatedSortOrder)if(this._getRespectiveAccumulator(item,sortOrder)!==acc)item.set("forceInject",
true);return item};stream.methods._getItemProjectedIndex=function(item,items,sort){var self=this;var index;if(item.config.get("live")||item.get("forceInject"))$.each(items||[],function(i,entry){if(self._itemsComparator(entry,item,sort)===1){index=i;return false}});return typeof index!=="undefined"?index:items.length};stream.methods._addItemToList=function(items,item,sort){if(this.config.get("itemsComparator"))item.set("forceInject",true);items.splice(this._getItemProjectedIndex(item,items,sort),0,
item);item.set("forceInject",false);this.items[item.get("data.unique")]=item};stream.methods._applyStructureUpdates=function(action,item,options){var self=this;var parent;options=options||{};switch(action){case "add":this.items[item.get("data.unique")]=item;if(!item.isRoot()){parent=this._getParentItem(item);if(!parent){delete this.items[item.get("data.unique")];return}item.set("depth",parent.get("depth")+1);parent.set("threading",true);item.set("forceInject",true);this._addItemToList(parent.get("children"),
item,this.config.get("children.displaySortOrder"))}else this._addItemToList(this.threads,item,this.config.get("sortOrder"));break;case "delete":var container=item.isRoot()?this.threads:this.items[item.get("data.parentUnique")].get("children");if(!item.isRoot()&&container.length===1){parent=this._getParentItem(item);if(parent)parent.set("threading",false)}container.splice(this._getItemListIndex(item,container),1);if(!options.keepChildren){var itemIndex=this._getItemListIndex(item,this.lastRequest.data);
this.lastRequest.data.splice(itemIndex,1);item.traverse(item.get("children"),function(child){delete self.items[child.get("data.unique")];child.destroy()});item.destroy();item.set("children",[])}delete this.items[item.get("data.unique")];break}};stream.methods._normalizeEntry=function(entry){if(entry.normalized)return entry;var self=this;entry.normalized=true;$.each(entry.targets||[],function(i,target){if(target.id===target.conversationID||target.id===entry.object.id||self.items[target.id+target.conversationID])entry.target=
target});entry.object.content_type=entry.object.content_type||"text";entry.object.accumulators=entry.object.accumulators||{};$.each(["repliesCount","flagsCount","likesCount"],function(i,name){entry.object.accumulators[name]=parseInt(entry.object.accumulators[name]||"0")});entry.object.context=entry.object.context||[];entry.object.flags=entry.object.flags||[];entry.object.likes=entry.object.likes||[];entry.target=entry.target||entry.targets[0]||{};entry.target.conversationID=entry.target.conversationID||
entry.object.id;entry.source=entry.source||{};entry.provider=entry.provider||{};entry.unique=entry.object.id+entry.target.conversationID;entry.parentUnique=entry.target.id+entry.target.conversationID;return entry};stream.css=".{class:message-wrapper} { padding: 15px 0px; text-align: center; -moz-border-radius: 0.5em; -webkit-border-radius: 0.5em; border: 1px solid #E4E4E4; }"+".{class:message-empty}, .{class:message-loading}, .{class:message-error} { display: inline-block; height: 16px; padding-left: 21px; background: no-repeat left center; }"+
".{class:message-empty} { background-image: url({config:cdnBaseURL.sdk-assets}/images/information.png); }"+".{class:message-loading} { background-image: url({config:cdnBaseURL.sdk-assets}/images/loading.gif); }"+".{class:message-error} { background-image: url({config:cdnBaseURL.sdk-assets}/images/warning.gif); }"+".{class:header} { margin: 10px 0px 10px 0px; }"+".{class:compactStateLayout} { float: right; }"+".{class:fullStateLayout} { text-align: center; }"+".{class:state-picture} { display: inline-block; height: 9px; width: 8px; }"+
".{class:state-picture-paused} { background: url({config:cdnBaseURL.sdk-assets}/images/control_pause.png) no-repeat center center; }"+".{class:state-picture-live} { background: url({config:cdnBaseURL.sdk-assets}/images/control_play.png) no-repeat center center; }"+".{class:state-message} { margin-left: 5px; text-decoration: none; }"+".echo-clickable a.{class:state-message}:hover { text-decoration: underline; }"+".{class:more}:hover, .{class:fullStateLayout}:hover { background-color: #E4E4E4; }"+".{class:more}, .{class:fullStateLayout} { text-align: center; border: solid 1px #E4E4E4; margin-top: 10px; padding: 10px; -moz-border-radius: 0.5em; -webkit-border-radius: 0.5em; cursor: pointer; font-weight: bold; }"+
".{class:more} .echo-app-message { padding: 0; border: none; border-radius: 0; }";Echo.Control.create(stream)})(Echo.jQuery);
(function(jQuery){var $=jQuery;var item=Echo.Control.manifest("Echo.StreamServer.Controls.Stream.Item");if(Echo.Control.isDefined(item))return;item.init=function(){this.timestamp=Echo.Utils.timestampFromW3CDTF(this.get("data.object.published"));this.ready()};item.config={"aggressiveSanitization":false,"buttonsOrder":undefined,"contentTransformations":{"text":["smileys","urls","newlines"],"html":["smileys","urls","newlines"],"xhtml":["smileys","urls"]},"infoMessages":{"enabled":false},"limits":{"maxBodyCharacters":undefined,
"maxBodyLines":undefined,"maxBodyLinkLength":50,"maxMarkerLength":16,"maxReLinkLength":30,"maxReTitleLength":143,"maxTagLength":16},"optimizedContext":true,"providerIcon":Echo.Loader.getURL("images/favicons/comments.png",false),"reTag":true,"viaLabel":{"icon":false,"text":false}};item.config.normalizer={"contentTransformations":function(object){$.each(object,function(contentType,options){object[contentType]=Echo.Utils.foldl({},options||[],function(option,acc){acc[option]=true})});return object}};
item.vars={"children":[],"depth":0,"threading":false,"textExpanded":false,"timestamp":undefined,"blocked":false,"buttonsOrder":[],"buttonSpecs":{},"buttons":{}};item.labels={"defaultModeSwitchTitle":"Switch to metadata view","guest":"Guest","metadataModeSwitchTitle":"Return to default view","sharedThisOn":"I shared this on {service}...","userID":"User ID:","userIP":"User IP:","textToggleTruncatedMore":"more","textToggleTruncatedLess":"less","fromLabel":"from","viaLabel":"via","childrenMoreItems":"View more items",
"re":"Re"};item.templates.metadata={"userID":'\x3cdiv class\x3d"{class:metadata-userID}"\x3e'+'\x3cspan class\x3d"{class:metadata-title} {class:metadata-icon}"\x3e'+"{label:userID}"+"\x3c/span\x3e"+'\x3cspan class\x3d"{class:metadata-value}"\x3e{data:actor.id}\x3c/span\x3e'+"\x3c/div\x3e","userIP":'\x3cdiv class\x3d"{class:metadata-userIP}"\x3e'+'\x3cspan class\x3d"{class:metadata-title} {class:metadata-icon}"\x3e'+"{label:userIP}"+"\x3c/span\x3e"+'\x3cspan class\x3d"{class:metadata-value}"\x3e{data:ip}\x3c/span\x3e'+
"\x3c/div\x3e"};item.templates.mainHeader='\x3cdiv class\x3d"{class:content}"\x3e'+'\x3cdiv class\x3d"{class:container}"\x3e'+'\x3cdiv class\x3d"{class:avatar-wrapper}"\x3e'+'\x3cdiv class\x3d"{class:avatar}"\x3e\x3c/div\x3e'+"\x3c/div\x3e"+'\x3cdiv class\x3d"{class:wrapper}"\x3e'+'\x3cdiv class\x3d"{class:subwrapper}"\x3e'+'\x3cdiv class\x3d"{class:subcontainer}"\x3e'+'\x3cdiv class\x3d"{class:frame}"\x3e'+'\x3cdiv class\x3d"{class:modeSwitch} echo-clickable"\x3e\x3c/div\x3e'+'\x3cdiv class\x3d"{class:authorName} echo-linkColor"\x3e\x3c/div\x3e'+
'\x3cdiv class\x3d"echo-clear"\x3e\x3c/div\x3e'+'\x3cdiv class\x3d"{class:data}"\x3e'+'\x3cdiv class\x3d"{class:re}"\x3e\x3c/div\x3e'+'\x3cdiv class\x3d"{class:body} echo-primaryColor"\x3e '+'\x3cspan class\x3d"{class:text}"\x3e\x3c/span\x3e'+'\x3cspan class\x3d"{class:textEllipses}"\x3e...\x3c/span\x3e'+'\x3cspan class\x3d"{class:textToggleTruncated} echo-linkColor echo-clickable"\x3e\x3c/span\x3e'+"\x3c/div\x3e"+'\x3cdiv class\x3d"{class:markers} echo-secondaryFont echo-secondaryColor"\x3e\x3c/div\x3e'+
'\x3cdiv class\x3d"{class:tags} echo-secondaryFont echo-secondaryColor"\x3e\x3c/div\x3e'+"\x3c/div\x3e"+'\x3cdiv class\x3d"{class:metadata}"\x3e\x3c/div\x3e'+'\x3cdiv class\x3d"{class:footer} echo-secondaryColor echo-secondaryFont"\x3e'+'\x3cimg class\x3d"{class:sourceIcon} echo-clickable"\x3e'+'\x3cdiv class\x3d"{class:date}"\x3e\x3c/div\x3e'+'\x3cdiv class\x3d"{class:from}"\x3e\x3c/div\x3e'+'\x3cdiv class\x3d"{class:via}"\x3e\x3c/div\x3e'+'\x3cdiv class\x3d"{class:buttons}"\x3e\x3c/div\x3e'+'\x3cdiv class\x3d"echo-clear"\x3e\x3c/div\x3e'+
"\x3c/div\x3e"+"\x3c/div\x3e"+"\x3c/div\x3e"+'\x3cdiv class\x3d"echo-clear"\x3e\x3c/div\x3e'+"\x3c/div\x3e"+"\x3c/div\x3e"+'\x3cdiv class\x3d"echo-clear"\x3e\x3c/div\x3e'+'\x3cdiv class\x3d"{class:childrenMarker}"\x3e\x3c/div\x3e'+"\x3c/div\x3e";item.templates.mainFooter='\x3cdiv class\x3d"{class:childrenByCurrentActorLive}"\x3e\x3c/div\x3e'+"\x3c/div\x3e";item.templates.childrenTop='\x3cdiv class\x3d"{class:children}"\x3e\x3c/div\x3e'+'\x3cdiv class\x3d"{class:expandChildren} {class:container-child} echo-trinaryBackgroundColor echo-clickable"\x3e'+
'\x3cspan class\x3d"{class:expandChildrenLabel} echo-message-icon"\x3e\x3c/span\x3e'+"\x3c/div\x3e";item.templates.childrenBottom='\x3cdiv class\x3d"{class:expandChildren} {class:container-child} echo-trinaryBackgroundColor echo-clickable"\x3e'+'\x3cspan class\x3d"{class:expandChildrenLabel} echo-message-icon"\x3e\x3c/span\x3e'+"\x3c/div\x3e"+'\x3cdiv class\x3d"{class:children}"\x3e\x3c/div\x3e';item.methods.template=function(){return this.templates.mainHeader+(this.config.get("parent.children.sortOrder")===
"chronological"?this.templates.childrenTop:this.templates.childrenBottom)+this.templates.mainFooter};item.renderers.authorName=function(element){var author=this.get("data.actor.title")||this.labels.get("guest");return Echo.Utils.safelyExecute(element.html,author,element)||element};item.renderers.markers=function(element){return this.view.render({"name":"_extraField","target":element,"extra":{"type":"markers"}})};item.renderers.tags=function(element){return this.view.render({"name":"_extraField","target":element,
"extra":{"type":"tags"}})};item.renderers.container=function(element){var self=this;element.removeClass($.map(["child","root","child-thread","root-thread"],function(suffix){return self.cssPrefix+"container-"+suffix}).join(" "));var suffix=this.threading?"-thread":"";var cssClass=this.depth?"container-child"+suffix+" echo-trinaryBackgroundColor":"container-root"+suffix;element.addClass(this.cssPrefix+"depth-"+this.depth+" "+this.cssPrefix+cssClass);var switchClasses=function(action){$.map(self.buttonsOrder,
function(name){var clickables=self.get("buttons."+name+".clickableElements");if(!self.get("buttons."+name+".element")||!clickables)return;clickables[action+"Class"]("echo-linkColor")})};if(!Echo.Utils.isMobileDevice())element.off(["mouseleave","mouseenter"]).hover(function(){if(self.user.is("admin"))self.view.get("modeSwitch").show();switchClasses("add")},function(){if(self.user.is("admin"))self.view.get("modeSwitch").hide();switchClasses("remove")});return element};item.renderers.metadata=function(element){element.empty();
if(this.user.is("admin")){var view=this.view.fork();var addSection=function(section){element.append(view.render({"template":item.templates.metadata[section]}))};addSection("userID");if(this.get("data.ip"))addSection("userIP")}return element.hide()};item.renderers.modeSwitch=function(element){var self=this;element.hide();if(!this.user.is("admin"))return element;var mode="default";var setTitle=function(el){element.attr("title",self.labels.get(mode+"ModeSwitchTitle"))};setTitle();element.click(function(){mode=
mode==="default"?"metadata":"default";setTitle();self.view.get("data").toggle();self.view.get("metadata").toggle()});if(Echo.Utils.isMobileDevice())element.show();return element};item.renderers.wrapper=function(element){return element.addClass(this.cssPrefix+"wrapper"+(this.depth?"-child":"-root"))};item.renderers.avatar=function(element){this.placeImage({"container":element,"image":this.get("data.actor.avatar"),"defaultImage":this.config.get("defaultAvatar")});return element};item.renderers.children=
function(element,config){return this.view.render({"name":"_childrenContainer","target":element,"extra":{"filter":function(item){return!item.byCurrentUser},"keepChildren":config&&config.keepChildren}})};item.renderers.childrenByCurrentActorLive=function(element,config){return this.view.render({"name":"_childrenContainer","target":element,"extra":{"filter":function(item){return item.byCurrentUser},"keepChildren":config&&config.keepChildren}})};item.renderers.buttons=function(element){var self=this;
this._assembleButtons();this._sortButtons();element.empty();$.map(this.buttonsOrder,function(name){var data=self.get("buttons."+name);if(!data||!data.name||!data.visible())return;self.view.render({"name":"_buttonsDelimiter","target":element});self.view.render({"name":"_button","target":element,"extra":data})});return element};item.renderers.re=function(element){var self=this;if(!this.config.get("reTag")||this.depth)return element.hide();var pageHref=document.location.href;var context=this.get("data.object.context");
var permalink=this.get("data.object.permalink");if(permalink===pageHref||!context||!context.length)return element.hide();var fromCurrentPage=false;$.map(context,function(ctx){if(ctx.uri===pageHref){fromCurrentPage=true;return false}});if(fromCurrentPage)return element.hide();var re;var config={"limits":this.config.get("limits"),"openLinksInNewWindow":this.config.get("parent.openLinksInNewWindow")};var pageDomain=this._getDomain(pageHref);if(this.config.get("optimizedContext")){var primary;$.map(context,
function(ctx){if(self._getDomain(ctx.uri)===pageDomain){primary=ctx;return false}});re=this._reOfContext(primary||context[0],config)}else re=$.map(context,function(ctx){return self._reOfContext(ctx,config)});return element.empty().append(re).show()};item.renderers.sourceIcon=function(element){if(!this.config.get("viaLabel.icon")||this.get("data.source.name")==="jskit"||this.get("data.source.name")==="echo")return element.hide();var url=this.get("data.source.icon",this.config.get("providerIcon"));
var data={"href":this.get("data.source.uri",this.get("data.object.permalink"))};var config={"openInNewWindow":this.config.get("parent.openLinksInNewWindow")};element.hide().attr("src",Echo.Utils.htmlize(url)).one("error",function(){element.hide()}).one("load",function(){element.show().wrap(Echo.Utils.hyperlink(data,config))});return element};item.renderers.via=function(element){var self=this;var get=function(field){return(self.data[field].name||"").toLowerCase()};if(get("source")===get("provider"))return element;
return this.view.render({"name":"_viaText","target":element,"extra":{"label":"via","field":"provider"}})};item.renderers.from=function(element){return this.view.render({"name":"_viaText","target":element,"extra":{"label":"from","field":"source"}})};item.renderers.textToggleTruncated=function(element){var self=this;element.off("click").click(function(){self.textExpanded=!self.textExpanded;self.view.render({"name":"body"});self.view.render({"name":"textToggleTruncated"})});return element.empty().append(this.labels.get("textToggleTruncated"+
(this.textExpanded?"Less":"More")))};item.renderers.body=function(element){var self=this;var data=[this.get("data.object.content"),{"source":this.get("data.source.name"),"limits":this.config.get("limits"),"contentTransformations":this.config.get("contentTransformations."+this.get("data.object.content_type"),{}),"openLinksInNewWindow":this.config.get("parent.openLinksInNewWindow")}];$.each(this._getBodyTransformations(),function(i,trasformation){data=trasformation.apply(self,data);if(!/\S/.test(data[0])){data[0]=
self.labels.get("sharedThisOn",{"service":data[1].source});return false}});var text=data[0];var truncated=data[1].truncated;var textElement=this.view.get("text").empty();Echo.Utils.safelyExecute(textElement.append,text,textElement);this.view.get("textEllipses")[!truncated||this.textExpanded?"hide":"show"]();this.view.get("textToggleTruncated")[truncated||this.textExpanded?"show":"hide"]();return element};item.renderers.date=function(element){this.age=this.getRelativeTime(this.timestamp);return element.html(this.age)};
item.renderers.expandChildrenLabel=function(element,extra){if(!this.children.length||!this.hasMoreChildren())return element;extra=extra||{};extra.state=extra.state||"regular";var states={"loading":{"css":this.cssPrefix+"message-loading","label":"loading"},"regular":{"css":"echo-linkColor echo-message-icon","label":"childrenMoreItems"}};return element.removeClass(states[extra.state==="loading"?"regular":"loading"].css).addClass(states[extra.state].css).html(this.labels.get(states[extra.state].label))};
item.renderers.expandChildren=function(element,extra){var self=this;if(!this.children.length)return element;if(!this.hasMoreChildren()){element.slideUp(this.config.get("children.moreButtonSlideTimeout"));return element}extra=extra||{};return element.addClass(this.cssPrefix+"depth-"+(this.depth+1)).show().off("click").one("click",function(){self.view.render({"name":"expandChildrenLabel","target":self.view.get("expandChildrenLabel"),"extra":{"state":"loading"}});self.events.publish({"topic":"onChildrenExpand",
"data":{"data":self.data},"global":false,"propagation":false})})};item.renderers._childrenContainer=function(element,config){$.each(element.children(),function(i,child){$(child).detach()});$.map(this.children,function(child){if(config&&config.filter&&!config.filter(child))return;element.append(child.config.get("target"));if(!child.view.rendered()&&!child.added)child.render();if(child.deleted||child.added)child.events.publish({"topic":child.deleted?"onDelete":"onAdd","data":{"config":config},"global":false,
"propagation":false})});return element};item.renderers._extraField=function(element,extra){var self=this;var type=(extra||{}).type;if(!this.data.object[type]||!this.user.is("admin"))return element.hide();var name=type==="markers"?"maxMarkerLength":"maxTagLength";var limit=this.config.get("limits."+name);var items=Echo.Utils.foldl([],this.data.object[type],function(item,acc){var template=item.length>limit?'\x3cspan title\x3d"{data:item}"\x3e{data:truncatedItem}\x3c/span\x3e':"\x3cspan\x3e{data:item}\x3c/span\x3e";
var truncatedItem=Echo.Utils.htmlTextTruncate(item,limit,"...");acc.push(self.substitute({"template":template,"data":{"item":item,"truncatedItem":truncatedItem}}))});return(Echo.Utils.safelyExecute(element.prepend,items.sort().join(", "),element)||element).show()};item.renderers._button=function(element,extra){var template=extra.template||'\x3ca class\x3d"{class:button} {class:button}-{data:name}"\x3e{data:label}\x3c/a\x3e';var button=$(this.substitute({"template":template,"data":{"label":extra.label||
"","name":extra.name}}));if(!extra.clickable)return element.append(button);var clickables=$(".echo-clickable",button);if(!clickables.length){clickables=button;button.addClass("echo-clickable")}clickables[extra.once?"one":"on"]({"click":function(event){event.stopPropagation();if(extra.callback)extra.callback()}});var data=this.get("buttons."+extra.plugin+"."+extra.name);data.element=button;data.clickableElements=clickables;if(Echo.Utils.isMobileDevice())clickables.addClass("echo-linkColor");return element.append(button)};
item.renderers._buttonsDelimiter=function(element){return element.append('\x3cspan class\x3d"'+this.cssPrefix+'button-delim"\x3e \x26middot; \x3c/span\x3e')};item.renderers._viaText=function(element,extra){extra=extra||{};var data=this.data[extra.field];if(!this.config.get("viaLabel.text")||!data.name||data.name==="jskit"||data.name==="echo")return element;var a=Echo.Utils.hyperlink({"class":"echo-secondaryColor","href":data.uri||this.get("data.object.permalink"),"caption":data.name},{"openInNewWindow":this.config.get("parent.openLinksInNewWindow")});
return element.html("\x26nbsp;"+this.labels.get(extra.label+"Label")+"\x26nbsp;").append(a)};item.methods.hasMoreChildren=function(){return this.get("data.hasMoreChildren")==="true"};item.methods.getNextPageAfter=function(){var children=$.grep(this.children,function(child){return!child.config.get("live")});var index=this.config.get("parent.children.sortOrder")==="chronological"?children.length-1:0;return children.length?children[index].data.pageAfter:undefined};item.methods.traverse=function(tree,
callback,acc){var self=this;$.each(tree||[],function(i,item){acc=self.traverse(item.children,callback,callback(item,acc))});return acc};item.methods.block=function(label){if(this.blocked)return;this.blocked=true;var content=this.view.get("container");var width=content.width();var height=content.outerHeight();this.blockers={"backdrop":$('\x3cdiv class\x3d"'+this.cssPrefix+'blocker-backdrop"\x3e\x3c/div\x3e').css({"width":width,"height":height}),"message":$(this.substitute({"template":'\x3cdiv class\x3d"{class:blocker-message}"\x3e{data:label}\x3c/div\x3e',
"data":{"label":label}})).css({"left":(parseInt(width)-200)/2+"px","top":(parseInt(height)-20)/2+"px"})};content.addClass("echo-relative").prepend(this.blockers.backdrop).prepend(this.blockers.message)};item.methods.unblock=function(){if(!this.blocked)return;this.blocked=false;this.blockers.backdrop.remove();this.blockers.message.remove();this.view.get("container").removeClass("echo-relative")};item.methods.getAccumulator=function(type){return this.data.object.accumulators[type]};item.methods.isRoot=
function(){return!this.config.get("parent.children.maxDepth")||this.get("data.object.id")===this.get("data.target.conversationID")};item.methods.addButtonSpec=function(plugin,spec){if(!this.buttonSpecs[plugin])this.buttonSpecs[plugin]=[];this.buttonSpecs[plugin].push(spec)};item.methods._getDomain=function(url){var parts=Echo.Utils.parseURL(url);return parts&&parts.domain?parts.domain:url};item.methods._reOfContext=function(context,config){var title=context.title||context.uri.replace(/^https?:\/\/(.*)/ig,
"$1");var maxLength=config.limits[title?"maxReTitleLength":"maxReLinkLength"];if(title.length>maxLength)title=title.substring(0,maxLength)+"...";var hyperlink=Echo.Utils.hyperlink({"class":"echo-primaryColor","href":context.uri,"caption":this.labels.get("re")+": "+Echo.Utils.stripTags(title)},{"openInNewWindow":config.openLinksInNewWindow});return $(this.substitute({"template":'\x3cdiv class\x3d"{class:re-container}"\x3e{data:hyperlink}\x3c/div\x3e',"data":{"hyperlink":hyperlink}}))};item.methods._prepareEventParams=
function(params){return $.extend(params,{"target":this.config.get("parent.target").get(0),"query":this.config.get("parent.query"),"item":{"data":this.data,"target":this.config.get("target").get(0)}})};var _smileys={"codes":[],"regexps":[],"hash":{":)":{file:"smile.png",title:"Smile"},":-)":{file:"smile.png",title:"Smile"},";)":{file:"wink.png",title:"Wink"},";-)":{file:"wink.png",title:"Wink"},":(":{file:"unhappy.png",title:"Frown"},":-(":{file:"unhappy.png",title:"Frown"},"\x3d-O":{file:"surprised.png",
title:"Surprised"},":-D":{file:"grin.png",title:"Laughing"},":-P":{file:"tongue.png",title:"Tongue out"},"\x3d)":{file:"happy.png",title:"Happy"},"B-)":{file:"evilgrin.png",title:"Evil grin"}}};item.methods._initSmileysConfig=function(){var self=this;if(_smileys.codes.length)return _smileys;var esc=function(v){return v.replace(/([\W])/g,"\\$1")};var escapedCodes=[];$.each(_smileys.hash,function(code,smiley){var escaped=esc(code);escapedCodes.push(escaped);_smileys.codes.push(code);_smileys.regexps[code]=
new RegExp(escaped,"g");smiley.tag=self.substitute({"template":'\x3cimg class\x3d"{class:smiley-icon}" src\x3d"{config:cdnBaseURL.sdk-assets}/images/smileys/emoticon_'+smiley.file+'" title\x3d"'+smiley.title+'" alt\x3d"'+smiley.title+'"\x3e'})});_smileys.regexps.test=new RegExp(escapedCodes.join("|"));return _smileys};item.methods._assembleButtons=function(){var self=this;var buttonsOrder=[];$.each(this.buttonSpecs,function(plugin,specs){$.map(specs,function(spec){var data=$.isFunction(spec)?spec.call(self):
$.extend({},spec);if(!data.name)return;var callback=data.callback||function(){};data.callback=function(){callback.call(self);self.events.publish({"topic":"onButtonClick","data":{"name":data.name,"plugin":plugin,"item":{"data":self.data,"target":self.config.get("target")}}})};data.label=data.label||data.name;data.plugin=plugin;if(typeof data.clickable==="undefined")data.clickable=true;if(typeof data.visible==="undefined")data.visible=true;var visible=data.visible;data.visible=$.isFunction(visible)?
visible:function(){return visible};var name=plugin+"."+data.name;self.set("buttons."+name,data);if($.inArray(name,self.buttonsOrder)<0)buttonsOrder.push(name)})});this.buttonsOrder=buttonsOrder.concat(this.buttonsOrder)};item.methods._sortButtons=function(){var self=this;var defaultOrder=this.buttonsOrder;var requiredOrder=this.config.get("buttonsOrder");if(!requiredOrder)this.config.set("buttonsOrder",defaultOrder);else if(requiredOrder!==defaultOrder){var push=function(name,acc,pos){if(!self.get("buttons."+
name))return;acc.push(name);pos=pos||$.inArray(name,defaultOrder);if(pos>=0)delete defaultOrder[pos]};var order=Echo.Utils.foldl([],requiredOrder,function(name,acc){if(/^(.*)\./.test(name))push(name,acc);else{var re=new RegExp("^"+name+"\\.");$.map(defaultOrder,function(n,i){if(n&&n.match(re))push(n,acc,i)})}});this.buttonsOrder=order;this.config.set("buttonsOrder",order)}else if(!requiredOrder.length)this.buttonsOrder=[]};(function(){item.methods._getBodyTransformations=function(){return[_aggressiveSanitization,
_replaceLinkedHashtags,_tags2meta,_replacePlainHashtags,_autoLinking,_replaceSmileys,_replaceNewLines,_meta2tags,_normalizeLinks,_applyLimits]};var _urlMatcher="((?:http|ftp|https):\\/\\/(?:[a-z0-9#:\\/\\;\\?\\-\\.\\+,@\x26\x3d%!\\*\\'(){}\\[\\]$_|^~`](?!gt;|lt;))+)";var _wrapTag=function(tag,limits){var template=tag.length>limits.maxTagLength?'\x3cspan class\x3d"{class:tag}" title\x3d"{data:tag}"\x3e{data:truncatedTag}\x3c/span\x3e':'\x3cspan class\x3d"{class:tag}"\x3e{data:tag}\x3c/span\x3e';var truncatedTag=
tag.substring(0,limits.maxTagLength)+"...";return this.substitute({"template":template,"data":{"tag":tag,"truncatedTag":truncatedTag}})};var _aggressiveSanitization=function(text,extra){if(extra.source&&extra.source==="Twitter"&&this.config.get("aggressiveSanitization"))text="";return[text,extra]};var _replaceLinkedHashtags=function(text,extra){var self=this;if(extra.contentTransformations.hashtags)text=text.replace(/(?:#|\uff03)(<a[^>]*>[^<]*<\/a>)/ig,function($0,$1,$2){return _wrapTag.call(self,
$1,extra.limits)});return[text,extra]};var _replacePlainHashtags=function(text,extra){var self=this;if(extra.contentTransformations.hashtags)text=text.replace(/(^|[^\w&\/])(?:#|\uff03)([^\s\.,;:'"#@\$%<>!\?\(\)\[\]]+)/ig,function($0,$1,$2){return $1+_wrapTag.call(self,$2,extra.limits)});return[text,extra]};var _tags2meta=function(text,extra){var self=this,tags=[];text=text.replace(/((<a\s+[^>]*>)(.*?)(<\/a>))|<.*?>/ig,function($0,$1,$2,$3,$4){if($1){var data=_tags2meta.call(self,$3,extra);data=_replacePlainHashtags.apply(self,
data);data=_meta2tags.apply(self,data);$0=$2+data[0]+$4}tags.push($0);return" %%HTML_TAG%% "});extra.tags=tags;return[text,extra]};var _meta2tags=function(text,extra){$.each(extra.tags,function(i,v){text=text.replace(" %%HTML_TAG%% ",v)});return[text,extra]};var _normalizeLinks=function(text,extra){text=text.replace(/(<a\s+[^>]*>)(.*?)(<\/a>)/ig,function($0,$1,$2,$3){if((new RegExp("^"+_urlMatcher+"$","i")).test($2))$2=$2.length>extra.limits.maxBodyLinkLength?$2.substring(0,extra.limits.maxBodyLinkLength)+
"...":$2;if(extra.openLinksInNewWindow&&!/\s+target=("[^<>"]*"|'[^<>']*'|\w+)/.test($1))$1=$1.replace(/(^<a\s+[^>]*)(>$)/,'$1 target\x3d"_blank"$2');return $1+$2+$3});return[text,extra]};var _autoLinking=function(text,extra){extra.textBeforeAutoLinking=text;var url;if(extra.source&&extra.source!=="jskit"&&extra.source!=="echo")url=this.depth?this.get("data.target.id"):this.config.get("reTag")?this.get("data.object.permalink")||this.get("data.target.id"):undefined;text=text.replace(new RegExp(_urlMatcher,
"ig"),function($0,$1){if(url===$1)return"";if(!extra.contentTransformations.urls)return $0;return Echo.Utils.hyperlink({"href":$1,"caption":$1},{"skipEscaping":true,"openInNewWindow":extra.openLinksInNewWindow})});return[text,extra]};var _replaceSmileys=function(text,extra){if(extra.contentTransformations.smileys){if(text!==extra.textBeforeAutoLinking){var data=_meta2tags.call(this,text,extra);data=_tags2meta.apply(this,data);text=data[0];extra=data[1]}var smileys=this._initSmileysConfig();if(text.match(smileys.regexps.test))$.each(smileys.codes,
function(i,code){text=text.replace(smileys.regexps[code],smileys.hash[code].tag)})}return[text,extra]};var _replaceNewLines=function(text,extra){if(extra.contentTransformations.newlines){text=text.replace(/\n\n+/g,"\n\n");text=text.replace(/\n/g,"\x26nbsp;\x3cbr\x3e")}return[text,extra]};var _applyLimits=function(text,extra){var truncated=false;if((extra.limits.maxBodyCharacters||extra.limits.maxBodyLines)&&!this.textExpanded){if(extra.limits.maxBodyLines){var splitter=extra.contentTransformations.newlines?
"\x3cbr\x3e":"\n";var chunks=text.split(splitter);if(chunks.length>extra.limits.maxBodyLines){text=chunks.splice(0,extra.limits.maxBodyLines).join(splitter);truncated=true}}var limit=extra.limits.maxBodyCharacters&&text.length>extra.limits.maxBodyCharacters?extra.limits.maxBodyCharacters:truncated?text.length:undefined;var truncatedText=Echo.Utils.htmlTextTruncate(text,limit,"",true);if(truncatedText.length!==text.length)truncated=true;text=truncatedText}extra.truncated=truncated;return[text,extra]}})();
var itemDepthRules=[];for(var i=0;i<=20;i++)itemDepthRules.push(".{class:depth}-"+i+" { margin-left: "+(i?68+(i-1)*44:0)+"px; }");item.css=".{class:content} { word-wrap: break-word; }"+".{class:container-root} { padding: 10px 0px 10px 10px; }"+".{class:container-root-thread} { padding: 10px 0px 0px 10px; }"+".{class:container-child} { padding: 10px; margin: 0px 20px 2px 0px; }"+".{class:container-child-thread} { padding: 10px; margin: 0px 20px 2px 0px; }"+".{class:avatar-wrapper} { margin-right: -58px; float: left; position: relative; }"+
".{class:children} .{class:avatar-wrapper}, .{class:childrenByCurrentActorLive} .{class:avatar-wrapper} { margin-right: -34px; }"+".{class:children} .{class:subwrapper}, .{class:childrenByCurrentActorLive} .{class:subwrapper} { margin-left: 34px; }"+".{class:wrapper} { float: left; width: 100%; }"+".{class:subwrapper} { margin-left: 58px; }"+".{class:subcontainer} { float: left; width: 100%; }"+'.{class:markers} { line-height: 16px; background: url("{config:cdnBaseURL.sdk-assets}/images/curation/metadata/marker.png") no-repeat; padding: 0px 0px 4px 21px; margin-top: 7px; }'+
'.{class:tags} { line-height: 16px; background: url("{config:cdnBaseURL.sdk-assets}/images/tag_blue.png") no-repeat; padding: 0px 0px 4px 21px; }'+".{class:metadata-title} { font-weight: bold; line-height: 25px; height: 25px; margin-right: 5px; }"+".{class:metadata-icon} { display: inline-block; padding-left: 26px; }"+".{class:metadata-userID} { border-bottom: 1px solid #e1e1e1; border-top: 1px solid #e1e1e1;}"+'.{class:metadata-userID} .{class:metadata-icon} { background: url("{config:cdnBaseURL.sdk-assets}/images/curation/metadata/user.png") no-repeat left center; }'+
".{class:metadata-userIP} { border-bottom: 1px solid #e1e1e1; }"+'.{class:metadata-userIP} .{class:metadata-icon} { background: url("{config:cdnBaseURL.sdk-assets}/images/curation/metadata/computer.png") no-repeat left center; }'+'.{class:modeSwitch} { float: right; width: 16px; height: 16px; background:url("{config:cdnBaseURL.sdk-assets}/images/curation/metadata/flip.png") no-repeat 0px 3px; }'+".{class:childrenMarker} { border-color: transparent transparent #ECEFF5; border-width: 0px 11px 11px; border-style: solid; margin: 3px 0px 0px 77px; height: 1px; width: 0px; display: none; }"+
".{class:container-root-thread} .{class:childrenMarker} { display: block; }"+".{class:avatar} { width: 48px; height: 48px; }"+".{class:children} .{class:avatar}, .{class:childrenByCurrentActorLive} .{class:avatar} { width: 24px; height: 24px; }"+".{class:authorName} { float: left; font-size: 15px; font-weight: bold; }"+".{class:re} { font-weight: bold; }"+".{class:re} a:link, .{class:re} a:visited, .{class:re} a:active { text-decoration: none; }"+".{class:re} a:hover { text-decoration: underline; }"+
".{class:body} { padding-top: 4px; }"+".{class:buttons} { float: left; margin-left: 3px; }"+".{class:buttons} a.{class:button} { color: #C6C6C6; }"+".{class:buttons} a.{class:button}.echo-linkColor, .{class:buttons} a.{class:button}:hover { color: #476CB8; text-decoration: none; }"+".{class:sourceIcon} { float: left; height: 16px; width: 16px; margin-right: 5px; border: 0px; }"+".{class:date}, .{class:from}, .{class:via} { float: left; }"+".{class:from} a, .{class:via} a { text-decoration: none; color: #C6C6C6; }"+
".{class:from} a:hover, .{class:via} a:hover { color: #476CB8; }"+'.{class:tag} { display: inline-block; height: 16px; background: url("{config:cdnBaseURL.sdk-assets}/images/tag_blue.png") no-repeat; padding-left: 18px; }'+".{class:smiley-icon} { border: 0px; }"+".{class:textToggleTruncated} { margin-left: 5px; }"+".{class:blocker-backdrop} { position: absolute; left: 0px; top: 0px; background: #FFFFFF; opacity: 0.7; z-index: 100; }"+".{class:blocker-message} { position: absolute; z-index: 200; width: 200px; height: 20px; line-height: 20px; text-align: center; background-color: #FFFF99; border: 1px solid #C6C677; opacity: 0.7; -moz-border-radius: 0.5em 0.5em 0.5em 0.5em; }"+
".{class:expandChildren} { display:none; text-align: center; padding:4px; }"+".{class:expandChildren} .{class:expandChildrenLabel} { display: inline-block; padding-left: 22px; }"+'.{class:expandChildren} .echo-message-icon { background: url("{config:cdnBaseURL.sdk-assets}/images/whirlpool.png") no-repeat 5px 4px; }'+'.{class:expandChildren} .{class:message-loading} { background: no-repeat left top url("{config:cdnBaseURL.sdk-assets}/images/loading.gif"); }'+".{class:expandChildren} .echo-app-message { padding: 0; border:none; border-radius: 0; }"+
itemDepthRules.join("\n");Echo.Control.create(item)})(Echo.jQuery);
(function(jQuery){var $=jQuery;var submit=Echo.Control.manifest("Echo.StreamServer.Controls.Submit");if(Echo.Control.isDefined(submit))return;submit.init=function(){if(!this.checkAppKey())return;var self=this;this.addPostValidator(function(){var valid=true;$.each(["name","text"],function(i,field){valid=!self.highlightMandatory(self.view.get(field));return valid});return valid},"low");this.render();this.ready()};submit.destroy=function(){var self=this;$.each(this.posting.subscriptions,function(id){self.events.unsubscribe({"handlerId":id})})};
submit.config={"targetURL":document.location.href,"markers":[],"source":{},"tags":[],"requestMethod":"GET","itemURIPattern":undefined,"actionString":"Type your comment here...","postingTimeout":30,"type":undefined,"errorPopup":{"minHeight":70,"maxHeight":150,"width":390},"targetQuery":undefined};submit.vars={"validators":[]};submit.dependencies=[{"loaded":function(){return!!Echo.GUI},"url":"{config:cdnBaseURL.sdk}/gui.pack.js"},{"url":"{config:cdnBaseURL.sdk}/gui.pack.css"}];submit.labels={"markers":"Markers:",
"markersHint":"Marker1, marker2, marker3, ...","post":"Post","posting":"Posting...","postingFailed":'There was a server error while trying to submit your item. Please try again in a few minutes. \x3cb\x3eError: "{error}"\x3c/b\x3e.',"postingTimeout":"There was a network issue while trying to submit your item. Please try again in a few minutes.","tagsHint":"Tag1, tag2, tag3, ...","tags":"Tags:","yourName":"Your Name (required)","yourWebsiteOptional":"Your website (optional)"};submit.templates.main=
'\x3cdiv class\x3d"{class:container}"\x3e'+'\x3cdiv class\x3d"{class:header}"\x3e'+'\x3cdiv class\x3d"{class:userInfoWrapper}"\x3e'+'\x3cdiv class\x3d"{class:avatar}"\x3e\x3c/div\x3e'+'\x3cdiv class\x3d"{class:fields}"\x3e'+'\x3cdiv class\x3d"{class:fieldsWrapper}"\x3e'+'\x3cdiv class\x3d"{class:nameContainer} {class:border}"\x3e'+'\x3cinput type\x3d"text" class\x3d"{class:name} echo-primaryFont echo-primaryColor" /\x3e'+"\x3c/div\x3e"+'\x3cdiv class\x3d"{class:urlContainer} {class:border}"\x3e'+
'\x3cinput type\x3d"text" class\x3d"{class:url} echo-primaryFont echo-primaryColor" /\x3e'+"\x3c/div\x3e"+"\x3c/div\x3e"+"\x3c/div\x3e"+'\x3cdiv class\x3d"echo-clear"\x3e\x3c/div\x3e'+"\x3c/div\x3e"+"\x3c/div\x3e"+'\x3cdiv class\x3d"{class:body}"\x3e'+'\x3cdiv class\x3d"{class:content} {class:border}"\x3e'+'\x3ctextarea class\x3d"{class:text} {class:textArea} echo-primaryFont echo-primaryColor"\x3e\x3c/textarea\x3e'+"\x3c/div\x3e"+'\x3cdiv class\x3d"{class:markersContainer} {class:metadataContainer} echo-primaryFont echo-primaryColor"\x3e'+
'\x3cdiv class\x3d"{class:metadataLabel}"\x3e{label:markers}\x3c/div\x3e'+'\x3cdiv class\x3d"{class:metadataWrapper}"\x3e'+'\x3cdiv class\x3d"{class:metadataSubwrapper} {class:border} "\x3e'+'\x3cinput type\x3d"text" class\x3d"{class:markers} echo-primaryFont" /\x3e'+"\x3c/div\x3e"+"\x3c/div\x3e"+'\x3cdiv class\x3d"echo-clear"\x3e\x3c/div\x3e'+"\x3c/div\x3e"+'\x3cdiv class\x3d"{class:tagsContainer} {class:metadataContainer} echo-primaryFont echo-primaryColor"\x3e'+'\x3cdiv class\x3d"{class:metadataLabel}"\x3e{label:tags}\x3c/div\x3e'+
'\x3cdiv class\x3d"{class:metadataWrapper}"\x3e'+'\x3cdiv class\x3d"{class:metadataSubwrapper} {class:border} "\x3e'+'\x3cinput type\x3d"text" class\x3d"{class:tags} {class:border} echo-primaryFont" /\x3e'+"\x3c/div\x3e"+"\x3c/div\x3e"+'\x3cdiv class\x3d"echo-clear"\x3e\x3c/div\x3e'+"\x3c/div\x3e"+"\x3c/div\x3e"+'\x3cdiv class\x3d"{class:controls}"\x3e'+'\x3cdiv class\x3d"{class:postContainer}"\x3e'+'\x3cdiv class\x3d"btn echo-primaryFont {class:postButton}"\x3e\x3c/div\x3e'+"\x3c/div\x3e"+'\x3cdiv class\x3d"echo-clear"\x3e\x3c/div\x3e'+
"\x3c/div\x3e"+"\x3c/div\x3e";submit.renderers.tagsContainer=function(element){return this.user.is("admin")?element.show():element.hide()};submit.renderers.markersContainer=submit.renderers.tagsContainer;submit.renderers.markers=function(element){return this.view.render({"name":"_metaFields","target":element,"extra":{"type":"markers"}})};submit.renderers.tags=function(element){return this.view.render({"name":"_metaFields","target":element,"extra":{"type":"tags"}})};submit.renderers.text=function(element){var content=
this.get("data.object.content");if(content)element.val(content);return element.iHint({"text":this.config.get("actionString"),"className":"echo-secondaryColor"})};submit.renderers.avatar=function(element){this.placeImage({"container":element,"image":this.user.get("avatar"),"defaultImage":this.config.get("defaultAvatar")});return element};submit.renderers.name=function(element){return element.val(this.user.get("name","")).iHint({"text":this.labels.get("yourName"),"className":"echo-secondaryColor"})};
submit.renderers.url=function(element){return element.val(this.user.get("domain","")).iHint({"text":this.labels.get("yourWebsiteOptional"),"className":"echo-secondaryColor"})};submit.renderers.postButton=function(element){var self=this;var states={"normal":{"target":element,"icon":false,"disabled":false,"label":this.labels.get("post")},"posting":{"target":element,"icon":this.config.get("cdnBaseURL.sdk-assets")+"/images/loading.gif","disabled":true,"label":this.labels.get("posting")}};var postButton=
new Echo.GUI.Button(states.normal);this.posting=this.posting||{};this.posting.subscriptions=this.posting.subscriptions||[];var subscribe=function(phase,state,callback){var topic=submit.name+".onPost"+phase;var subscriptions=self.posting.subscriptions;if(subscriptions[topic])self.events.unsubscribe({"topic":topic,"handlerId":subscriptions[topic]});subscriptions[topic]=self.events.subscribe({"topic":topic,"handler":function(topic,params){postButton.setState(state);if(callback)callback(params)}})};subscribe("Init",
states.posting);subscribe("Complete",states.normal,function(){self.view.get("text").val("").trigger("blur");self.view.render({"name":"tags"});self.view.render({"name":"markers"})});subscribe("Error",states.normal,function(params){var request=params.request||{};if(request.state&&request.state.critical)self._showError(params)});this.posting.action=this.posting.action||function(){if(self._isPostValid())self.post()};element.off("click",this.posting.action).on("click",this.posting.action);return element};
submit.renderers._metaFields=function(element,extra){var type=extra.type;var data=this.get("data.object."+type,this.config.get(type));var value=$.trim(Echo.Utils.stripTags(data.join(", ")));return this.view.get(type).iHint({"text":this.labels.get(type+"Hint"),"className":"echo-secondaryColor"}).val(value).blur()};submit.methods.post=function(){var self=this;var publish=function(phase,data,responseBody,requestState){var args={"topic":"onPost"+phase,"data":{"postData":data}};if(requestState||responseBody)args.data.request=
{"state":requestState,"response":responseBody};self.events.publish(args)};var postType=this.config.get("type",this._getASURL("comment"));var content=[].concat(self._getActivity("post",postType,self.view.get("text").val()),self._getActivity("tag",this._getASURL("marker"),self.view.get("markers").val()),self._getActivity("tag",this._getASURL("tag"),self.view.get("tags").val()));var entry={"content":content,"appkey":this.config.get("appkey"),"sessionID":this.user.get("sessionID","")};if(this.config.get("targetQuery"))entry["target-query"]=
this.config.get("targetQuery");var callbacks={"onData":function(response,state){publish("Complete",entry,response,state);Echo.Events.publish({"topic":"Echo.Control.onDataInvalidate","context":"global","data":{}})},"onError":function(response,state){publish("Error",entry,response,state)}};publish("Init",entry);Echo.StreamServer.API.request({"endpoint":"submit","method":this.config.get("requestMethod"),"itemURIPattern":this.config.get("itemURIPattern"),"submissionProxyURL":this.config.get("submissionProxyURL"),
"timeout":this.config.get("postingTimeout"),"secure":this.config.get("useSecureAPI"),"data":entry,"onData":callbacks.onData,"onError":callbacks.onError}).send()};submit.methods.highlightMandatory=function(element){if(element&&!$.trim(element.val())){var css=this.cssPrefix+"mandatory";element.parent().addClass(css);element.focus(function(){$(this).parent().removeClass(css)});return true}return false};submit.methods.addPostValidator=function(validator,priority){this.validators[priority==="low"?"push":
"unshift"](validator)};submit.methods.refresh=function(){var self=this;this.config.set("data.object.content",this.view.get("text").val());$.map(["tags","markers"],function(field){var elements=self.view.get(field).val().split(", ");self.config.set("data.object."+field,elements||[])});var component=Echo.Utils.getComponent("Echo.StreamServer.Controls.Submit");component.parent.refresh.call(this)};submit.methods._getActivity=function(verb,type,data){return!data?[]:{"actor":{"objectTypes":[this._getASURL("person")],
"name":this.user.get("name",this.user.is("logged")?"":this.view.get("name").val()),"avatar":this.user.get("avatar","")},"object":{"objectTypes":[type],"content":data},"source":this.config.get("source"),"verbs":[this._getASURL(verb)],"targets":[{"id":this.config.get("targetURL")}]}};submit.methods._getASURL=function(postfix){return"http://activitystrea.ms/schema/1.0/"+postfix};submit.methods._showError=function(data){data=data||{};var response=data.request&&data.request.response||{};var message=$.inArray(response.errorCode,
["network_timeout","connection_failure"])>=0?this.labels.get("postingTimeout"):this.labels.get("postingFailed",{"error":response.errorMessage||response.errorCode});var popup=this._assembleErrorPopup(message);new Echo.GUI.Modal({"data":{"body":popup.content},"width":popup.width,"footer":false,"fade":true,"show":true})};submit.methods._assembleErrorPopup=function(message){var dimensions=this.config.get("errorPopup");var template=this.substitute({"template":'\x3cdiv class\x3d"{data:css}"\x3e{data:message}\x3c/div\x3e',
"data":{"message":message,"css":this.cssPrefix+"error"}});var popup={"content":$(template).css({"min-height":dimensions.minHeight,"max-height":dimensions.maxHeight}),"width":dimensions.width};return popup};submit.methods._isPostValid=function(){var valid=true;$.each(this.validators,function(i,handler){valid=handler();return valid});return valid};submit.methods._prepareEventParams=function(params){return $.extend(params,{"data":this.get("data"),"target":this.config.get("target").get(0),"targetURL":this.config.get("targetURL")})};
submit.css=".{class:header} { margin-bottom: 3px; }"+".{class:avatar} { float: left; margin-right: -48px; width: 48px; height: 48px; }"+".{class:fields} { width: 100%; float: left; }"+".{class:fields} input { width: 100%; }"+".{class:fieldsWrapper} { margin-left: 53px; }"+".{class:nameContainer} { margin: 1px 0px 4px 0px; padding: 0px 2px 1px 3px; background-color: #fff; }"+".{class:nameContainer} input.{class:name} { font-size: 14px; font-weight: bold; border: none; width: 100%;}"+'.{class:fieldsWrapper} input.{class:name}[type\x3d"text"] { width: 100%; margin-bottom: 0px; border: none; padding: 0px; outline: 0; box-shadow: none; }'+
'.{class:fieldsWrapper} input.{class:name}[type\x3d"text"]:focus { outline: 0; box-shadow: none;  }'+".{class:urlContainer} { padding: 0px 2px 1px 3px; background-color: #fff; }"+".{class:urlContainer} input.{class:url} { height: 19px; border: none; width: 100%; margin-bottom: 0px;}"+'.{class:fieldsWrapper} input.{class:url}[type\x3d"text"] { width: 100%; margin-bottom: 0px; border: none; padding: 0px; outline: 0; box-shadow: none;  }'+'.{class:fieldsWrapper} input.{class:url}[type\x3d"text"]:focus { outline: 0; box-shadow: none; }'+
'.{class:fieldsWrapper} input.{class:url}[type\x3d"text"].echo-secondaryColor,'+'.{class:fieldsWrapper} input.{class:name}[type\x3d"text"].echo-secondaryColor,'+".{class:content} textarea.{class:textArea}.echo-secondaryColor,"+'.{class:container} .{class:metadataSubwrapper} input.echo-secondaryColor[type\x3d"text"]'+" { color: #C6C6C6 }"+".{class:author} { font-weight: bold; }"+".{class:content} { padding: 5px 5px 5px 6px; background-color: #fff; }"+".{class:content} textarea.{class:textArea} { width: 100%; height: 102px; padding: 0px; margin: 0px; border: none; resize:none; box-shadow: none; outline: 0; }"+
".{class:content} textarea.{class:textArea}:focus { outline: 0; box-shadow: none; }"+".{class:text} input { width: 100%; border: none; }"+".{class:metadataContainer} { margin-top: 6px; }"+".{class:metadataLabel} { float: left; width: 50px; margin-right: -50px; text-align: right; line-height: 22px; }"+".{class:metadataWrapper} { float: left; width: 100%; }"+".{class:metadataSubwrapper} { margin-left: 55px; padding: 2px 2px 2px 3px; background-color: #fff; }"+'.{class:container} .{class:metadataSubwrapper} input[type\x3d"text"] { width: 100%; border: 0; padding: 0px; outline: 0; box-shadow: none; margin-bottom: 0px; }'+
'.{class:container} .{class:metadataSubwrapper} input[type\x3d"text"]:focus { outline: 0; box-shadow: none; }'+".{class:controls} { margin-top: 5px; }"+".{class:postContainer} { float: right; }"+".{class:border} { border: 1px solid #d2d2d2; }"+".{class:mandatory} { border: 1px solid red; }"+".{class:queriesViewOption} { padding-right: 5px; }"+".{class:error} { color: #444444; font: 14px Arial; line-height: 150%; padding-left: 85px; background: no-repeat url({config:cdnBaseURL.sdk-assets}/images/info70.png); }";
Echo.Control.create(submit)})(Echo.jQuery);
(function(jQuery){var $=jQuery;var plugin=Echo.Plugin.manifest("CommunityFlag","Echo.StreamServer.Controls.Stream.Item");if(Echo.Plugin.isDefined(plugin))return;plugin.init=function(){this.extendTemplate("insertAsLastChild","data",plugin.templates.main);this.component.addButtonSpec("CommunityFlag",this._assembleButton("Flag"));this.component.addButtonSpec("CommunityFlag",this._assembleButton("Unflag"))};plugin.config={"showUserList":true};plugin.labels={"flagged":"Flagged","flaggedThis":" flagged this.",
"flagControl":"Flag","unflagControl":"Unflag","flagProcessing":"Flagging...","unflagProcessing":"Unflagging..."};plugin.dependencies=[{"control":"Echo.StreamServer.Controls.FacePile","url":"{config:cdnBaseURL.sdk}/streamserver.pack.js"}];plugin.templates.main='\x3cdiv class\x3d"{plugin.class:flaggedBy}"\x3e\x3c/div\x3e';plugin.renderers.flaggedBy=function(element){var plugin=this,item=this.component;var flags=item.get("data.object.flags",[]);if(!flags.length||!item.user.is("admin")||!plugin.config.get("showUserList"))return element.hide();
var flagsPerPage=5;var visibleUsersCount=plugin.get("facepile")?plugin.get("facepile").getVisibleUsersCount():flagsPerPage;var config=plugin.config.assemble({"target":element,"data":{"entries":flags,"itemsPerPage":flagsPerPage},"initialUsersCount":visibleUsersCount,"suffixText":plugin.labels.get("flaggedThis")});plugin.set("facepile",new Echo.StreamServer.Controls.FacePile(config));return element.show()};plugin.methods._assembleButton=function(name){var plugin=this;var callback=function(){var item=
this;item.get("buttons."+plugin.name+"."+name+".element").empty().append(plugin.labels.get(name.toLowerCase()+"Processing"));var activity={"verbs":["http://activitystrea.ms/schema/1.0/"+name.toLowerCase()],"targets":[{"id":item.get("data.object.id")}]};var request=Echo.StreamServer.API.request({"endpoint":"submit","secure":plugin.config.get("useSecureAPI",false,true),"submissionProxyURL":plugin.config.get("submissionProxyURL","",true),"data":{"content":activity,"appkey":item.config.get("appkey"),
"sessionID":item.user.get("sessionID"),"target-query":item.config.get("parent.query")},"onData":function(response){plugin._publishEventComplete({"name":name,"state":"Complete","response":response});if(name==="Flag"&&!item.config.get("parent.showFlags")){plugin.set("flagged",true);item.view.render({"name":"buttons"})}plugin.requestDataRefresh()},"onError":function(response){plugin._publishEventComplete({"name":name,"state":"Error","response":response});item.render()}});request.send()};return function(){var item=
this;var flags=item.get("data.object.flags");var label=plugin.labels.get(name.toLowerCase()+"Control");var action=plugin._myFlags(flags).length>0?"Unflag":"Flag";var flagged=name==="Flag"&&!item.config.get("parent.showFlags")&&plugin.get("flagged");var data={"name":name,"label":!flagged?'\x3cspan class\x3d"echo-clickable"\x3e'+label+"\x3c/span\x3e"+(item.user.is("admin")&&flags.length?" ("+flags.length+")":""):plugin.labels.get("flagged"),"visible":item.user.is("logged")&&action===name,"clickable":!flagged,
"once":true,"callback":callback};if(flagged)data.template="\x3cspan\x3e{data:label}\x3c/span\x3e";return data}};plugin.methods._publishEventComplete=function(args){var item=this.component;this.events.publish({"topic":"on"+args.name+args.state,"data":{"item":{"data":item.get("data"),"target":item.config.get("target")},"response":args.response}})};plugin.methods._myFlags=function(flags){var item=this.component;return $.map(flags,function(entry){if(item.user.has("identity",entry.actor.id))return entry})};
plugin.css=".{plugin.class:flaggedBy} { background: url({config:cdnBaseURL.sdk-assets}/images/curation/status/communityflagged.png) no-repeat 0px 4px; padding: 0px 0px 4px 21px; }";Echo.Plugin.create(plugin)})(Echo.jQuery);
(function(jQuery){var $=jQuery;var plugin=Echo.Plugin.manifest("Edit","Echo.StreamServer.Controls.Stream.Item");if(Echo.Plugin.isDefined(plugin))return;plugin.init=function(){this.component.addButtonSpec("Edit",this._assembleButton())};$.map(["Complete","Error"],function(action){plugin.events["Echo.StreamServer.Controls.Submit.Plugins.Edit.onEdit"+action]=function(topic,args){this.component.render()}});plugin.labels={"editButton":"Edit"};plugin.dependencies=[{"control":"Echo.StreamServer.Controls.Submit",
"url":"{config:cdnBaseURL.sdk}/streamserver.pack.js"}];plugin.methods._submitConfig=function(item,target){return this.config.assemble({"target":target,"data":item.get("data"),"targetURL":item.get("data.object.id")})};plugin.methods._assembleButton=function(){var plugin=this;return function(){var item=this;return{"name":"Edit","label":plugin.labels.get("editButton"),"visible":item.user.is("admin")||item.user.has("identity",item.get("data.actor.id")),"callback":function(){var config=plugin._submitConfig(item,
item.view.get("subcontainer"));config["parent"]=plugin.component.config.getAsHash();config["targetQuery"]=plugin.config.get("query","");config.plugins.push({"name":"Edit"});new Echo.StreamServer.Controls.Submit(config);item.config.get("target").get(0).scrollIntoView(true)}}}};Echo.Plugin.create(plugin)})(Echo.jQuery);
(function(jQuery){var $=jQuery;var plugin=Echo.Plugin.manifest("Edit","Echo.StreamServer.Controls.Submit");if(Echo.Plugin.isDefined(plugin))return;plugin.init=function(){this.extendTemplate("insertAfter","postContainer",plugin.templates.cancel);this.extendTemplate("replace","header",plugin.templates.header);this.component.labels.set({"post":this.labels.get("post"),"posting":this.labels.get("posting")})};plugin.labels={"createdBy":"Created by","edit":"Edit","on":"on","post":"Update","posting":"Updating...",
"cancel":"cancel"};$.map(["Init","Complete","Error"],function(action){plugin.events["Echo.StreamServer.Controls.Submit.onPost"+action]=function(topic,args){if(action==="Init")args.postData.content=this._prepareContent();this.events.publish({"data":args,"topic":"onEdit"+action})}});plugin.templates.header='\x3cdiv class\x3d"{plugin.class:header} echo-primaryFont echo-primaryFont echo-primaryColor"\x3e'+'{plugin.label:createdBy} \x3cspan class\x3d"{plugin.class:author}"\x3e\x3c/span\x3e '+'{plugin.label:on} \x3cspan class\x3d"{plugin.class:editedDate}"\x3e\x3c/span\x3e'+
"\x3c/div\x3e";plugin.templates.cancel='\x3cdiv class\x3d"{plugin.class:cancelButtonContainer}"\x3e'+'\x3ca href\x3d"javascript:void(0);" class\x3d"{plugin.class:cancelButton} echo-primaryFont echo-clickable echo-linkColor"\x3e'+"{plugin.label:cancel}"+"\x3c/a\x3e"+"\x3c/div\x3e";plugin.renderers.author=function(element){var component=this.component;return element.text(component.get("data.actor.title")||component.labels.get("guest"))};plugin.renderers.editedDate=function(element){var published=this.component.get("data.object.published");
if(!published)return element.empty();var date=new Date(Echo.Utils.timestampFromW3CDTF(published)*1E3);return element.text(date.toLocaleDateString()+", "+date.toLocaleTimeString())};plugin.renderers.cancelButton=function(element){var plugin=this;return element.click(function(){plugin.events.publish({"topic":"onEditError"})})};plugin.methods._prepareContent=function(){var submit=this.component;var get=function(name){return submit.view.get(name).val()};return[].concat(this._getMetaDataUpdates("tag",
"tag",get("tags")),this._getMetaDataUpdates("mark","marker",get("markers")),this._prepareActivity("update","comment",get("text")))};plugin.methods._prepareActivity=function(verb,type,data){return!data?[]:{"object":{"objectTypes":["http://activitystrea.ms/schema/1.0/"+type],"content":data},"source":this.component.config.get("source"),"verbs":["http://activitystrea.ms/schema/1.0/"+verb],"targets":[{"id":this.component.get("data.object.id")}]}};plugin.methods._getMetaDataUpdates=function(verb,type,data){var plugin=
this,component=this.component;var extract=function(value){return $.map(value||[],function(item){return $.trim(item)})};var items={"modified":extract(data.split(",")),"current":extract(component.get("data.object."+type+"s"))};var updates=[];var diff=function(a,b,verb){$.map(a,function(item){if(item&&!~$.inArray(item,b))updates.push(plugin._prepareActivity(verb,type,item))})};diff(items.current,items.modified,"un"+verb);diff(items.modified,items.current,verb);return updates};plugin.css=".{plugin.class:cancelButtonContainer} { float: right; margin: 6px 15px 0px 0px; }";
Echo.Plugin.create(plugin)})(Echo.jQuery);
(function(jQuery){var $=jQuery;var plugin=Echo.Plugin.manifest("FormAuth","Echo.StreamServer.Controls.Submit");if(Echo.Plugin.isDefined(plugin))return;plugin.init=function(){if(this._userStatus()==="forcedLogin")this.extendTemplate("replace","header",plugin.templates.forcedLogin);this.extendTemplate("insertBefore","header",plugin.templates.auth);this.component.addPostValidator(this._validator())};plugin.config={"identityManager":{},"submitPermissions":"allowGuest"};plugin.enabled=function(){return this.component.user&&
this.component.user.get("sessionID")&&this.config.get("identityManager.login")&&this.config.get("identityManager.signup")};plugin.labels={"youMustBeLoggedIn":"You must be logged in to comment"};plugin.dependencies=[{"control":"Echo.IdentityServer.Controls.Auth","url":"{config:cdnBaseURL.sdk}/identityserver.pack.js"}];plugin.templates.auth='\x3cdiv class\x3d"{plugin.class:auth}"\x3e\x3c/div\x3e';plugin.templates.forcedLogin='\x3cdiv class\x3d"{class:header} echo-primaryFont"\x3e'+'\x3cspan class\x3d"{plugin.class:forcedLoginMessage} echo-secondaryColor"\x3e'+
"{plugin.label:youMustBeLoggedIn}"+"\x3c/span\x3e"+"\x3c/div\x3e";plugin.component.renderers.header=function(element){var plugin=this;if(plugin._userStatus()==="logged")return element.empty();return plugin.parentRenderer("header",arguments)};plugin.component.renderers.container=function(element){var plugin=this;plugin.parentRenderer("container",arguments);var _class=function(postfix){return plugin.cssPrefix+postfix};return element.removeClass($.map(["logged","anonymous","forcedLogin"],_class).join(" ")).addClass(_class(plugin._userStatus()))};
plugin.renderers.auth=function(element){var plugin=this;new Echo.IdentityServer.Controls.Auth(plugin.config.assemble({"target":element,"identityManager":plugin.config.get("identityManager")}));return element};plugin.methods._validator=function(){var plugin=this,submit=this.component;return function(){if(!submit.user.is("logged")&&plugin._permissions()==="forceLogin"){plugin.view.get("forcedLoginMessage").addClass(plugin.cssPrefix+"error");return false}return true}};plugin.methods._permissions=function(){return this.config.get("submitPermissions")};
plugin.methods._userStatus=function(){return this.component.user.is("logged")?"logged":this._permissions()==="forceLogin"?"forcedLogin":"anonymous"};plugin.css=".{plugin.class:forcedLoginMessage} { font-size: 14px; font-weight: bold; }"+".{plugin.class:error} { color: red; }";Echo.Plugin.create(plugin)})(Echo.jQuery);
(function(jQuery){var $=jQuery;var plugin=Echo.Plugin.manifest("InfiniteScroll","Echo.StreamServer.Controls.Stream");if(Echo.Plugin.isDefined(plugin))return;plugin.init=function(){var plugin=this;var handler=function(event){var element=plugin.component.view.get("more");if(element&&!plugin.get("renderInProgress")&&!plugin.get("requestInProgress")&&$.inviewport(element,{"threshold":0}))element.click()};plugin.set("scrollHandler",handler);$(window).on("scroll",handler)};plugin.events={"Echo.StreamServer.Controls.Stream.onDataReceive":function(){this.set("requestInProgress",
false)},"Echo.StreamServer.Controls.Stream.onMoreButtonPress":function(){this.set("requestInProgress",true);this.set("renderInProgress",true)}};plugin.component.renderers.more=function(element){this.parentRenderer("more",arguments);this.set("renderInProgress",false);return element};plugin.methods.destroy=function(){$(window).off("scroll",this.get("scrollHandler"))};Echo.Plugin.create(plugin)})(Echo.jQuery);
(function(jQuery){var plugin=Echo.Plugin.manifest("ItemAccumulatorDisplay","Echo.StreamServer.Controls.Stream.Item");if(Echo.Plugin.isDefined(plugin))return;plugin.init=function(){this.extendTemplate("insertBefore","modeSwitch",plugin.templates.main)};plugin.config={"countTickTimeout":1,"accumulator":"repliesCount"};plugin.templates.main='\x3cdiv class\x3d"{plugin.class:accumulatorContainer}"\x3e\x3c/div\x3e';plugin.renderers.accumulatorContainer=function(element){var item=this.component;var accName=
this.config.get("accumulator");var accumulator=item.get("data.object.accumulators")[accName];var count=this.get("count")||{};if(typeof count.current==="undefined"){this.set("count",{"actual":accumulator,"current":accumulator});return element.append(accumulator)}this._stopTimer();var container=item.view.get("container");container.stop(true,true);if(count.actual!==accumulator){count.actual=accumulator;this.set("count",count)}element.append(count.current);if(count.current!==count.actual){var bgColor=
this.get("originalBGColor");if(typeof bgColor==="undefined"){bgColor=Echo.Utils.getVisibleColor(container);this.set("originalBGColor",bgColor)}container.css({"backgroundColor":item.config.get("parent.flashColor")});this._animateCounter(bgColor)}return element};plugin.methods._stopTimer=function(){var timer=this.get("timer");if(timer)clearTimeout(timer);this.set("timer",undefined)};plugin.methods._animateCounter=function(bgColor){this._stopTimer();var plugin=this;var count=this.get("count");var item=
this.component;if(typeof count.current!=="undefined"&&count.current===count.actual&&!this.get("animationInProgress")){var container=item.view.get("container");this.set("animationInProgress",true);container.animate({"backgroundColor":bgColor},item.config.get("parent.fadeTimeout"),"linear",function(){container.css("backgroundColor","");plugin.set("animationInProgress",false)});return}this.set("timer",setTimeout(function(){var count=plugin.get("count");if(count.current!==count.actual){count.current<
count.actual?count.current++:count.current--;plugin.set("count.current",count.current);plugin.view.get("accumulatorContainer").html(count.current);plugin._animateCounter(bgColor)}},this.config.get("countTickTimeout")*1E3))};plugin.css=".{plugin.class:accumulatorContainer} { float: right; margin-right: 7px; }";Echo.Plugin.create(plugin)})(Echo.jQuery);
(function(jQuery){var $=jQuery;var plugin=Echo.Plugin.manifest("JanrainAuth","Echo.StreamServer.Controls.Submit");if(Echo.Plugin.isDefined(plugin))return;plugin.init=function(){if(this._userStatus()==="forcedLogin")this.extendTemplate("replace","header",plugin.templates.forcedLogin);this.extendTemplate("insertBefore","header",plugin.templates.auth);this.component.addPostValidator(this._validator())};plugin.config={"appId":"","buttons":["login"],"title":"","height":260,"width":420,"signinWidgetConfig":{},
"submitPermissions":"allowGuest"};plugin.enabled=function(){return this.component.user&&this.component.user.get("sessionID")&&this.config.get("appId")&&this.config.get("buttons").length};plugin.labels={"youMustBeLoggedIn":"You must be logged in to comment"};plugin.dependencies=[{"control":"Echo.IdentityServer.Controls.Auth","url":"{config:cdnBaseURL.sdk}/identityserver.pack.js"}];plugin.templates.auth='\x3cdiv class\x3d"{plugin.class:auth}"\x3e\x3c/div\x3e';plugin.templates.forcedLogin='\x3cdiv class\x3d"echo-primaryFont {class:header}"\x3e'+
'\x3cspan class\x3d"echo-secondaryColor {plugin.class:forcedLoginMessage}"\x3e'+"{plugin.label:youMustBeLoggedIn}"+"\x3c/span\x3e"+"\x3c/div\x3e";plugin.component.renderers.header=function(element){var plugin=this;if(plugin._userStatus()==="logged")return element.empty();return plugin.parentRenderer("header",arguments)};plugin.component.renderers.container=function(element){var plugin=this;plugin.parentRenderer("container",arguments);var _class=function(postfix){return plugin.cssPrefix+postfix};return element.removeClass($.map(["logged",
"anonymous","forcedLogin"],_class).join(" ")).addClass(_class(plugin._userStatus()))};plugin.renderers.auth=function(element){var plugin=this,fields=["appId","title","width","height","buttons","signinWidgetConfig"];var janrainConnectorPlugin=Echo.Utils.foldl({"name":"JanrainConnector"},fields,function(param,acc){if(plugin.config.get(param))acc[param]=plugin.config.get(param);return acc});new Echo.IdentityServer.Controls.Auth(plugin.config.assemble({"target":element,"plugins":[janrainConnectorPlugin]}));
return element};plugin.methods._validator=function(){var plugin=this,submit=this.component;return function(){if(!submit.user.is("logged")&&plugin._permissions()==="forceLogin"){plugin.view.get("forcedLoginMessage").addClass(plugin.cssPrefix+"error");return false}return true}};plugin.methods._permissions=function(){return this.config.get("submitPermissions")};plugin.methods._userStatus=function(){return this.component.user.is("logged")?"logged":this._permissions()==="forceLogin"?"forcedLogin":"anonymous"};
plugin.css=".{plugin.class:forcedLoginMessage} { font-size: 14px; font-weight: bold; }"+".{plugin.class:error} { color: red; }";Echo.Plugin.create(plugin)})(Echo.jQuery);
(function(jQuery){var $=jQuery;var plugin=Echo.Plugin.manifest("JanrainSharing","Echo.StreamServer.Controls.Submit");if(Echo.Plugin.isDefined(plugin))return;plugin.init=function(){if(!this._isLegacy()&&!this.config.get("alwaysShare"))this.extendTemplate("insertBefore","postButton",plugin.templates.share)};plugin.config={"appId":"","alwaysShare":false,"sharingWidgetConfig":{},"maxLength":120,"reducedLength":30,"maxImagesCount":5};plugin.enabled=function(){return this.config.get("appId")};plugin.dependencies=
[{"loaded":function(){return!!Echo.GUI},"url":"{config:cdnBaseURL.sdk}/gui.pack.js"},{"url":"{config:cdnBaseURL.sdk}/gui.pack.css"}];plugin.events={"Echo.StreamServer.Controls.Submit.onPostInit":function(topic,args){if(this._isLegacy())return;this.set("needShare",this.config.get("alwaysShare")||this.view.get("shareCheckbox").prop("checked"))},"Echo.StreamServer.Controls.Submit.onPostComplete":function(topic,args){var plugin=this;if(plugin._isLegacy()){this._shareLegacy(args);return}if(!this.get("needShare"))return;
this._share(this._prepareData(args))}};plugin.labels={"share":"Share this comment","sharePrompt":"Share your comment:"};plugin.templates.share='\x3cdiv class\x3d"echo-secondaryFont {plugin.class:shareContainer}"\x3e'+'\x3cinput type\x3d"checkbox" class\x3d"{plugin.class:shareCheckbox}"\x3e'+'\x3cspan class\x3d"{plugin.class:shareLabel}"\x3e{plugin.label:share}\x3c/span\x3e'+"\x3c/div\x3e";plugin.methods._share=function(data){var url,plugin=this;var callback=function(){plugin.set("foreignConfig",$.extend(true,
{},janrain.engage.share.getState()));plugin._showPopup(data)};if(window.janrain&&janrain.engage&&janrain.engage.share||plugin.get("janrainInitialized")){callback();return}plugin.set("janrainInitialized",true);if(typeof window.janrain!=="object")window.janrain={};if(typeof janrain.settings!=="object")janrain.settings={};if(typeof janrain.settings.share!=="object")janrain.settings.share={};if(typeof janrain.settings.packages!=="object")janrain.settings.packages=[];janrain.settings.packages.push("share");
janrain.ready=true;var foreignOnload=window.janrainShareOnload;window.janrainShareOnload=function(){if(foreignOnload){foreignOnload();window.janrainShareOnload=foreignOnload}callback()};url="https:"===document.location.protocol?"https://rpxnow.com/js/lib/"+plugin.config.get("appId")+"/widget.js":"http://widget-cdn.rpxnow.com/js/lib/"+plugin.config.get("appId")+"/widget.js";Echo.Loader.download([{"url":url}])};plugin.methods._showPopup=function(data){var image,plugin=this;var share=janrain.engage.share;
var idx=janrain.events.onModalClose.addHandler(function(){janrain.events.onModalClose.removeHandler(idx);share.reset();share.setState(plugin.get("foreignConfig"));plugin.remove("foreignConfig")});var config=plugin.config.get("sharingWidgetConfig");share.reset();share.setState(config);share.setTitle(config.title||$('meta[property\x3d"og:title"]').attr("content")||document.title);share.setDescription(config.description||$('meta[property\x3d"og:description"]').attr("content")||"");share.setMessage(config.message||
Echo.Utils.stripTags(data.object.content));share.setUrl(config.url||$('meta[property\x3d"og:url"]').attr("content")||location.href.replace(/([#\?][^#\?]*)+$/,""));image=config.image||$('meta[property\x3d"og:image"]').attr("content")||"";image&&share.setImage(image);share.show()};plugin.methods._prepareData=function(data){var item=data.postData.content[0];return{"origin":"submit","actor":{"id":this.component.user.get("identityUrl"),"name":item.actor.name,"avatar":item.actor.avatar},"object":{"id":data.request.response.objectID,
"content":item.object.content},"source":item.source,"target":data.targetURL}};plugin.methods._isLegacy=function(){return this.config.get("xdReceiver")};plugin.methods._shareLegacy=function(args){var plugin=this;Echo.Loader.download([{"loaded":function(){return!!window.RPXNOW},"url":("https:"===document.location.protocol?"https://":"http://static.")+"rpxnow.com/js/lib/rpx.js"}],function(){RPXNOW.init({"appId":plugin.config.get("appId"),"xdReceiver":plugin.config.get("xdReceiver")});RPXNOW.loadAndRun(["Social"],
function(){var activity=new RPXNOW.Social.Activity(plugin.config.get("activity.sharePrompt",plugin.labels.get("sharePrompt")),plugin._prepareContentLegacy(args),plugin.config.get("activity.itemURL",args.targetURL));RPXNOW.Social.publishActivity(plugin._prepareActivityLegacy(activity))})})};plugin.methods._prepareActivityLegacy=function(act){var plugin=this;var activity=act;var handlers={"activity.pageDescription":function(content){activity.setDescription(content)},"activity.pageTitle":function(content){activity.setTitle(content)},
"activity.pageImages":function(content){var count=0;var maxCount=plugin.config.get("maxImagesCount");var collection=new RPXNOW.Social.ImageMediaCollection;$.each(content,function(key,image){if(count===maxCount)return false;if(image.src&&image.href){collection.addImage(image.src,image.href);count++}});activity.setMediaItem(collection)}};$.each(handlers,function(key,handler){if(plugin.config.get(key))handler(plugin.config.get(key))});return activity};plugin.methods._prepareContentLegacy=function(args){var plugin=
this;var text=Echo.Utils.stripTags(args.postData.content[0].object.content);var messagePattern=plugin.config.get("activity.shareContent");if(messagePattern)return plugin.labels.get(messagePattern,{"domain":window.location.host,"content":plugin._truncate(text,plugin.config.get("reducedLength"))});var data=args.inReplyTo;var maxLength=plugin.config.get("maxLength");if(plugin._isReplyToTweet(data)){var author=plugin._getTweetAuthor(data);return plugin.labels.get("@{author} {content}",{"author":author,
"content":plugin._truncate(text,maxLength-author.length-2)})}return plugin._truncate(text,maxLength)};plugin.methods._truncate=function(text,limit){return limit>0&&text.length>limit?text.substring(0,limit)+"...":text};plugin.methods._isReplyToTweet=function(data){return!!(data&&data.source&&data.source.name==="Twitter")};plugin.methods._getTweetAuthor=function(data){return data.actor.id.replace(/https?\:\/\/twitter\.com\//,"")};plugin.css=".{plugin.class:shareContainer} { display: inline-block; margin: 0px 15px 0px 0px; }"+
".echo-sdk-ui .{plugin.class:shareContainer} input.{plugin.class:shareCheckbox} { margin: 0px; margin-right: 3px; padding: 0px; }";Echo.Plugin.create(plugin)})(Echo.jQuery);
(function(jQuery){var plugin=Echo.Plugin.manifest("JanrainSharing","Echo.StreamServer.Controls.Stream.Item");if(Echo.Plugin.isDefined(plugin))return;plugin.init=function(){this.component.addButtonSpec("Share",this._assembleButton())};plugin.config={"appId":"","sharingWidgetConfig":{}};plugin.enabled=function(){return this.config.get("appId")};plugin.dependencies=[{"loaded":function(){return!!Echo.GUI},"url":"{config:cdnBaseURL.sdk}/gui.pack.js"},{"url":"{config:cdnBaseURL.sdk}/gui.pack.css"}];plugin.labels=
{"shareButton":"Share"};plugin.methods._share=Echo.StreamServer.Controls.Submit.Plugins.JanrainSharing.prototype._share;plugin.methods._showPopup=Echo.StreamServer.Controls.Submit.Plugins.JanrainSharing.prototype._showPopup;plugin.methods._prepareData=function(item){return{"origin":"item","actor":{"id":item.actor.id,"name":item.actor.title,"avatar":item.actor.avatar},"object":{"id":item.object.id,"content":item.object.content},"source":item.source,"target":item.target.id}};plugin.methods._assembleButton=
function(){var plugin=this,item=this.component;var callback=function(){plugin._share(plugin._prepareData(item.get("data")))};return function(){return{"name":"Share","label":plugin.labels.get("shareButton"),"callback":callback}}};Echo.Plugin.create(plugin)})(Echo.jQuery);
(function(jQuery){var $=jQuery;var plugin=Echo.Plugin.manifest("Like","Echo.StreamServer.Controls.Stream.Item");if(Echo.Plugin.isDefined(plugin))return;plugin.init=function(){this.extendTemplate("insertAsLastChild","data",plugin.templates.main);this.component.addButtonSpec("Like",this._assembleButton("Like"));this.component.addButtonSpec("Like",this._assembleButton("Unlike"))};plugin.config={"asyncFacePileRendering":false};plugin.labels={"likeThis":" like this.","likesThis":" likes this.","likeControl":"Like",
"unlikeControl":"Unlike","likeProcessing":"Liking...","unlikeProcessing":"Unliking..."};plugin.dependencies=[{"control":"Echo.StreamServer.Controls.FacePile","url":"{config:cdnBaseURL.sdk}/streamserver.pack.js"}];plugin.events={"Echo.StreamServer.Controls.FacePile.Item.Plugins.Like.onUnlike":function(topic,args){this._sendActivity("Unlike",this.component,args.actor);return{"stop":["bubble"]}}};plugin.templates.main='\x3cdiv class\x3d"{plugin.class:likedBy}"\x3e\x3c/div\x3e';plugin.renderers.likedBy=
function(element){var plugin=this;var item=this.component;if(!item.get("data.object.likes").length)return element.hide();var likesPerPage=5;var visibleUsersCount=plugin.get("facePile")?plugin.get("facePile").getVisibleUsersCount():likesPerPage;var youLike=false;var userId=item.user.get("identityUrl");var users=item.get("data.object.likes");$.each(users,function(i,like){if(like.actor.id===userId){youLike=true;return false}});var config=plugin.config.assemble({"target":element.get(0),"data":{"itemsPerPage":likesPerPage,
"entries":users},"initialUsersCount":visibleUsersCount,"totalUsersCount":item.get("data.object.accumulators.likesCount"),"suffixText":plugin.labels.get(users.length>1||youLike?"likeThis":"likesThis")});config.plugins.push({"name":"Like"});if(item.user.is("admin"))element.addClass(plugin.cssPrefix+"highlight");if(this.config.get("asyncFacePileRendering"))setTimeout($.proxy(this._initFacePile,this,config),0);else this._initFacePile(config);return element.show()};plugin.methods._initFacePile=function(config){this.set("facePile",
new Echo.StreamServer.Controls.FacePile(config))};plugin.methods._sendRequest=function(data,callback,errorCallback){Echo.StreamServer.API.request({"endpoint":"submit","secure":this.config.get("useSecureAPI",false,true),"submissionProxyURL":this.component.config.get("submissionProxyURL"),"onData":callback,"onError":errorCallback,"data":data}).send()};plugin.methods._sendActivity=function(name,item,actor){var plugin=this;var activity={"verbs":["http://activitystrea.ms/schema/1.0/"+name.toLowerCase()],
"targets":[{"id":item.get("data.object.id")}]};if(actor&&actor.id)activity.author=actor.id;this._sendRequest({"content":activity,"appkey":item.config.get("appkey"),"sessionID":item.user.get("sessionID"),"target-query":item.config.get("parent.query")},function(response){plugin._publishEventComplete({"name":name,"state":"Complete","response":response});plugin.requestDataRefresh()},function(response){plugin._publishEventComplete({"name":name,"state":"Error","response":response})})};plugin.methods._publishEventComplete=
function(args){var item=this.component;this.events.publish({"topic":"on"+args.name+args.state,"data":{"item":{"data":item.get("data"),"target":item.config.get("target")},"response":args.response}})};plugin.methods._assembleButton=function(name){var plugin=this;var callback=function(){var item=this;item.get("buttons."+plugin.name+"."+name+".element").empty().append(plugin.labels.get(name.toLowerCase()+"Processing"));plugin._sendActivity(name,item)};return function(){var item=this;var action=$.map(item.get("data.object.likes"),
function(entry){if(item.user.has("identity",entry.actor.id))return entry}).length>0?"Unlike":"Like";return{"name":name,"label":plugin.labels.get(name.toLowerCase()+"Control"),"visible":item.user.is("logged")&&action===name,"once":true,"callback":callback}}};plugin.css=".{plugin.class:likedBy} { background: url({config:cdnBaseURL.sdk-assets}/images/likes.png) no-repeat 0px 4px; padding: 0px 0px 4px 21px; }"+".{plugin.class:highlight} { line-height: 23px; }";Echo.Plugin.create(plugin)})(Echo.jQuery);
(function(jQuery){var plugin=Echo.Plugin.manifest("Like","Echo.StreamServer.Controls.FacePile.Item");if(Echo.Plugin.isDefined(plugin))return;plugin.init=function(){this.extendTemplate("insertAsLastChild","container",plugin.templates.main)};plugin.labels={"unlikeOnBehalf":"Unlike on behalf of this user"};plugin.templates.main='\x3cimg class\x3d"{plugin.class:adminUnlike}" src\x3d"{config:cdnBaseURL.sdk-assets}/images/container/closeWindow.png"" title\x3d"{plugin.label:unlikeOnBehalf}" width\x3d"10" height\x3d"9"\x3e';
plugin.component.renderers.container=function(element){this.parentRenderer("container",arguments);if(this.component.user.is("admin"))element.addClass(this.cssPrefix+"highlight")};plugin.renderers.adminUnlike=function(element){var plugin=this;var item=this.component;if(!item.user.is("admin"))return element.remove();return element.one("click",function(){item.view.get("container").css("opacity",.3);plugin.events.publish({"topic":"onUnlike","data":{"actor":item.get("data"),"target":item.config.get("parent.target").get(0)},
"global":false,"propagation":false})})};plugin.css=".{plugin.class:adminUnlike} { cursor: pointer; margin-left: 3px; }"+".{plugin.class:highlight} { display: inline-block; line-height: 16px; background-color: #EEEEEE; padding: 1px 3px; border: 1px solid #D2D2D2; border-radius: 5px; -moz-border-radius: 5px; -webkit-border-radius: 5px; margin: 0px 2px; }";Echo.Plugin.create(plugin)})(Echo.jQuery);
(function(jQuery){var $=jQuery;var plugin=Echo.Plugin.manifest("MetadataManager","Echo.StreamServer.Controls.Stream.Item");if(Echo.Plugin.isDefined(plugin))return;plugin.init=function(){var self=this,item=this.component;$.each(this.config.get("controls"),function(i,control){item.addButtonSpec("MetadataManager",self._assembleButton("Mark",control));item.addButtonSpec("MetadataManager",self._assembleButton("Unmark",control))})};plugin.labels={"markProcessing":"Adding {type} {marker}...","unmarkProcessing":"Removing {type} {marker}..."};
plugin.methods._assembleButton=function(action,control){var self=this;var type=control.marker?"marker":"tag";var marker=control.marker||control.tag;var name=action+"As"+Echo.Utils.capitalize(marker.replace(/[^a-z0-9_-]/ig,""));var callback=function(){var item=this;var operation=action.toLowerCase();item.get("buttons."+plugin.name+"."+name+".element").empty().append(self.labels.get(operation+"Processing",{"type":type,"marker":marker}));var verb=type==="tag"?operation.replace(/mark/g,"tag"):operation;
var activity={"verbs":["http://activitystrea.ms/schema/1.0/"+verb],"targets":[{"id":item.get("data.object.id")}],"object":{"objectTypes":["http://activitystrea.ms/schema/1.0/"+type],"content":marker}};var publishCompleteEvent=self._prepareCompleteEventPublish({"name":name,"type":type,"action":action});Echo.StreamServer.API.request({"endpoint":"submit","secure":this.config.get("useSecureAPI",false,true),"submissionProxyURL":item.config.get("submissionProxyURL"),"onData":function(response){publishCompleteEvent("Complete",
response);self.requestDataRefresh()},"onError":function(response){publishCompleteEvent("Error",response)},"data":{"appkey":item.config.get("appkey"),"content":activity,"target-query":item.config.get("parent.query",""),"sessionID":item.user.get("sessionID","")}}).send()};return function(){return{"name":name,"label":control["label"+action],"visible":self._isButtonVisible(control,marker,action,type),"once":true,"callback":callback}}};plugin.methods._prepareCompleteEventPublish=function(args){var self=
this;var item=this.component;var publishArgs={"data":{"item":{"data":item.get("data"),"target":item.get("view.content")},"type":args.type,"name":args.name}};return function(state,response){self.events.publish($.extend(true,publishArgs,{"topic":"on"+args.action+state,"data":{"response":response}}))}};plugin.methods._isButtonVisible=function(control,marker,action,type){var item=this.component;var visible=!~$.inArray(marker,item.get("data.object."+type+"s")||[])^action==="Unmark";if(!visible||!item.user.is("logged"))return false;
if(item.user.is("admin"))return true;var customProxyURL=item.config.get("submissionProxyURL");if(type==="marker"&&!customProxyURL)return false;control.visible=item.invoke(control.visible);if($.isEmptyObject(control.visible))return false;var isVisible=true;$.each(["state","roles","markers"],function(i,field){var values=control.visible["user."+field];if(values){values=typeof values==="string"?[values]:values;if(!item.user.any(field,values)){isVisible=false;return false}}});return!!isVisible};Echo.Plugin.create(plugin)})(Echo.jQuery);
(function(jQuery){var $=jQuery;var plugin=Echo.Plugin.manifest("Moderation","Echo.StreamServer.Controls.Stream.Item");if(Echo.Plugin.isDefined(plugin))return;plugin.init=function(){var self=this;var item=this.component;var actions=this.config.get("itemActions").concat(this.config.get("userActions"));this.extendTemplate("insertAfter","avatar",plugin.templates.status);$.each(actions,function(i,action){var buttons=plugin.actionButtons[action];if(buttons&&$.isArray(buttons))$.each(buttons,function(j,
button){item.addButtonSpec("Moderation",self["_assemble"+Echo.Utils.capitalize(action)+"Button"](button))});else item.addButtonSpec("Moderation",self._assembleButton(Echo.Utils.capitalize(action)))})};plugin.config={"removePersonalItemsAllowed":false,"userActions":["ban","permissions"],"itemActions":["approve","spam","delete"]};plugin.events={"Echo.StreamServer.Controls.Stream.Plugins.Moderation.onUserUpdate":function(topic,args){var target=this.component;var source=args.item;if(target.get("data.actor.id")!==
source.data.actor.id)return;target.set("data.actor."+(args.field==="state"?"status":args.field),args.value);target.render();return{"stop":["bubble"]}}};plugin.labels={"approveButton":"Approve","deleteButton":"Delete","spamButton":"Spam","untouchButton":"Untouch","changingStatusToCommunityFlagged":"Flagging...","changingStatusToModeratorApproved":"Approving...","changingStatusToModeratorDeleted":"Deleting...","changingStatusToUserDeleted":"Deleting...","changingStatusToUntouched":"Untouching...","changingStatusToModeratorFlagged":"Marking as spam...",
"statusCommunityFlagged":"Flagged by Community","statusModeratorApproved":"Approved by Moderator","statusModeratorDeleted":"Deleted by Moderator","statusUserDeleted":"Deleted by User","statusModeratorFlagged":"Flagged by Moderator","statusSystemFlagged":"Flagged by System","banUser":"Ban User","unbanUser":"Unban","userBanned":"Banned User","processingAction":"Setting up '{state}' user state...","moderatorRole":"Moderator","administratorRole":"Administrator","userButton":"Demote to User","moderatorButton":"Promote to Moderator",
"administratorButton":"Promote to Admin","setRoleAction":"Setting up '{role}' role...","unsetRoleAction":"Removing '{role}' role...","statusUntouched":"New"};plugin.templates.buttonLabels={"banned":'\x3cspan class\x3d"{plugin.class:button-state} {plugin.class:button-state-banned}"\x3e{plugin.label:userBanned}\x3c/span\x3e'+'(\x3cspan class\x3d"echo-clickable"\x3e{plugin.label:unbanUser}\x3c/span\x3e)',"unbanned":'\x3cspan class\x3d"echo-clickable"\x3e{plugin.label:banUser}\x3c/span\x3e'};plugin.templates.status=
'\x3cdiv class\x3d"{plugin.class:status}"\x3e'+'\x3cdiv class\x3d"{plugin.class:statusIcon}"\x3e\x3c/div\x3e'+'\x3cdiv class\x3d"echo-clear"\x3e\x3c/div\x3e'+"\x3c/div\x3e";plugin.renderers.status=function(element){var item=this.component;if(!item.user.is("admin")){element.hide();return element}if(item.get("depth"))element.addClass(this.cssPrefix+"status-child");var status=item.get("data.object.status")||"Untouched";return element.addClass(this.cssPrefix+"status-"+status)};plugin.renderers.statusIcon=
function(element){var item=this.component;if(!item.user.is("admin"))return element;var status=item.get("data.object.status")||"Untouched";var title=this.labels.get("status"+status);return element.addClass(this.cssPrefix+"status-icon-"+status).attr("title",title)};plugin.statuses=["Untouched","ModeratorApproved","ModeratorDeleted","UserDeleted","CommunityFlagged","ModeratorFlagged","SystemFlagged"];plugin.button2status={"Spam":"ModeratorFlagged","Delete":"ModeratorDeleted","Approve":"ModeratorApproved",
"Untouch":"Untouched"};plugin.actionButtons={"ban":["Ban","UnBan"],"permissions":["UserPermissions"]};plugin.roles=["","moderator","administrator"];plugin.methods._changeItemStatus=function(status){var item=this.component;this.set("selected",false);item.set("data.object.status",status);item.view.render({"name":"buttons"});this.view.render({"name":"status","recursive":true})};plugin.methods._sendRequest=function(data,callback,errorCallback){Echo.StreamServer.API.request({"endpoint":"submit","secure":this.config.get("useSecureAPI",
false,true),"submissionProxyURL":this.component.config.get("submissionProxyURL"),"onData":callback,"onError":errorCallback,"data":data}).send()};plugin.methods._publishCompleteActionEvent=function(args){this.events.publish({"topic":"on"+args.name+args.state,"data":{"item":{"data":this.component.get("data"),"target":this.component.get("view.content")},"response":args.response}})};plugin.methods._assembleButton=function(name){var self=this;var getStatus=function(item){var status=plugin.button2status[name];
if(!item.user.is("admin")&&name==="Delete"&&self.config.get("removePersonalItemsAllowed")&&item.user.has("identity",item.data.actor.id))status="UserDeleted";return status};var callback=function(){var item=this;var status=getStatus(item);item.block(self.labels.get("changingStatusTo"+status));var activity={"verbs":["http://activitystrea.ms/schema/1.0/update"],"targets":[{"id":item.get("data.object.id")}],"actor":{"title":item.get("data.actor.id")},"object":{"state":status}};self._sendRequest({"content":activity,
"appkey":item.config.get("appkey"),"sessionID":item.user.get("sessionID"),"target-query":item.config.get("parent.query")},function(response){self._publishCompleteActionEvent({"name":name,"state":"Complete","response":response});self._changeItemStatus(status);self.requestDataRefresh()},function(response){self._publishCompleteActionEvent({"name":name,"state":"Error","response":response});item.unblock()})};return function(){var item=this;var status=getStatus(item);return{"name":name,"label":self.labels.get(name.toLowerCase()+
"Button"),"visible":item.get("data.object.status")!==status&&(item.user.is("admin")||status==="UserDeleted"),"callback":callback}}};plugin.methods._sendUserUpdate=function(config){var item=this.component;Echo.IdentityServer.API.request({"endpoint":"update","submissionProxyURL":this.component.config.get("submissionProxyURL"),"secure":this.config.get("useSecureAPI",false,true),"data":{"content":{"field":config.field,"value":config.value,"identityURL":item.get("data.actor.id"),"username":item.get("data.actor.title")},
"appkey":item.config.get("appkey"),"sessionID":item.user.get("sessionID",""),"target-query":item.config.get("parent.query","")},"onData":config.onData,"onError":function(){item.render()}}).send()};plugin.methods._assembleBanButton=function(action){var self=this;var callback=function(){var item=this;var newState=action==="Ban"?"ModeratorBanned":"Untouched";item.get("buttons."+plugin.name+"."+action+".element").empty().append(self.labels.get("processingAction",{"state":newState}));self._sendUserUpdate({"field":"state",
"value":newState,"onData":function(response){self._publishCompleteActionEvent({"name":action,"state":"Complete","response":response});self._publishUserUpdateEvent({"item":item,"field":"state","value":newState})},"onError":function(response){self._publishCompleteActionEvent({"name":action,"state":"Error","response":response})}})};return function(){var item=this;var isBanned=self._isUserBanned();var visible=item.get("data.actor.id")!==item.user.config.get("fakeIdentityURL")&&isBanned^action==="Ban";
return{"name":action,"label":self.substitute({"template":plugin.templates.buttonLabels[isBanned?"banned":"unbanned"]}),"visible":visible&&item.user.is("admin"),"callback":callback,"once":true}}};plugin.methods._assemblePermissionsButton=function(action){var self=this;var callback=function(){var item=this;var role=self._getRole();var next=self._getNextRole(role);var roles=next!==""?(item.get("data.actor.roles")||[]).concat(next):Echo.Utils.foldl([],item.get("data.actor.roles")||[],function(_role,acc){if($.inArray(_role,
plugin.roles)<0)acc.push(_role)});var label=next===""?"unset":"set";item.get("buttons."+plugin.name+"."+action+".element").empty().append(self.labels.get(label+"RoleAction",{"role":next||role}));self._sendUserUpdate({"field":"roles","value":roles.length?roles.join(","):"-","onData":function(response){self._publishCompleteActionEvent({"name":action,"state":"Complete","response":response});self._publishUserUpdateEvent({"item":item,"field":"roles","value":roles})},"onError":function(response){self._publishCompleteActionEvent({"name":action,
"state":"Error","response":response})}})};return function(){var item=this;var role=self._getRole();var template=role?'\x3cspan class\x3d"{plugin.class:button-role} {plugin.class:button-role}-{data:role}"\x3e{data:label}\x3c/span\x3e'+'(\x3cspan class\x3d"echo-clickable"\x3e{data:button}\x3c/span\x3e)':'\x3cspan class\x3d"echo-clickable"\x3e{data:button}\x3c/span\x3e';var label=self.substitute({"template":template,"data":{"role":role,"label":role?self.labels.get(role+"Role"):"","button":self.labels.get((self._getNextRole(role)||
"user")+"Button")}});return{"name":action,"label":label,"visible":item.get("data.actor.id")!==item.user.config.get("fakeIdentityURL")&&item.user.any("roles",["administrator"]),"callback":callback,"once":true}}};plugin.methods._publishUserUpdateEvent=function(data){this.events.publish({"topic":"onUserUpdate","data":{"item":data.item,"field":data.field,"value":data.value},"global":false,"propagation":false});this.requestDataRefresh()};plugin.methods._isUserBanned=function(){return this.component.get("data.actor.status")===
"ModeratorBanned"};plugin.methods._getRole=function(){var result="";$.each(this.component.get("data.actor.roles")||[],function(id,role){if($.inArray(role,plugin.roles)>0){result=role;if(role==="administrator")return false}});return result};plugin.methods._getNextRole=function(role){return plugin.roles[($.inArray(role,plugin.roles)+1)%plugin.roles.length]};plugin.css=function(){return".{plugin.class:status} { width: 48px; height: 24px; }"+".{plugin.class:status-child} { width: 24px; height: 24px; }"+
".{plugin.class:statusIcon} { float: right; margin: 4px; width: 16px; height: 16px; }"+".{plugin.class:status-Untouched} { background: #00aaff; }"+".{plugin.class:status-ModeratorApproved} { background: #bdfb6d; }"+".{plugin.class:status-ModeratorDeleted} { background: #f20202; }"+".{plugin.class:status-UserDeleted} { background: #ff8e8e; }"+".{plugin.class:status-SystemFlagged}, .{plugin.class:status-CommunityFlagged}, .{plugin.class:status-ModeratorFlagged} { background: #ff9e00; }"+".{plugin.class:button-state} { margin-right: 3px; }"+
".{plugin.class:button-state-banned} { color: #FF0000; }"+".{plugin.class:button-role} { margin-right: 3px; }"+".{plugin.class:button-role-moderator} { color: #0000FF; }"+".{plugin.class:button-role-administrator} { color: #008000; }"+$.map(plugin.statuses,function(name){return".{plugin.class:status-icon-"+name+"} { background: url({config:cdnBaseURL.sdk-assets}/images/curation/status/"+name.toLowerCase()+".png) no-repeat; }"}).join("")}();Echo.Plugin.create(plugin)})(Echo.jQuery);
(function(jQuery){var plugin=Echo.Plugin.manifest("Moderation","Echo.StreamServer.Controls.Stream");plugin.events={"Echo.StreamServer.Controls.Stream.Item.Plugins.Moderation.onUserUpdate":function(topic,args){this.events.publish({"topic":"onUserUpdate","data":args,"global":false});return{"stop":["bubble"]}}};Echo.Plugin.create(plugin)})(Echo.jQuery);
(function(jQuery){var $=jQuery;var plugin=Echo.Plugin.manifest("Reply","Echo.StreamServer.Controls.Stream.Item");if(Echo.Plugin.isDefined(plugin))return;plugin.init=function(){var self=this,item=this.component;this.extendTemplate("insertAsLastChild","content",plugin.templates.form);var form=Echo.Utils.get(Echo.Variables,this._getSubmitKey());$.each(form||{},function(key,value){self.set(key,value)});item.addButtonSpec("Reply",this._assembleButton());this.set("documentClickHandler",this._getClickHandler());
$(document).on("click",this.get("documentClickHandler"))};plugin.config={"actionString":"Write a reply..."};plugin.labels={"replyControl":"Reply"};plugin.dependencies=[{"control":"Echo.StreamServer.Controls.Submit","url":"{config:cdnBaseURL.sdk}/streamserver.pack.js"}];plugin.events={"Echo.StreamServer.Controls.Stream.Plugins.Reply.onFormExpand":function(topic,args){var item=this.component;var context=item.config.get("context");if(this.get("expanded")&&context&&context!==args.context)this._hideSubmit()},
"Echo.StreamServer.Controls.Submit.onPostComplete":function(topic,args){this._hideSubmit()},"Echo.StreamServer.Controls.Stream.Item.onRender":function(topic,args){if(this.get("expanded"))this._showSubmit()}};plugin.templates.form='\x3cdiv class\x3d"{plugin.class:replyForm}"\x3e'+'\x3cdiv class\x3d"{plugin.class:submitForm}"\x3e\x3c/div\x3e'+'\x3cdiv class\x3d"{plugin.class:compactForm}"\x3e'+'\x3cdiv class\x3d"{plugin.class:compactContent} {plugin.class:compactBorder}"\x3e'+'\x3cinput type\x3d"text" class\x3d"{plugin.class:compactField} echo-primaryFont echo-secondaryColor"\x3e'+
"\x3c/div\x3e"+"\x3c/div\x3e"+"\x3c/div\x3e";plugin.component.renderers.container=function(element){var item=this.component;var threading=item.threading;if(this.get("expanded"))item.threading=true;item.parentRenderer("container",arguments);item.threading=threading;return element};plugin.component.renderers.children=function(element){var item=this.component;if(item.get("children").length===1){var child=item.get("children")[0];if(child.get("added")||child.get("deleted")){this._itemCSS("remove",item,
this.view.get("compactForm"));this.view.render({"name":"compactForm"})}}return item.parentRenderer("children",arguments)};plugin.renderers.submitForm=function(element){element.click(function(event){event.stopPropagation()});return this.get("expanded")?element.show():element.empty().hide()};plugin.renderers.compactForm=function(element){var item=this.component;var hasChildren=!!item.children.length;if(!item.get("depth")&&hasChildren&&!this.get("expanded")&&!item.get("children")[0].get("deleted")){this._itemCSS("add",
item,element);return element.show()}this._itemCSS("remove",item,this.view.get("compactForm"));return element.hide()};plugin.renderers.compactField=function(element){var plugin=this;return element.focus(function(){plugin._showSubmit()}).val(this.config.get("actionString"))};plugin.methods.destroy=function(){if(this.get("submit"))Echo.Utils.set(Echo.Variables,this._getSubmitKey(),{"expanded":this.get("expanded"),"data":{"object":this._getSubmitData()}});$(document).off("click",this.get("documentClickHandler"))};
plugin.methods._submitConfig=function(target){var plugin=this,item=this.component;return plugin.config.assemble({"target":target,"targetURL":item.get("data.object.id"),"parent":item.config.getAsHash(),"data":plugin.get("data")||{},"targetQuery":item.config.get("query",""),"ready":function(){plugin.set("submit",this);plugin._expand()}})};plugin.methods._showSubmit=function(){var item=this.component;var target=this.view.get("submitForm");this._itemCSS("add",item,this.view.get("submitForm"));var submit=
this.get("submit");if(submit){submit.config.set("target",target);submit.render();this._expand();return target}var config=this._submitConfig(target);config.plugins.push({"name":"Reply","inReplyTo":item.get("data")});new Echo.StreamServer.Controls.Submit(config);return target};plugin.methods._hideSubmit=function(){var item=this.component;var submit=this.get("submit");if(submit)submit.set("data",undefined);this.set("expanded",false);this._itemCSS("remove",item,this.view.get("submitForm"));this.view.get("submitForm").empty();
this.view.render({"name":"compactForm"});item.view.render({"name":"container"});this.events.publish({"topic":"onCollapse"})};plugin.methods._expand=function(){var item=this.component;this.set("expanded",true);this.view.render({"name":"submitForm"});this.view.render({"name":"compactForm"});this.events.publish({"topic":"onExpand","data":{"context":item.config.get("context")}});item.view.render({"name":"container"})};plugin.methods._getClickHandler=function(){var plugin=this;return function(){var submit=
plugin.get("submit");if(plugin.get("expanded")&&submit&&!submit.view.get("text").val())plugin._hideSubmit()}};plugin.methods._assembleButton=function(){var plugin=this;var callback=function(){plugin._showSubmit()};return function(){var item=this;return{"name":"Reply","label":plugin.labels.get("replyControl"),"visible":item.get("depth")<item.config.get("parent.children.maxDepth"),"callback":callback}}};plugin.methods._itemCSS=function(action,item,element){$.each(["container","container-child","depth-"+
(item.get("depth")+1)],function(i,css){element[action+"Class"](item.get("cssPrefix")+css)});element[action+"Class"]("echo-trinaryBackgroundColor")};plugin.methods._getSubmitKey=function(){var item=this.component;var applicationContext=item.config.get("context").split("/")[0];return"forms."+item.data.unique+"-"+applicationContext};plugin.methods._getSubmitData=function(){var data={};var submit=this.get("submit");data["content"]=submit.view.get("text").val();$.map(["tags","markers"],function(field){var elements=
submit.view.get(field).val().split(", ");data[field]=elements||[]});return data};plugin.css=".{plugin.class:compactContent} { padding: 5px 5px 5px 6px; background-color: #fff; }"+".{plugin.class:compactBorder} { border: 1px solid #d2d2d2; }"+".{plugin.class:compactContent} input.{plugin.class:compactField}[type\x3d'text'].echo-secondaryColor { color: #C6C6C6 }"+".{plugin.class:compactContent} input.{plugin.class:compactField}[type\x3d'text'].echo-primaryFont { font-size: 12px; line-height: 16px; }"+
".{plugin.class:compactContent} input.{plugin.class:compactField}[type\x3d'text'] { width: 100%; height: 16px; border: none; margin: 0px; padding: 0px; box-shadow: none; vertical-align: middle; }"+".{plugin.class:compactContent} input.{plugin.class:compactField}[type\x3d'text']:focus { outline: 0; box-shadow: none; }";Echo.Plugin.create(plugin)})(Echo.jQuery);
(function(jQuery){var plugin=Echo.Plugin.manifest("Reply","Echo.StreamServer.Controls.Stream");if(Echo.Plugin.isDefined(plugin))return;plugin.events={"Echo.StreamServer.Controls.Stream.Item.Plugins.Reply.onExpand":function(topic,args){this.events.publish({"topic":"onFormExpand","data":{"context":args.context}})}};Echo.Plugin.create(plugin)})(Echo.jQuery);
(function(jQuery){var $=jQuery;var plugin=Echo.Plugin.manifest("Reply","Echo.StreamServer.Controls.Submit");if(Echo.Plugin.isDefined(plugin))return;plugin.init=function(){var plugin=this,submit=plugin.component;var _prepareEventParams=submit._prepareEventParams;submit._prepareEventParams=function(params){var _params=_prepareEventParams.call(submit,params);_params.inReplyTo=plugin.config.get("inReplyTo");return _params}};$.map(["onRender","onRerender"],function(topic){plugin.events["Echo.StreamServer.Controls.Submit."+
topic]=function(){var submit=this.component;submit.config.get("target").show();submit.view.get("text").focus()}});Echo.Plugin.create(plugin)})(Echo.jQuery);
(function(jQuery){var plugin=Echo.Plugin.manifest("TextCounter","Echo.StreamServer.Controls.Submit");if(Echo.Plugin.isDefined(plugin))return;plugin.init=function(){this.extendTemplate("insertAfter","content",plugin.templates.counter)};plugin.events={"Echo.StreamServer.Controls.Submit.onPostComplete":function(topic,args){this.view.render({"name":"counterLabel"})}};plugin.labels={"limited":"{typed}/{left} characters","unlimited":"{typed} characters"};plugin.templates.counter='\x3cdiv class\x3d"{plugin.class:counterLabel} echo-primaryFont echo-primaryColor"\x3e\x3c/div\x3e';
plugin.component.renderers.text=function(element){var plugin=this;plugin.parentRenderer("text",arguments);var limit=plugin.config.get("limit",0);var handler=function(){if(limit){var text=element.val();if(text.length<=limit)plugin.set("text",text);else if(text.length>limit){element.val(plugin.get("text"));return}}plugin.view.render({"name":"counterLabel"})};return element.on("blur focus keyup keypress",handler)};plugin.renderers.counterLabel=function(element){var plugin=this,submit=this.component;
var limit=plugin.config.get("limit",0);var typed=submit.view.get("text").val().length;var label=plugin.labels.get(plugin.config.get("label",limit?"limited":"unlimited"),{"typed":typed,"left":Math.max(limit-typed,0),"limit":limit});return element.text(label)};Echo.Plugin.create(plugin)})(Echo.jQuery);
(function(jQuery){var $=jQuery;var plugin=Echo.Plugin.manifest("TweetDisplay","Echo.StreamServer.Controls.Stream.Item");if(Echo.Plugin.isDefined(plugin))return;plugin.init=function(){var item=this.component;var config=item.config.get("contentTransformations");$.map(["text","html","xhtml"],function(contentType){config[contentType].hashtags=false});item.config.set("contentTransformations",config);item.config.set("plugins.Like.enabled",false);item.config.set("plugins.Reply.enabled",false);item.config.set("viaLabel.icon",
true);this.extendTemplate("insertBefore","authorName",plugin.templates.date);this.extendTemplate("insertAfter","authorName",plugin.templates.username);item.addButtonSpec(this.name,this._assembleButton("tweet"));item.addButtonSpec(this.name,this._assembleButton("retweet"));item.addButtonSpec(this.name,this._assembleButton("favorite"))};plugin.labels={"tweet":"Reply","retweet":"Retweet","favorite":"Favorite","comment":"Comment","secondsAgo":"{seconds}s","minutesAgo":"{minutes}m","hoursAgo":"{hours}h",
"monthsAgo":"{day} {month}","yearsAgo":"{day} {month} {year}","fullDate":"{time} - {date}","month1":"Jan","month2":"Feb","month3":"Mar","month4":"Apr","month5":"May","month6":"Jun","month7":"Jul","month8":"Aug","month9":"Sep","month10":"Oct","month11":"Nov","month12":"Dec"};plugin.dependencies=[{"loaded":function(){return!!window.twttr},"url":"//platform.twitter.com/widgets.js"}];plugin.enabled=function(){return this._isTweet()};plugin.events={"Echo.StreamServer.Controls.Stream.Item.onRender":function(topic,
args){var activeClass=this.cssPrefix+"activeButton";var item=this.component;$.map(item.buttons[this.name],function(name){name.element.unbind("click").unbind("mouseover mouseout").hover(function(){name.element.addClass(activeClass)},function(){name.element.removeClass(activeClass)})});window.twttr&&window.twttr.widgets&&window.twttr.widgets.load()}};plugin.templates={"username":'\x3cdiv class\x3d"{plugin.class:tweetUserName}"\x3e\x3c/div\x3e',"date":'\x3cdiv class\x3d"{plugin.class:tweetDate} echo-secondaryFont"\x3e\x3c/div\x3e'};
plugin.component.renderers.authorName=function(element){var item=this.component;return item.parentRenderer("authorName",arguments).removeClass("echo-linkColor").addClass(this.cssPrefix+"tweetScreenName").wrapInner(Echo.Utils.hyperlink({"href":item.get("data.actor.id")},{"openInNewWindow":item.config.get("openLinksInNewWindow"),"skipEscaping":true}))};plugin.component.renderers.avatar=function(element){var item=this.component;return item.parentRenderer("avatar",arguments).wrap(Echo.Utils.hyperlink({"href":item.get("data.actor.id")},
{"openInNewWindow":item.config.get("openLinksInNewWindow"),"skipEscaping":true}))};plugin.component.renderers.date=function(element){var item=this.component;this.view.render({"name":"tweetDate"});return item.parentRenderer("date",arguments)};plugin.component.renderers._buttonsDelimiter=function(element){var item=this.component;var posDelimiter=item.buttonSpecs[this.name].length;return item.parentRenderer("_buttonsDelimiter",arguments).find("span[class*\x3d'button-delim']").eq(posDelimiter).text(" | ")};
plugin.renderers.tweetUserName=function(element){var item=this.component;return element.html(Echo.Utils.hyperlink({"href":item.get("data.actor.id"),"caption":"@"+this._extractTwitterID(),"class":"echo-secondaryFont echo-secondaryColor"},{"openInNewWindow":item.config.get("openLinksInNewWindow"),"skipEscaping":true}))};plugin.renderers.tweetDate=function(element){var item=this.component;return element.html(Echo.Utils.hyperlink({"caption":this._getTweetTime(),"href":item.get("data.object.id"),"class":"echo-secondaryFont echo-secondaryColor",
"title":this._getTweetTime(true)},{"openInNewWindow":item.config.get("openLinksInNewWindow"),"skipEscaping":true}))};plugin.methods._assembleButton=function(name){var plugin=this,item=this.component;var match=item.get("data.object.id").match(/\/(\d+)$/);var id=match&&match[1];return function(){return{"name":name,"label":plugin.labels.get(name),"template":Echo.Utils.hyperlink({"href":"https://twitter.com/intent/"+name+"?in_reply_to\x3d"+id+"\x26tweet_id\x3d"+id,"class":"echo-clickable "+plugin.cssPrefix+
"intentControl echo-secondaryColor","caption":'\x3cspan class\x3d"'+plugin.cssPrefix+"icon "+plugin.cssPrefix+'icon-{data:name}"\x3e\x26nbsp;\x3c/span\x3e'+"\x3cspan\x3e{data:label}\x3c/span\x3e"},{"openInNewWindow":item.config.get("openLinksInNewWindow"),"skipEscaping":true}),"visible":id&&plugin._isTweet()}}};plugin.methods._isTweet=function(){var item=this.component;return item.get("data.source.name")==="Twitter"};plugin.methods._getTweetTime=function(getFull){var item=this.component;var d=new Date(item.timestamp*
1E3);var now=(new Date).getTime();var diff=Math.floor((now-d.getTime())/1E3);var result;if(getFull)result=this.labels.get("fullDate",{"time":d.toLocaleTimeString(),"date":d.toLocaleDateString()});else if(diff<60)result=this.labels.get("secondsAgo",{"seconds":diff});else if(diff<60*60)result=this.labels.get("minutesAgo",{"minutes":Math.floor(diff/60)});else if(diff<60*60*24)result=this.labels.get("hoursAgo",{"hours":Math.floor(diff/(60*60))});else if(diff<60*60*24*365)result=this.labels.get("monthsAgo",
{"day":d.getDate(),"month":this.labels.get("month"+(d.getMonth()+1))});else result=this.labels.get("yearsAgo",{"day":d.getDate(),"month":this.labels.get("month"+(d.getMonth()+1)),"year":d.getFullYear()});return result};plugin.methods._extractTwitterID=function(){var item=this.component;var match=item.get("data.actor.id").match(/twitter.com\/(.*)/);return match?match[1]:item.get("data.actor.id")};plugin.css=".{plugin.class} .{class:avatar} a img { border: 0px; }"+".{plugin.class} .{class:date} { display: none; }"+
".{plugin.class} .{class:buttons} .{class:button-delim}:first-child { display: none; }"+".{plugin.class} .{class:data} a { text-decoration: none; }"+".{plugin.class} .{class:data} a:hover { text-decoration: underline; }"+".{plugin.class} .{class:footer} { padding-top: 5px; }"+".{plugin.class} .{class:modeSwitch} { margin-left: 6px; }"+".{plugin.class:userName} { float: left; font-size: 15px; font-weight: bold; }"+".{plugin.css:screenName} { margin-left: 4px; font-size: 11px; font-weight: normal; padding-top: 1px; }"+
".{plugin.class:userName} a, .{plugin.class:tweetUserName} a, .{plugin.class:intentControl} { text-decoration: none; }"+".{plugin.class:icon} { width: 15px; height: 15px; display: inline-block; margin-right: 3px; background: url(https://si0.twimg.com/images/dev/cms/intents/icons/sprites/everything-spritev2.png) no-repeat; }"+".{plugin.class:icon-tweet} { background-position: 0px -2px; }"+".{plugin.class:icon-retweet} { background-position: -80px -2px; }"+".{plugin.class:icon-favorite} { background-position: -32px -2px; }"+
".{plugin.class:activeButton} .{plugin.class:icon-tweet} { background-position: -16px -2px; }"+".{plugin.class:activeButton} .{plugin.class:icon-retweet} { background-position: -96px -2px; }"+".{plugin.class:activeButton} .{plugin.class:icon-favorite} { background-position: -48px -2px; }"+".{plugin.class:tweetUserName} { margin-left: 4px; font-size: 15px; float: left; }"+".{plugin.class:twitterIcon} { float: left; margin-right: 3px; }"+".{plugin.class:date} { text-decoration: none; color: #C6C6C6; }"+
".{plugin.class:tweetScreenName} a { text-decoration: none; color: #333333; }"+".{plugin.class:tweetDate} a { text-decoration: none; }"+".{plugin.class:tweetDate} a:hover { text-decoration: underline;  }"+".{plugin.class:tweetDate} { float: right; }";Echo.Plugin.create(plugin)})(Echo.jQuery);